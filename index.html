<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.sheetjs.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://www.gstatic.com https://*.firebaseio.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com https://*.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://api.open-meteo.com https://www.oref.org.il; img-src 'self' data:; font-src 'self' data: https://fonts.gstatic.com; frame-ancestors 'none'; object-src 'none'; base-uri 'self';">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#2563EB" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Marjin" />
  <title>Marjin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body, #root { margin: 0; padding: 0; width: 100%; min-height: 100vh; font-family: 'Heebo', sans-serif; background: #F1F5F9; }
    input, button, select, textarea { font-family: 'Heebo', sans-serif; }
    ::-webkit-scrollbar { display: none; }
    * { scrollbar-width: none; }
    @keyframes pulse {
    0%,100%{opacity:1} 50%{opacity:0.7}
  }
</style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
  <script type="module">
    import { initializeApp }                        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, remove, onValue, forceWebSockets } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
             sendPasswordResetEmail, onAuthStateChanged, signOut }
             from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";

    // â”€â”€ Config loaded from server (keeps keys out of static HTML) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let firebaseConfig;
    try {
      const res = await fetch("/api/config");
      if (!res.ok) throw new Error("config fetch failed");
      firebaseConfig = await res.json();
      if (firebaseConfig.error) throw new Error(firebaseConfig.error);
    } catch(e) {
      console.error("[firebase-init] could not load config:", e.message);
      document.getElementById("root").innerHTML =
        "<div style='padding:40px;text-align:center;color:#EF4444;font-family:sans-serif'>" +
        "âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×’×“×¨×•×ª ×”××¤×œ×™×§×¦×™×”. ×¨×¢× ×Ÿ ××ª ×”×“×£.</div>";
      throw e; // stop execution
    }

    const app  = initializeApp(firebaseConfig);
    forceWebSockets(); // Use WebSocket only â€” prevents CSP violations from long-polling <script> injection
    const db   = getDatabase(app);
    const auth = getAuth(app);

    // â”€â”€ App Check (reCAPTCHA v3) â€” enforced on RTDB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Set RECAPTCHA_SITE_KEY in Vercel env. In dev, set self.FIREBASE_APPCHECK_DEBUG_TOKEN=true in console.
    const recaptchaKey = firebaseConfig.recaptchaSiteKey;
    if (recaptchaKey) {
      try {
        initializeAppCheck(app, {
          provider: new ReCaptchaV3Provider(recaptchaKey),
          isTokenAutoRefreshEnabled: true,
        });
      } catch(e) { console.warn("[app-check] init failed:", e.message); }
    } else {
      console.warn("[app-check] RECAPTCHA_SITE_KEY missing â€” App Check disabled");
    }

    // â”€â”€ Auth: Email/Password â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _uid  = null;
    let _user = null;

    // Returns a fresh ID token for API Authorization headers
    window.getIdToken = async (forceRefresh=false) => {
      if (!_user) throw new Error("not authenticated");
      return _user.getIdToken(forceRefresh);
    };

    // Sign in with email + password
    window.firebaseSignIn = async (email, password) => {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      _uid  = cred.user.uid;
      _user = cred.user;
      return cred.user;
    };

    // Create a new Firebase Auth user (uses secondary app to avoid signing out current user)
    window.firebaseCreateUser = async (email, password) => {
      const secondaryApp  = initializeApp2(firebaseConfig, `secondary_${Date.now()}`);
      const secondaryAuth = getAuth(secondaryApp);
      const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
      const uid  = cred.user.uid;
      await signOut(secondaryAuth);
      return uid;
    };

    // Send password reset email
    window.firebaseSendReset = async (email) => {
      await sendPasswordResetEmail(auth, email);
    };

    // Sign out
    window.firebaseSignOut = async () => {
      await signOut(auth);
      _uid  = null;
      _user = null;
    };

    // Wait for auth state to settle (user may already be signed in from previous session)
    const authReady = new Promise(resolve => {
      onAuthStateChanged(auth, user => {
        if (user) { _uid = user.uid; _user = user; }
        resolve(user); // resolve with user or null â€” app decides what to do
      });
    });
    await authReady;

    // Firebase converts arrays to objects â€” so we store as {v: jsonString}
    // All operational data lives under /tenants/{bizId}/ scoped by RTDB RBAC
    // _currentTenantId is set by the app when a business is selected
    let _currentTenantId = null;
    window.setTenantId = id => { _currentTenantId = id; };

    const fkey = k => {
      if (!_currentTenantId) throw new Error("tenant not set");
      return "tenants/" + _currentTenantId + "/" + k.replace(/[.#$\[\]]/g, "_");
    };
    // System data now lives under tenants/{tenantId}/app/
    // Requires tenantId to be set first via window.setTenantId
    const fkeyShared = k => {
      const safe = k.replace(/[.#$\[\]]/g, "_");
      if (safe === "app-users")      return _currentTenantId ? `tenants/${_currentTenantId}/app/users`    : null;
      if (safe === "app-businesses") return _currentTenantId ? `tenants/${_currentTenantId}/app/business` : null;
      return safe; // fallback (shouldn't be reached)
    };
    window.storage = {
      get: async (key, shared=false) => {
        const path = shared ? fkeyShared(key) : fkey(key);
        if (!path) throw new Error("tenant not set for shared key: " + key);
        const snap = await get(ref(db, path));
        if (!snap.exists()) throw new Error("not found");
        const raw = snap.val();
        const value = (raw && typeof raw === "object" && "_v" in raw) ? raw._v : JSON.stringify(raw);
        return { key, value, shared };
      },
      set: async (key, value, shared=false) => {
        const str = typeof value === "string" ? value : JSON.stringify(value);
        const path = shared ? fkeyShared(key) : fkey(key);
        if (!path) throw new Error("tenant not set for shared key: " + key);
        await set(ref(db, path), { _v: str });
        return { key, value: str, shared };
      },
      delete: async (key, shared=false) => {
        const path = shared ? fkeyShared(key) : fkey(key);
        await remove(ref(db, path));
        return { key, deleted: true };
      },
      list: async (prefix) => {
        const snap = await get(ref(db, "marjin"));
        if (!snap.exists()) return { keys: [] };
        const pfx = (prefix || "").replace(/[.#$\[\]]/g, "_");
        const keys = Object.keys(snap.val()).filter(k => k.startsWith(pfx));
        return { keys };
      },
    };

    // Live listener â€” calls callback whenever any key changes
    window.storage.subscribe = (key, callback, shared=false) => {
      const path = shared ? fkeyShared(key) : fkey(key);
      if (!path) return () => {}; // no-op unsubscribe if tenant not set
      const r = ref(db, path);
      return onValue(r, (snap) => {
        if (snap.exists()) {
          const raw = snap.val();
          const value = (raw && typeof raw === "object" && "_v" in raw) ? raw._v : JSON.stringify(raw);
          callback({ key, value });
        }
      });
    };
    // Expose uid for app use
    window.storage.getUid = () => _uid;

    // â”€â”€ Authenticated fetch for Edge Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.apiFetch = async (path, options={}) => {
      const token = await window.getIdToken();
      const headers = {
        "Authorization": `Bearer ${token}`,
        "Content-Type":  "application/json",
        ...(options.headers || {}),
      };
      return fetch(path, { ...options, headers });
    };

    // Raw RTDB get (without storage wrapper) â€” used for pre-auth lookups
    window._rtdbGet = async (path) => {
      const snap = await get(ref(db, path));
      return snap.exists() ? snap.val() : null;
    };
    // Raw RTDB set â€” used for lookup table writes
    window._rtdbSet = async (path, val) => {
      await set(ref(db, path), val);
    };

    window._firebaseReady = true;
    window.dispatchEvent(new Event("firebase-ready"));
  </script>
  <script type="text/babel" data-presets="react">

// storage handled by Firebase above

const { useState, useEffect, useRef } = React;
const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar } = Recharts;

// XLSX loaded via CDN in index.html â€” available as window.XLSX

// â”€â”€â”€ Password helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const hashPassword = async (plain) => {
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(plain));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
};
const isHashed = (pw) => typeof pw === "string" && /^[0-9a-f]{64}$/.test(pw);

// â”€â”€â”€ Config helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cfgTarget = (cfg, key, fallback) => cfg?.targets?.[key] ?? fallback;

// â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TODAY = new Date();
const YEAR = TODAY.getFullYear();
const MONTH = TODAY.getMonth();
const DAYS_IN_MONTH = new Date(YEAR, MONTH + 1, 0).getDate();
const DAY_OF_MONTH = TODAY.getDate();
const MONTH_STR = String(MONTH + 1).padStart(2, "0");
const TODAY_STR = `${YEAR}-${MONTH_STR}-${String(DAY_OF_MONTH).padStart(2, "0")}`;
const YESTERDAY = new Date(TODAY); YESTERDAY.setDate(TODAY.getDate() - 1);
const YESTERDAY_STR = `${YESTERDAY.getFullYear()}-${String(YESTERDAY.getMonth()+1).padStart(2,"0")}-${String(YESTERDAY.getDate()).padStart(2,"0")}`;
const TODAY_DOW = TODAY.getDay(); // 0=×¨××©×•×Ÿ ... 6=×©×‘×ª

const RENT_PCT = 6.8;
const ROYALTY_PCT = 13;

const MONTH_NAMES = ["×™× ×•××¨","×¤×‘×¨×•××¨","××¨×¥","××¤×¨×™×œ","×××™","×™×•× ×™","×™×•×œ×™","××•×’×•×¡×˜","×¡×¤×˜××‘×¨","××•×§×˜×•×‘×¨","× ×•×‘××‘×¨","×“×¦××‘×¨"];
// â”€â”€â”€ × ×ª×•× ×™ ×©× ×” ×§×•×“××ª (×‘×¨×™×¨×ª ××—×“×œ â€” × ×˜×¢× ×™× ×-Excel ×× ×™×©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LAST_YEAR_2025 = [
  { month:0,  sales:694847, foodCostPct:33.2, laborCostPct:30.0, networkPct:13.2, fixedExpenses:114970, financePct:3.1, grossProfitPct:3.9,   profitPct:3.9  }, // ×™× ×•××¨
  { month:1,  sales:632000, foodCostPct:34.0, laborCostPct:29.0, networkPct:13.1, fixedExpenses:102500, financePct:3.5, grossProfitPct:4.1,   profitPct:4.1  }, // ×¤×‘×¨×•××¨
  { month:2,  sales:664562, foodCostPct:32.6, laborCostPct:28.0, networkPct:13.1, fixedExpenses:106503, financePct:2.9, grossProfitPct:7.4,   profitPct:7.4  }, // ××¨×¥
  { month:3,  sales:637403, foodCostPct:37.3, laborCostPct:29.4, networkPct:13.2, fixedExpenses:95959,  financePct:3.0, grossProfitPct:2.2,   profitPct:2.2  }, // ××¤×¨×™×œ
  { month:4,  sales:651698, foodCostPct:34.2, laborCostPct:26.5, networkPct:13.2, fixedExpenses:100047, financePct:4.4, grossProfitPct:6.3,   profitPct:6.3  }, // ×××™
  { month:5,  sales:550300, foodCostPct:34.6, laborCostPct:30.8, networkPct:12.2, fixedExpenses:104516, financePct:4.2, grossProfitPct:-0.8,  profitPct:-0.8 }, // ×™×•× ×™
  { month:6,  sales:681465, foodCostPct:37.2, laborCostPct:33.5, networkPct:13.2, fixedExpenses:131868, financePct:4.4, grossProfitPct:-7.6,  profitPct:-7.6 }, // ×™×•×œ×™
  { month:7,  sales:719614, foodCostPct:33.0, laborCostPct:30.7, networkPct:13.0, fixedExpenses:114584, financePct:3.7, grossProfitPct:3.6,   profitPct:3.6  }, // ××•×’×•×¡×˜
  { month:8,  sales:627903, foodCostPct:39.3, laborCostPct:37.1, networkPct:13.1, fixedExpenses:116407, financePct:3.3, grossProfitPct:-11.4, profitPct:-11.4}, // ×¡×¤×˜××‘×¨
  { month:9,  sales:667742, foodCostPct:32.3, laborCostPct:33.3, networkPct:13.2, fixedExpenses:104122, financePct:4.1, grossProfitPct:1.6,   profitPct:1.6  }, // ××•×§×˜×•×‘×¨
  { month:10, sales:663133, foodCostPct:33.2, laborCostPct:30.7, networkPct:13.1, fixedExpenses:107161, financePct:4.2, grossProfitPct:2.5,   profitPct:2.5  }, // × ×•×‘××‘×¨
  { month:11, sales:683358, foodCostPct:33.5, laborCostPct:29.4, networkPct:13.2, fixedExpenses:104946, financePct:4.3, grossProfitPct:4.2,   profitPct:4.2  }, // ×“×¦××‘×¨
];



const DOW_NAMES = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];

const FIXED_EXPENSES_DEFAULT = [
  { id: 1,  name: "×”×•×¦××•×ª ××™××•×Ÿ",             amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 2,  name: "×©×›×¨ ×“×™×¨×” (6.8% ×××—×–×•×¨)",  amount: 0, dueDay: 1,  rentPct: true,  royaltyPct: false },
  { id: 18, name: "×ª××œ×•×’×™× ×œ×¨×©×ª (13% ×××—×–×•×¨)", amount: 0, dueDay: 1,  rentPct: false, royaltyPct: true  },
  { id: 3,  name: "×“××™ × ×™×”×•×œ",               amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 4,  name: "×—×©××œ",                    amount: 0, dueDay: 10, rentPct: false, royaltyPct: false },
  { id: 5,  name: "××™×",                     amount: 0, dueDay: 10, rentPct: false, royaltyPct: false },
  { id: 6,  name: "××¨× ×•× ×”",                  amount: 0, dueDay: 5,  rentPct: false, royaltyPct: false },
  { id: 7,  name: "×‘×™×˜×•×— ×¢×¡×§×™",              amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 8,  name: "×ª×™×§×•× ×™×",                 amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 9,  name: "××™× ×˜×¨× ×˜",                 amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 10, name: "×”× ×”×œ×ª ×—×©×‘×•× ×•×ª",           amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 11, name: "×¨×•××” ×—×©×‘×•×Ÿ",              amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 12, name: "××•×¡×™×§×”",                  amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 13, name: "×“××™ ×ª×¤×¢×•×œ",               amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 14, name: "××©×¤×˜×™×•×ª",                 amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 15, name: "×§× ×™×•×ª ×›×œ×™×",              amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 16, name: "×˜×œ×¤×•×Ÿ ×¡×œ×•×œ×¨×™",            amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
  { id: 17, name: "×”×•×¦××•×ª ×¨×›×‘",              amount: 0, dueDay: 1,  rentPct: false, royaltyPct: false },
];

// â”€â”€â”€ ×™×¢×“×™× ×¢×¡×§×™×™× 2026 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ ×‘×¨×™×¨×•×ª ××—×“×œ â€” ×™×•×—×œ×¤×• ×¢"×™ businessConfig ×œ××—×¨ ××©×£ ×”×’×“×¨×•×ª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TARGETS = {
  salesGrowthPct: 5,
  foodCostPct:    33,
  laborCostPct:   27,
};
const EMPTY_ENTRY = {
  date: YESTERDAY_STR, sales: "", deliveries: "", other_income: "",
  supplier_payments: {}, payroll: "", hourly_payroll: {}, other_expense: "", notes: "", security_event: false, weather_impact: "",
  includeVat: false,
};
const VAT_RATE = 1.18;
const vatNet = (v, includeVat) => includeVat ? Math.round(Number(v) / VAT_RATE) : Number(v);

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = n => new Intl.NumberFormat("he-IL", { style:"currency", currency:"ILS", maximumFractionDigits:0 }).format(n||0);
const VAT = 1.18;
const exVAT = n => Math.round(n / VAT);
const fmtPct = n => `${Number(n).toFixed(1)}%`;
const getDateDOW = dateStr => { const [y,m,d]=dateStr.split("-").map(Number); return new Date(y,m-1,d).getDay(); };
const suppliersOnDay = (dow, sups=[]) => sups.filter(s => s.days.includes(dow));
const fcColor = (v, t) => v > t+3 ? "#EF4444" : v > t ? "#F59E0B" : "#22C55E";

function calcMetrics(entries, fixedList, cfg={}) {
  const rentPct    = cfg.rentPct    ?? RENT_PCT;
  const royaltyPct = cfg.royaltyPct ?? ROYALTY_PCT;
  const totalSales = entries.reduce((a,e)=>a+(Number(e.sales)||0)+(Number(e.deliveries)||0)+(Number(e.other_income)||0),0);
  const totalPayroll = entries.reduce((a,e)=>{
    const globalPay = Number(e.payroll)||0;
    const hourlyPay = e.hourly_payroll ? Object.values(e.hourly_payroll).reduce((s,v)=>s+(Number(v)||0),0) : 0;
    return a + globalPay + hourlyPay;
  },0);
  const totalOtherExpense = entries.reduce((a,e)=>a+(Number(e.other_expense)||0),0);
  const supplierTotals = {};
  (cfg.suppliers||[]).forEach(s => { supplierTotals[s.id]=0; });
  entries.forEach(e => {
    if (e.supplier_payments) Object.entries(e.supplier_payments).forEach(([sid,amt])=>{
      supplierTotals[sid]=(supplierTotals[sid]||0)+Math.round(Number(amt)||0);
    });
  });
  const totalFood = Object.values(supplierTotals).reduce((a,b)=>a+b,0);
  const resolvedFixed = fixedList.map(f => {
    if (f.rentPct) {
      if(cfg.rentType==="fixed") return {...f, amount: cfg.rentFixed||0};
      return {...f, amount: Math.round(totalSales * rentPct / 100)};
    }
    if (f.royaltyPct) return {...f, amount: Math.round(totalSales * royaltyPct / 100)};
    return f;
  });
  const TOTAL_FIXED = resolvedFixed.reduce((a,b)=>a+b.amount,0);
  const fixedSoFar = resolvedFixed.filter(f=>f.dueDay<=DAY_OF_MONTH).reduce((a,b)=>a+b.amount,0);
  const totalExpenses = totalFood+totalPayroll+totalOtherExpense+fixedSoFar;
  const lc = totalSales-totalExpenses;
  const fc = totalSales-totalFood-totalPayroll-totalOtherExpense-TOTAL_FIXED;
  const foodCostPct = totalSales>0?(totalFood/totalSales)*100:0;
  const financingPct = cfg.financingPct ?? 0.132; // 60% Ã— 22%
  const totalFinancing = Math.round(totalSales * financingPct);
  const lcAfterFinancing = lc - totalFinancing;
  const fcAfterFinancing = fc - totalFinancing;
  const dailyAvg = DAY_OF_MONTH>0?lcAfterFinancing/DAY_OF_MONTH:0;
  const forecast = lcAfterFinancing+(dailyAvg*(DAYS_IN_MONTH-DAY_OF_MONTH))-(TOTAL_FIXED-fixedSoFar);
  return { totalSales, totalPayroll, totalOtherExpense, totalFood, fixedSoFar, totalExpenses, lc:lcAfterFinancing, fc:fcAfterFinancing, foodCostPct, forecast, dailyAvg, resolvedFixed, TOTAL_FIXED, supplierTotals, totalFinancing, lcBeforeFinancing:lc };
}

function buildChart(entries) {
  const byDay={};
  entries.forEach(e=>{
    const d=parseInt(e.date.split("-")[2]);
    if(!byDay[d]) byDay[d]={income:0,expense:0};
    byDay[d].income+=(Number(e.sales)||0)+(Number(e.deliveries)||0)+(Number(e.other_income)||0);
    const s=e.supplier_payments?Object.values(e.supplier_payments).reduce((a,b)=>a+Math.round(Number(b)||0),0):0;
    byDay[d].expense+=s+(Number(e.payroll)||0)+(Number(e.other_expense)||0);
  });
  let running=0;
  return Array.from({length:DAY_OF_MONTH},(_,i)=>{
    const d=i+1;
    running+=(byDay[d]?.income||0)-(byDay[d]?.expense||0);
    return {day:d, ×”×›× ×¡×•×ª:byDay[d]?.income||0, ×”×•×¦××•×ª:byDay[d]?.expense||0, ×™×ª×¨×”:running};
  });
}


// â”€â”€â”€ Login Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ROLES = {
  super_owner: { label:"×‘×¢×œ×™× ×¨××©×™",  color:"#7C3AED", bg:"#F5F3FF" },
  owner:       { label:"×‘×¢×œ×™×",        color:"#2563EB", bg:"#EFF6FF" },
  manager:     { label:"×× ×”×œ ××¡×¢×“×”",  color:"#0891B2", bg:"#ECFEFF" },
  staff:       { label:"××—××©",         color:"#6B7280", bg:"#F9FAFB" },
};



function LoginScreen({ onLogin, tenantId }) {
  const [username,    setUsername]    = useState("");
  const [password,    setPassword]    = useState("");
  const [err,         setErr]         = useState("");
  const [loading,     setLoading]     = useState(false);
  const [showPass,    setShowPass]    = useState(false);
  const [resetMode,   setResetMode]   = useState(false);
  const [resetEmail,  setResetEmail]  = useState("");
  const [resetSent,   setResetSent]   = useState(false);

  const tryLogin = async () => {
    if(!username.trim() || !password.trim()) { setErr("×™×© ×œ××œ× ×©× ××©×ª××© ×•×¡×™×¡××”"); return; }
    setLoading(true); setErr("");
    try {
      // 1. Look up email by username in public lookup table
      const snap = await window._rtdbGet(`tenants/${tenantId}/lookup/${username.trim().toLowerCase()}`);
      if(!snap) { setErr("×©× ××©×ª××© ×œ× × ××¦×"); setLoading(false); return; }
      const email = snap.email;
      // 2. Sign in with Firebase Auth
      await window.firebaseSignIn(email, password);
      // 3. Load user profile from RTDB
      const userSnap = await window._rtdbGet(`tenants/${tenantId}/app/users`);
      const users = userSnap ? JSON.parse(userSnap._v || "[]") : [];
      const u = users.find(u => u.username.toLowerCase() === username.trim().toLowerCase());
      if(!u) { setErr("××©×ª××© ×œ× × ××¦× ×‘-RTDB"); setLoading(false); return; }
      setErr(""); onLogin(u);
    } catch(e) {
      const msg = e.code === "auth/wrong-password" || e.code === "auth/invalid-credential"
        ? "×¡×™×¡××” ×©×’×•×™×”" : e.code === "auth/too-many-requests"
        ? "×™×•×ª×¨ ××“×™ × ×™×¡×™×•× ×•×ª â€” × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨" : e.message || "×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª";
      setErr(msg);
    }
    setLoading(false);
  };

  const trySendReset = async () => {
    if(!resetEmail.trim()) { setErr("×™×© ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ××™×™×œ"); return; }
    setLoading(true); setErr("");
    try {
      await window.firebaseSendReset(resetEmail.trim());
      setResetSent(true);
    } catch(e) {
      setErr(e.code === "auth/user-not-found" ? "××™×™×œ ×œ× × ××¦× ×‘××¢×¨×›×ª" : "×©×’×™××” ×‘×©×œ×™×—×ª ×”××™×™×œ");
    }
    setLoading(false);
  };

  const L = {
    root:{minHeight:"100vh",background:"#F1F5F9",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"24px",fontFamily:"inherit",direction:"rtl"},
    box:{background:"#FFFFFF",borderRadius:20,padding:"32px 28px",width:"100%",maxWidth:380,boxShadow:"0 4px 24px #0000001A",border:"1px solid #E5E7EB"},
    logo:{textAlign:"center",marginBottom:28},
    logoIcon:{fontSize:48,marginBottom:8},
    logoTitle:{fontSize:22,fontWeight:900,color:"#111827",margin:0},
    logoSub:{fontSize:13,color:"#9CA3AF",marginTop:4},
    lbl:{fontSize:13,color:"#6B7280",marginBottom:6,display:"block",fontWeight:600},
    inp:{width:"100%",border:"1px solid #D1D5DB",borderRadius:10,padding:"13px 14px",color:"#111827",fontSize:15,fontFamily:"inherit",outline:"none",boxSizing:"border-box",marginBottom:14,background:"#FFFFFF"},
    inpFocus:{borderColor:"#2563EB"},
    passWrap:{position:"relative",marginBottom:14},
    passInp:{width:"100%",border:"1px solid #D1D5DB",borderRadius:10,padding:"13px 40px 13px 14px",color:"#111827",fontSize:15,fontFamily:"inherit",outline:"none",boxSizing:"border-box",background:"#FFFFFF"},
    eyeBtn:{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",color:"#9CA3AF",fontSize:18,padding:4},
    btn:{width:"100%",padding:"15px",background:"#2563EB",border:"none",borderRadius:12,color:"#FFFFFF",fontWeight:800,fontSize:16,cursor:"pointer",fontFamily:"inherit",letterSpacing:0.2},
    err:{color:"#EF4444",fontSize:13,textAlign:"center",marginBottom:12,fontWeight:600},
    foot:{textAlign:"center",marginTop:20,fontSize:12,color:"#9CA3AF"},
  };

  return (
    <div style={L.root}>
      <div style={L.box}>
        <div style={L.logo}>
          <div style={L.logoIcon}>ğŸ“Š</div>
          <h1 style={L.logoTitle}>×œ×•×— ×‘×§×¨×”</h1>
          <p style={L.logoSub}>××¢×¨×›×ª × ×™×”×•×œ ××¡×¢×“×•×ª</p>
        </div>
        <label style={L.lbl}>×©× ××©×ª××©</label>
        <input style={L.inp} placeholder="username" value={username}
          onChange={e=>{setUsername(e.target.value);setErr(false);}}
          onKeyDown={e=>e.key==="Enter"&&tryLogin()}
          autoCapitalize="none" autoCorrect="off"/>
        <label style={L.lbl}>×¡×™×¡××”</label>
        <div style={L.passWrap}>
          <input style={L.passInp} type={showPass?"text":"password"} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"
            value={password} onChange={e=>{setPassword(e.target.value);setErr(false);}}
            onKeyDown={e=>e.key==="Enter"&&tryLogin()}/>
          <button style={L.eyeBtn} onClick={()=>setShowPass(p=>!p)}>{showPass?"ğŸ™ˆ":"ğŸ‘"}</button>
        </div>
        {err && <div style={L.err}>{err}</div>}
        <button style={{...L.btn, opacity:loading?0.6:1}} onClick={loading?null:tryLogin} disabled={loading}>
          {loading ? "××ª×—×‘×¨..." : "×›× ×™×¡×”"}
        </button>
        <div style={{textAlign:"center",marginTop:14}}>
          <button onClick={()=>{setResetMode(true);setErr("");}}
            style={{background:"none",border:"none",color:"#2563EB",fontSize:13,cursor:"pointer",fontFamily:"inherit",textDecoration:"underline"}}>
            ×©×›×—×ª×™ ×¡×™×¡××”
          </button>
        </div>
      </div>
      {/* â”€â”€ Forgot password modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {resetMode && (
        <div style={{position:"fixed",inset:0,background:"#0006",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999}}>
          <div style={{background:"#fff",borderRadius:16,padding:"28px 24px",width:"100%",maxWidth:360,boxShadow:"0 8px 32px #0003",direction:"rtl"}}>
            {resetSent ? (
              <>
                <div style={{fontSize:36,textAlign:"center",marginBottom:12}}>âœ‰ï¸</div>
                <h3 style={{margin:"0 0 8px",textAlign:"center",fontWeight:800}}>× ×©×œ×—!</h3>
                <p style={{color:"#6B7280",textAlign:"center",fontSize:14}}>×‘×“×•×§ ××ª ×ª×™×‘×ª ×”×“×•××¨ ×©×œ×š ×•×œ×—×¥ ×¢×œ ×”×§×™×©×•×¨ ×œ××™×¤×•×¡ ×”×¡×™×¡××”.</p>
                <button onClick={()=>{setResetMode(false);setResetSent(false);setResetEmail("");}}
                  style={{width:"100%",padding:"13px",background:"#2563EB",border:"none",borderRadius:10,color:"#fff",fontWeight:700,fontSize:15,cursor:"pointer",marginTop:16,fontFamily:"inherit"}}>
                  ×¡×’×•×¨
                </button>
              </>
            ) : (
              <>
                <h3 style={{margin:"0 0 6px",fontWeight:800}}>××™×¤×•×¡ ×¡×™×¡××”</h3>
                <p style={{color:"#6B7280",fontSize:13,margin:"0 0 16px"}}>×”×–×Ÿ ××ª ×›×ª×•×‘×ª ×”××™×™×œ ×©×œ×š ×•× ×©×œ×— ×œ×š ×§×™×©×•×¨ ×œ××™×¤×•×¡.</p>
                <input style={{width:"100%",border:"1px solid #D1D5DB",borderRadius:9,padding:"11px 13px",fontSize:14,fontFamily:"inherit",outline:"none",boxSizing:"border-box",marginBottom:12,direction:"ltr"}}
                  type="email" placeholder="your@email.com"
                  value={resetEmail} onChange={e=>setResetEmail(e.target.value)}
                  onKeyDown={e=>e.key==="Enter"&&trySendReset()}/>
                {err && <div style={{color:"#EF4444",fontSize:13,marginBottom:10,fontWeight:600}}>{err}</div>}
                <div style={{display:"flex",gap:8}}>
                  <button onClick={trySendReset} disabled={loading}
                    style={{flex:1,padding:"12px",background:"#2563EB",border:"none",borderRadius:10,color:"#fff",fontWeight:700,fontSize:14,cursor:"pointer",fontFamily:"inherit",opacity:loading?0.6:1}}>
                    {loading ? "×©×•×œ×—..." : "×©×œ×— ×§×™×©×•×¨"}
                  </button>
                  <button onClick={()=>{setResetMode(false);setErr("");}}
                    style={{padding:"12px 16px",background:"#F1F5F9",border:"1px solid #E5E7EB",borderRadius:10,color:"#6B7280",fontWeight:600,fontSize:14,cursor:"pointer",fontFamily:"inherit"}}>
                    ×‘×™×˜×•×œ
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ User Management Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function UserManagement({ users, saveUsers, tenantId }) {
  const [showAdd, setShowAdd] = useState(false);
  const [editId,  setEditId]  = useState(null);
  const [form, setForm] = useState({name:"",username:"",email:"",password:"",role:"manager"});
  const [err,  setErr]  = useState("");
  const [saving, setSaving] = useState(false);

  const resetForm = () => { setForm({name:"",username:"",email:"",password:"",role:"manager"}); setErr(""); setShowAdd(false); setEditId(null); };

  const save = async () => {
    if(!form.name.trim()||!form.username.trim()) return setErr("×™×© ×œ××œ× ×©× ×•×©× ××©×ª××©");
    if(!editId && (!form.email.trim()||!form.password)) return setErr("×™×© ×œ××œ× ××™×™×œ ×•×¡×™×¡××”");
    if(users.find(u=>u.username===form.username.trim()&&u.id!==editId)) return setErr("×©× ××©×ª××© ×›×‘×¨ ×§×™×™×");
    if(!editId && users.find(u=>u.email===form.email.trim())) return setErr("××™×™×œ ×›×‘×¨ ×§×™×™×");
    setSaving(true); setErr("");
    try {
      if(editId) {
        // Edit: only update profile fields (not email/password â€” use Firebase Console)
        saveUsers(users.map(u=>u.id===editId?{...u,name:form.name,username:form.username.trim(),role:form.role}:u));
      } else {
        // Create: Firebase Auth user first
        const firebaseUid = await window.firebaseCreateUser(form.email.trim(), form.password);
        // Write lookup table: tenants/{tenantId}/lookup/{username} = {email, firebaseUid}
        await window._rtdbSet(
          `tenants/${tenantId}/lookup/${form.username.trim().toLowerCase()}`,
          { email: form.email.trim(), firebaseUid }
        );
        const newUser = {id:Date.now(), name:form.name.trim(), username:form.username.trim(),
          email:form.email.trim(), role:form.role, firebaseUid};
        saveUsers([...users, newUser]);
        // Optionally send password reset so user sets their own password
        // await window.firebaseSendReset(form.email.trim());
      }
      resetForm();
    } catch(e) {
      const msg = e.code==="auth/email-already-in-use" ? "×”××™×™×œ ×›×‘×¨ ×¨×©×•× ×‘××¢×¨×›×ª"
        : e.code==="auth/weak-password" ? "×¡×™×¡××” ×—×œ×©×” ××“×™ (××™× ×™××•× 6 ×ª×•×•×™×)"
        : e.message || "×©×’×™××” ×‘×™×¦×™×¨×ª ×”××©×ª××©";
      setErr(msg);
    }
    setSaving(false);
  };

  const startEdit = (u) => { setEditId(u.id); setForm({name:u.name,username:u.username,password:"",role:u.role}); setShowAdd(true); };
  const deleteUser = (id) => { if(users.find(u=>u.id===id)?.role==="super_owner") return; saveUsers(users.filter(u=>u.id!==id)); };

  const UM = {
    wrap:{},
    card:{background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:14,padding:"14px 16px",marginBottom:8,display:"flex",alignItems:"center",gap:12,boxShadow:"0 1px 3px #0000000A"},
    roleBadge:{fontSize:11,fontWeight:700,padding:"3px 10px",borderRadius:20},
    addForm:{background:"#F9FAFB",border:"1px solid #E5E7EB",borderRadius:14,padding:"18px",marginBottom:12},
    lbl:{fontSize:13,color:"#6B7280",marginBottom:5,display:"block",fontWeight:600},
    inp:{width:"100%",border:"1px solid #D1D5DB",borderRadius:9,padding:"11px 13px",color:"#111827",fontSize:14,fontFamily:"inherit",outline:"none",boxSizing:"border-box",marginBottom:10,background:"#FFFFFF"},
    sel:{width:"100%",border:"1px solid #D1D5DB",borderRadius:9,padding:"11px 13px",color:"#111827",fontSize:14,fontFamily:"inherit",outline:"none",boxSizing:"border-box",marginBottom:10,background:"#FFFFFF"},
    saveBtn:{flex:1,padding:"12px",background:"#2563EB",border:"none",borderRadius:10,color:"#FFFFFF",fontWeight:700,fontSize:14,cursor:"pointer",fontFamily:"inherit"},
    cancelBtn:{padding:"12px 16px",background:"#F1F5F9",border:"1px solid #E5E7EB",borderRadius:10,color:"#6B7280",fontWeight:600,fontSize:14,cursor:"pointer",fontFamily:"inherit"},
    addBtn:{width:"100%",padding:"13px",background:"#EFF6FF",border:"1px solid #BFDBFE",borderRadius:12,color:"#2563EB",fontWeight:700,fontSize:14,cursor:"pointer",fontFamily:"inherit",marginTop:4},
    delBtn:{background:"none",border:"none",color:"#D1D5DB",cursor:"pointer",fontSize:18,padding:"4px 6px"},
    editBtn:{background:"#F1F5F9",border:"1px solid #E5E7EB",borderRadius:8,padding:"5px 10px",color:"#6B7280",cursor:"pointer",fontFamily:"inherit",fontSize:12,fontWeight:600},
    err:{color:"#EF4444",fontSize:12,marginBottom:8,fontWeight:600},
  };

  return (
    <div style={UM.wrap}>
      {/* User list */}
      {users.map(u=>(
        <div key={u.id} style={UM.card}>
          <div style={{flex:1}}>
            <div style={{fontWeight:700,color:"#111827",fontSize:14}}>{u.name}</div>
            <div style={{fontSize:12,color:"#9CA3AF",marginTop:2}}>@{u.username}</div>
          </div>
          <span style={{...UM.roleBadge,color:ROLES[u.role]?.color||"#6B7280",background:ROLES[u.role]?.bg||"#F9FAFB"}}>
            {ROLES[u.role]?.label||u.role}
          </span>
          <button style={UM.editBtn} onClick={()=>startEdit(u)}>×¢×¨×™×›×”</button>
          {u.role!=="super_owner" && <button style={UM.delBtn} onClick={()=>deleteUser(u.id)}>âœ•</button>}
        </div>
      ))}

      {/* Add/Edit form */}
      {showAdd ? (
        <div style={UM.addForm}>
          <div style={{fontWeight:700,color:"#111827",fontSize:15,marginBottom:14}}>{editId?"×¢×¨×™×›×ª ××©×ª××©":"×”×•×¡×¤×ª ××©×ª××©"}</div>
          {err && <div style={UM.err}>{err}</div>}
          <label style={UM.lbl}>×©× ××œ×</label>
          <input style={UM.inp} placeholder="×™×©×¨××œ ×™×©×¨××œ×™" value={form.name} onChange={e=>setForm(f=>({...f,name:e.target.value}))}/>
          <label style={UM.lbl}>×©× ××©×ª××©</label>
          <input style={UM.inp} placeholder="username" autoCapitalize="none" value={form.username} onChange={e=>setForm(f=>({...f,username:e.target.value}))} disabled={!!editId}/>
          {!editId && <>
            <label style={UM.lbl}>×›×ª×•×‘×ª ××™×™×œ (×œ×©×—×–×•×¨ ×¡×™×¡××”)</label>
            <input style={{...UM.inp,direction:"ltr"}} type="email" placeholder="user@example.com" value={form.email} onChange={e=>setForm(f=>({...f,email:e.target.value}))}/>
            <label style={UM.lbl}>×¡×™×¡××” ×¨××©×•× ×™×ª (××™× ×™××•× 6 ×ª×•×•×™×)</label>
            <input style={UM.inp} type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" value={form.password} onChange={e=>setForm(f=>({...f,password:e.target.value}))}/>
          </>}
          <label style={UM.lbl}>×ª×¤×§×™×“</label>
          <select style={UM.sel} value={form.role} onChange={e=>setForm(f=>({...f,role:e.target.value}))}>
            <option value="owner">×‘×¢×œ×™× â€” ×’×™×©×” ××œ××” ×œ×›×œ</option>
            <option value="manager">×× ×”×œ ××¡×¢×“×” â€” ×œ×•×— ×‘×§×¨×” ××œ×</option>
            <option value="staff">××—××© â€” ×¦×³×§×œ×™×¡×˜ ××©××¨×•×ª ×‘×œ×‘×“</option>
          </select>
          <div style={{display:"flex",gap:8,marginTop:4}}>
            <button style={UM.saveBtn} onClick={save}>×©××•×¨</button>
            <button style={UM.cancelBtn} onClick={resetForm}>×‘×™×˜×•×œ</button>
          </div>
        </div>
      ) : (
        <button style={UM.addBtn} onClick={()=>{setShowAdd(true);setEditId(null);}}>+ ×”×•×¡×£ ××©×ª××©</button>
      )}
    </div>
  );
}

// â”€â”€â”€ Setup Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DOW_LABELS = ["××³","×‘×³","×’×³","×“×³","×”×³","×•×³","×©×³"];
const DOW_FULL   = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];

function SetupWizard({ initial, initialSuppliers, initialFixed, onComplete, onCancel, isFirstSetup=true }) {
  const [step, setStep] = useState(1);
  // Step 1 â€” ×¤×¨×˜×™ ×¢×¡×§
  const [bizName,      setBizName]      = useState(initial.businessName || "");
  const [rentType,     setRentType]     = useState(initial.rentType || "pct"); // "pct" | "fixed"
  const [rentPct,      setRentPct]      = useState(initial.rentPct || "");
  const [rentFixed,    setRentFixed]    = useState(initial.rentFixed || "");
  const [hasRoyalty,   setHasRoyalty]   = useState(initial.hasRoyalty || false);
  const [royaltyPct,   setRoyaltyPct]   = useState(initial.royaltyPct || "");

  // Step 2 â€” ×™×¢×“×™×
  const [tFood,  setTFood]  = useState(initial.targets?.foodCostPct  || 33);
  const [tLabor, setTLabor] = useState(initial.targets?.laborCostPct || 27);
  const [tGrowth,setTGrowth]= useState(initial.targets?.salesGrowthPct || 5);

  // Step 3 â€” ×¡×¤×§×™×
  const [suppliers, setSuppliers] = useState(
    initialSuppliers.length > 0 ? initialSuppliers :
    [{ id: Date.now().toString(), name: "", category: "×›×œ×œ×™", days: [] }]
  );
  const [newSupName, setNewSupName] = useState("");
  const [newSupCat,  setNewSupCat]  = useState("×›×œ×œ×™");
  const [newSupDays, setNewSupDays] = useState([]);

  // Step 4 â€” ×§×‘×•×¢×•×ª
  const [fixedList, setFixedList] = useState(initialFixed);

  const W = {
    root:{position:"fixed",inset:0,background:"#F1F5F9",overflowY:"auto",zIndex:1000,fontFamily:"inherit",direction:"rtl"},
    wrap:{maxWidth:480,margin:"0 auto",padding:"24px 20px 80px"},
    header:{textAlign:"center",padding:"32px 0 28px"},
    step:{fontSize:12,color:"#9CA3AF",marginBottom:8,fontWeight:600,letterSpacing:1},
    progress:{height:3,background:"#F1F5F9",borderRadius:2,marginBottom:32,overflow:"hidden"},
    bar:{height:"100%",background:"#2563EB",borderRadius:2,transition:"width 0.4s"},
    title:{fontSize:22,fontWeight:900,color:"#111827",margin:"0 0 6px"},
    sub:{fontSize:14,color:"#9CA3AF",margin:0},
    card:{background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:16,padding:"18px",marginBottom:12,boxShadow:"0 1px 3px #0000000A"},
    lbl:{fontSize:13,color:"#6B7280",marginBottom:6,display:"block",fontWeight:500},
    inp:{width:"100%",background:"#F8FAFC",border:"1px solid #D1D5DB",borderRadius:10,padding:"12px 14px",color:"#111827",fontSize:15,fontFamily:"inherit",outline:"none",boxSizing:"border-box"},
    inpSm:{width:"80px",background:"#F8FAFC",border:"1px solid #D1D5DB",borderRadius:10,padding:"11px 12px",color:"#111827",fontSize:15,fontFamily:"inherit",outline:"none",textAlign:"center"},
    row:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10},
    rowLabel:{fontSize:14,color:"#111827",fontWeight:500},
    rowSub:{fontSize:12,color:"#9CA3AF"},
    bigBtn:{width:"100%",padding:"18px",background:"#2563EB",border:"none",borderRadius:14,color:"#0A0A0A",fontWeight:800,fontSize:16,cursor:"pointer",fontFamily:"inherit",marginTop:8},
    outBtn:{width:"100%",padding:"14px",background:"transparent",border:"1px solid #D1D5DB",borderRadius:14,color:"#6B7280",fontWeight:600,fontSize:14,cursor:"pointer",fontFamily:"inherit",marginTop:8},
    dayBtn:{width:36,height:36,borderRadius:8,border:"1px solid #D1D5DB",background:"#F8FAFC",color:"#6B7280",cursor:"pointer",fontFamily:"inherit",fontSize:13,fontWeight:700,display:"flex",alignItems:"center",justifyContent:"center"},
    dayBtnA:{background:"#EFF6FF",border:"1px solid #BFDBFE",color:"#2563EB"},
    supRow:{display:"flex",alignItems:"center",gap:8,padding:"10px 14px",background:"#F8FAFC",borderRadius:10,marginBottom:6},
    delBtn:{background:"none",border:"none",color:"#9CA3AF",cursor:"pointer",fontSize:16,padding:"2px 6px",fontFamily:"inherit"},
    toggle:{width:44,height:24,borderRadius:12,border:"none",cursor:"pointer",position:"relative",flexShrink:0,transition:"background 0.2s"},
    toggleKnob:{position:"absolute",top:3,width:18,height:18,borderRadius:"50%",background:"#F5F5F5",transition:"left 0.2s"},
  };

  const toggleDay = (d) => setNewSupDays(prev => prev.includes(d) ? prev.filter(x=>x!==d) : [...prev, d]);

  const addSupplier = () => {
    if(!newSupName.trim()) return;
    setSuppliers(prev => [...prev, { id: Date.now().toString(), name: newSupName.trim(), category: newSupCat, days: [...newSupDays] }]);
    setNewSupName(""); setNewSupCat("×›×œ×œ×™"); setNewSupDays([]);
  };

  const removeSupplier = (id) => setSuppliers(prev => prev.filter(s=>s.id!==id));

  const updateFixed = (id, field, val) => setFixedList(prev => prev.map(f => f.id===id ? {...f, [field]:field==="amount"?Number(val)||0:val} : f));

  // Step 5 â€” owner account
  const [ownerName,     setOwnerName]     = useState("");
  const [ownerUsername, setOwnerUsername] = useState("");
  const [ownerEmail,    setOwnerEmail]    = useState("");
  const [ownerPassword, setOwnerPassword] = useState("");
  const [ownerPass2,    setOwnerPass2]    = useState("");
  const [ownerErr,      setOwnerErr]      = useState("");

  const TOTAL_STEPS = isFirstSetup ? 5 : 4;

  const finish = async () => {
    if(isFirstSetup) {
      if(!ownerName.trim()||!ownerUsername.trim()||!ownerEmail.trim()||!ownerPassword) return setOwnerErr("×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×›×•×œ×œ ××™×™×œ");
      if(!/^[^@]+@[^@]+\.[^@]+$/.test(ownerEmail.trim())) return setOwnerErr("×›×ª×•×‘×ª ××™×™×œ ×œ× ×ª×§×™× ×”");
      if(ownerPassword.length < 6) return setOwnerErr("×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª 6 ×ª×•×•×™×");
      if(ownerPassword!==ownerPass2) return setOwnerErr("×”×¡×™×¡×××•×ª ××™× ×Ÿ ×ª×•×××•×ª");
      setOwnerErr("");
    }
    const cfg = {
      businessName: bizName.trim() || "×”××¡×¢×“×” ×©×œ×™",
      rentType,
      rentPct:   rentType==="pct"   ? Number(rentPct)||0   : 0,
      rentFixed: rentType==="fixed" ? Number(rentFixed)||0 : 0,
      hasRoyalty,
      royaltyPct: hasRoyalty ? Number(royaltyPct)||0 : 0,
      targets: { salesGrowthPct:Number(tGrowth)||5, foodCostPct:Number(tFood)||33, laborCostPct:Number(tLabor)||27 }
    };
    const updatedFixed = fixedList.map(f => {
      if(f.rentPct) return {...f, name:`×©×›×¨ ×“×™×¨×” (${cfg.rentPct}% ×××—×–×•×¨)`};
      if(f.royaltyPct) return hasRoyalty ? {...f, name:`×ª××œ×•×’×™× (${cfg.royaltyPct}% ×××—×–×•×¨)`} : {...f, amount:0};
      return f;
    });
    const firstOwner = isFirstSetup ? { name:ownerName.trim(), username:ownerUsername.trim(),
      email:ownerEmail.trim(), password:ownerPassword } : null;
    onComplete(cfg, suppliers.filter(s=>s.name), updatedFixed, firstOwner);
  };

  return (
    <div style={W.root}>
      <div style={W.wrap}>
        <div style={W.header}>
          <div style={W.step}>×©×œ×‘ {step} ××ª×•×š {TOTAL_STEPS}</div>
          <div style={W.progress}><div style={{...W.bar, width:`${(step/TOTAL_STEPS)*100}%`}}/></div>
          {step===1 && <><h2 style={W.title}>×‘×¨×•×›×™× ×”×‘××™× ğŸ‘‹</h2><p style={W.sub}>× ×’×“×™×¨ ××ª ×”×¢×¡×§ ×©×œ×š â€” ×œ×•×§×— 3 ×“×§×•×ª</p></>}
          {step===2 && <><h2 style={W.title}>×™×¢×“×™× ×¢×¡×§×™×™× ğŸ¯</h2><p style={W.sub}>××” ××ª×” ××›×•×•×Ÿ ×œ×”×©×™×’?</p></>}
          {step===3 && <><h2 style={W.title}>×¨×©×™××ª ×¡×¤×§×™× ğŸ­</h2><p style={W.sub}>×”×•×¡×£ ×¡×¤×§×™× ×•×™××™ ××¡×¤×§×”</p></>}
          {step===4 && <><h2 style={W.title}>×”×•×¦××•×ª ×§×‘×•×¢×•×ª ğŸ”’</h2><p style={W.sub}>×¡×›×•××™× ×—×•×“×©×™×™× ×§×‘×•×¢×™×</p></>}
          {step===5 && <><h2 style={W.title}>×™×¦×™×¨×ª ×—×©×‘×•×Ÿ ğŸ”</h2><p style={W.sub}>×¤×¨×˜×™ ×›× ×™×¡×” ×œ×‘×¢×œ×™× ×”×¨××©×™</p></>}
        </div>

        {/* â”€â”€ STEP 1 â”€â”€ */}
        {step===1 && (
          <>
            <div style={W.card}>
              <label style={W.lbl}>×©× ×”×¢×¡×§</label>
              <input style={W.inp} placeholder="×œ××©×œ: ×§×¤×” ×™×¨×•×©×œ××™" value={bizName} onChange={e=>setBizName(e.target.value)}/>
            </div>
            <div style={W.card}>
              <label style={W.lbl}>×©×›×¨ ×“×™×¨×”</label>
              {/* toggle: % ××—×–×•×¨ / ×§×‘×•×¢ */}
              <div style={{display:"flex",gap:6,marginBottom:14}}>
                {[["pct","% ×××—×–×•×¨"],["fixed","×¡×›×•× ×§×‘×•×¢"]].map(([t,l])=>(
                  <button key={t} style={{flex:1,padding:"10px",borderRadius:10,border:"1px solid",cursor:"pointer",fontFamily:"inherit",fontSize:13,fontWeight:700,
                    background:rentType===t?"#22C55E15":"#0A0A0A",
                    borderColor:rentType===t?"#22C55E40":"#2A2A2A",
                    color:rentType===t?"#22C55E":"#737373"}}
                    onClick={()=>setRentType(t)}>{l}</button>
                ))}
              </div>
              {rentType==="pct" ? (
                <div style={{display:"flex",alignItems:"center",gap:10}}>
                  <input style={W.inpSm} type="number" placeholder="0" value={rentPct} onChange={e=>setRentPct(e.target.value)}/>
                  <span style={{color:"#9CA3AF",fontSize:14}}>% ××”×”×›× ×¡×•×ª ×”×—×•×“×©×™×•×ª</span>
                </div>
              ) : (
                <div style={{display:"flex",alignItems:"center",gap:10}}>
                  <input style={{...W.inpSm,width:110}} type="number" placeholder="0" value={rentFixed} onChange={e=>setRentFixed(e.target.value)}/>
                  <span style={{color:"#9CA3AF",fontSize:14}}>â‚ª ×‘×—×•×“×©</span>
                </div>
              )}
            </div>
            <div style={W.card}>
              <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:hasRoyalty?14:0}}>
                <div>
                  <div style={{fontSize:14,color:"#111827",fontWeight:600}}>×ª××œ×•×’×™× ×œ×¨×©×ª</div>
                  <div style={{fontSize:12,color:"#9CA3AF",marginTop:2}}>×¨×œ×•×•× ×˜×™ ×œ×–×™×›×™×•×Ÿ / ×¨×©×ª</div>
                </div>
                <button style={{...W.toggle, background:hasRoyalty?"#22C55E":"#2A2A2A"}} onClick={()=>setHasRoyalty(p=>!p)}>
                  <div style={{...W.toggleKnob, left:hasRoyalty?23:3}}/>
                </button>
              </div>
              {hasRoyalty && (
                <div style={{display:"flex",alignItems:"center",gap:10}}>
                  <input style={W.inpSm} type="number" placeholder="0" value={royaltyPct} onChange={e=>setRoyaltyPct(e.target.value)}/>
                  <span style={{color:"#9CA3AF",fontSize:14}}>% ×××—×–×•×¨</span>
                </div>
              )}
            </div>
            <button style={W.bigBtn} onClick={()=>setStep(2)}>×”××©×š â†</button>
            {onCancel && <button style={W.outBtn} onClick={onCancel}>×‘×™×˜×•×œ</button>}
          </>
        )}

        {/* â”€â”€ STEP 2 â”€â”€ */}
        {step===2 && (
          <>
            {[
              {label:"×™×¢×“ ×¤×•×“ ×§×•×¡×˜",sub:"% ××”××—×–×•×¨ â€” ×¡×˜× ×“×¨×˜ ×¢× ×¤×™ 28-35%",val:tFood,set:setTFood,color:"#22C55E"},
              {label:"×™×¢×“ ×œ×™×™×‘×•×¨",sub:"% ××”××—×–×•×¨ â€” ×¡×˜× ×“×¨×˜ ×¢× ×¤×™ 25-30%",val:tLabor,set:setTLabor,color:"#F59E0B"},
              {label:"×™×¢×“ ×¦××™×—×”",sub:"% ×’×™×“×•×œ ××•×œ ×©× ×” ×©×¢×‘×¨×”",val:tGrowth,set:setTGrowth,color:"#6B7280"},
            ].map(({label,sub,val,set,color})=>(
              <div key={label} style={W.card}>
                <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                  <div>
                    <div style={{fontSize:14,color:"#111827",fontWeight:600}}>{label}</div>
                    <div style={{fontSize:11,color:"#9CA3AF",marginTop:2}}>{sub}</div>
                  </div>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <button style={{...W.dayBtn,width:32,height:32,fontSize:16}} onClick={()=>set(v=>Math.max(0,Math.round((Number(v)-0.5)*10)/10))}>âˆ’</button>
                    <input type="number" inputMode="decimal" step="0.5" min="0" max="100" value={val} onChange={e=>set(e.target.value)} style={{width:58,textAlign:"center",fontSize:16,fontWeight:900,color,border:"1px solid #E5E7EB",borderRadius:8,padding:"3px 4px",background:"#F9FAFB",fontFamily:"inherit"}}/>
                    <span style={{fontSize:14,color,fontWeight:700,marginLeft:-4}}>%</span>
                    <button style={{...W.dayBtn,width:32,height:32,fontSize:16}} onClick={()=>set(v=>Math.round((Number(v)+0.5)*10)/10)}>+</button>
                  </div>
                </div>
              </div>
            ))}
            <button style={W.bigBtn} onClick={()=>setStep(3)}>×”××©×š â†</button>
            <button style={W.outBtn} onClick={()=>setStep(1)}>â†’ ×—×–×¨×”</button>
          </>
        )}

        {/* â”€â”€ STEP 3 â”€â”€ */}
        {step===3 && (
          <>
            {/* ×¨×©×™××ª ×¡×¤×§×™× ×§×™×™××™× */}
            {suppliers.filter(s=>s.name).map(sup=>(
              <div key={sup.id} style={W.supRow}>
                <button style={W.delBtn} onClick={()=>removeSupplier(sup.id)}>âœ•</button>
                <div style={{flex:1}}>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <div style={{fontSize:14,color:"#111827",fontWeight:600}}>{sup.name}</div>
                  </div>
                  <div style={{fontSize:11,color:"#9CA3AF",marginTop:1}}>
                    {sup.category} Â· {sup.days.length>0 ? sup.days.map(d=>DOW_LABELS[d]).join(" ") : "×œ×œ× ×™××™× ×§×‘×•×¢×™×"}
                  </div>
                </div>
              </div>
            ))}

            {/* ×”×•×¡×¤×ª ×¡×¤×§ */}
            <div style={{...W.card,marginTop:8}}>
              <label style={W.lbl}>×©× ×¡×¤×§ ×—×“×©</label>
              <input style={{...W.inp,marginBottom:12}} placeholder="×œ××©×œ: ×ª× ×•×‘×”" value={newSupName} onChange={e=>setNewSupName(e.target.value)}/>
              <label style={W.lbl}>×§×˜×’×•×¨×™×”</label>
              <select style={{...W.inp,marginBottom:12}} value={newSupCat} onChange={e=>setNewSupCat(e.target.value)}>
                {["×›×œ×œ×™","×™×¨×§×•×ª","×‘×©×¨","×—×œ×‘","×××¤×™×","×©×ª×™×™×”","×‘×™×¦×™×","×“×’×™×","×§×¤×”","×¡×œ×˜×™×","×›×‘×•×©×™×"].map(c=><option key={c}>{c}</option>)}
              </select>
              <label style={W.lbl}>×™××™ ××¡×¤×§×”</label>
              <div style={{display:"flex",gap:6,marginBottom:14,flexWrap:"wrap"}}>
                {DOW_LABELS.map((d,i)=>(
                  <button key={i} style={{...W.dayBtn,...(newSupDays.includes(i)?W.dayBtnA:{})}} onClick={()=>toggleDay(i)}>{d}</button>
                ))}
              </div>
              <button style={{...W.bigBtn,marginTop:0,background:newSupName.trim()?"#22C55E":"#1C1C1C",color:newSupName.trim()?"#0A0A0A":"#525252"}}
                onClick={addSupplier}>+ ×”×•×¡×£ ×¡×¤×§</button>
            </div>

            {suppliers.filter(s=>s.name).length===0 && (
              <p style={{color:"#9CA3AF",fontSize:13,textAlign:"center",marginTop:8}}>××¤×©×¨ ×œ×”×•×¡×™×£ ×¡×¤×§×™× ×’× ××—×¨×™ ×”×”×’×“×¨×”</p>
            )}
            <button style={W.bigBtn} onClick={()=>setStep(4)}>×”××©×š â†</button>
            <button style={W.outBtn} onClick={()=>setStep(2)}>â†’ ×—×–×¨×”</button>
          </>
        )}

        {/* â”€â”€ STEP 4 â”€â”€ */}
        {step===4 && (
          <>
            <p style={{color:"#9CA3AF",fontSize:13,marginBottom:16,textAlign:"center"}}>×”×–×Ÿ ×¡×›×•××™× ×—×•×“×©×™×™× ×§×‘×•×¢×™× â€” ××¤×¡ = ×œ× ×¨×œ×•×•× ×˜×™</p>
            {fixedList.filter(f=>!f.rentPct&&!f.royaltyPct).map(f=>(
              <div key={f.id} style={{...W.row,...{background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:12,padding:"12px 14px",marginBottom:8}}}>
                <div>
                  <div style={W.rowLabel}>{f.name}</div>
                </div>
                <div style={{display:"flex",alignItems:"center",gap:6}}>
                  <input style={{...W.inpSm,width:90}} type="number" placeholder="0" value={f.amount||""} onChange={e=>updateFixed(f.id,"amount",e.target.value)}/>
                  <span style={{color:"#9CA3AF",fontSize:12}}>â‚ª</span>
                </div>
              </div>
            ))}
            <div style={{background:"#FFFFFF",border:"1px solid #22C55E25",borderRadius:12,padding:"14px",marginTop:8,marginBottom:16}}>
              <div style={{display:"flex",justifyContent:"space-between"}}>
                <span style={{color:"#6B7280",fontSize:13}}>×¡×”×´×› ×§×‘×•×¢×•×ª ×—×•×“×©×™×•×ª</span>
                <span style={{color:"#111827",fontWeight:800,fontSize:15}}>
                  â‚ª{fixedList.filter(f=>!f.rentPct&&!f.royaltyPct).reduce((a,f)=>a+(Number(f.amount)||0),0).toLocaleString()}
                </span>
              </div>
            </div>
            <button style={W.bigBtn} onClick={isFirstSetup ? ()=>setStep(5) : finish}>{isFirstSetup ? "×”××©×š â†" : "âœ… ×¡×™×•×"}</button>
            <button style={W.outBtn} onClick={()=>setStep(3)}>â†’ ×—×–×¨×”</button>
          </>
        )}
        {/* â”€â”€ STEP 5 (only for first setup) â”€â”€ */}
        {step===5 && isFirstSetup && (
          <>
            <div style={W.card}>
              <label style={W.lbl}>×©× ××œ× ×©×œ ×”×‘×¢×œ×™×</label>
              <input style={{...W.inp,marginBottom:12}} placeholder="×™×©×¨××œ ×™×©×¨××œ×™" value={ownerName} onChange={e=>setOwnerName(e.target.value)}/>
              <label style={W.lbl}>×©× ××©×ª××© ×œ×›× ×™×¡×”</label>
              <input style={{...W.inp,marginBottom:12}} placeholder="username" autoCapitalize="none" value={ownerUsername} onChange={e=>setOwnerUsername(e.target.value)}/>
              <label style={W.lbl}>×›×ª×•×‘×ª ××™×™×œ (×œ×©×—×–×•×¨ ×¡×™×¡××”)</label>
              <input style={{...W.inp,marginBottom:12,direction:"ltr"}} type="email" placeholder="your@email.com" value={ownerEmail} onChange={e=>setOwnerEmail(e.target.value)}/>
              <label style={W.lbl}>×¡×™×¡××” (×œ×¤×—×•×ª 6 ×ª×•×•×™×)</label>
              <input style={{...W.inp,marginBottom:12}} type="password" placeholder="×œ×¤×—×•×ª 6 ×ª×•×•×™×" value={ownerPassword} onChange={e=>setOwnerPassword(e.target.value)}/>
              <label style={W.lbl}>××™××•×ª ×¡×™×¡××”</label>
              <input style={{...W.inp,marginBottom:0}} type="password" placeholder="×”×›× ×¡ ×©×•×‘" value={ownerPass2} onChange={e=>setOwnerPass2(e.target.value)}/>
            </div>
            {ownerErr && <p style={{color:"#EF4444",fontSize:13,textAlign:"center",margin:"0 0 12px",fontWeight:600}}>{ownerErr}</p>}
            <button style={W.bigBtn} onClick={finish}>âœ… ×¡×™×•× â€” ×›× ×™×¡×” ×œ×œ×•×— ×”×‘×§×¨×”</button>
            <button style={W.outBtn} onClick={()=>setStep(4)}>â†’ ×—×–×¨×”</button>
          </>
        )}
      </div>
    </div>
  );
}



// â”€â”€â”€ CreditInput â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CreditInput({ supplierId, supplierName, date, onAdd }) {
  const [open, setOpen] = useState(false);
  const [amount, setAmount] = useState("");
  const [note, setNote]   = useState("");
  if(!open) return (
    <button onClick={()=>setOpen(true)}
      style={{marginTop:6,fontSize:11,color:"#B45309",background:"#FFFBEB",border:"1px solid #FCD34D",borderRadius:8,padding:"3px 10px",cursor:"pointer",fontFamily:"inherit",fontWeight:600}}>
      ğŸ“„ ×”×•×¡×£ ×–×™×›×•×™ ×××ª×™×Ÿ
    </button>
  );
  return (
    <div style={{marginTop:8,background:"#FFFBEB",border:"1px solid #FCD34D",borderRadius:10,padding:"10px 12px"}}>
      <div style={{fontSize:12,fontWeight:700,color:"#92400E",marginBottom:8}}>ğŸ“„ ×–×™×›×•×™ ×××ª×™×Ÿ ×{supplierName}</div>
      <input style={{width:"100%",padding:"8px 10px",borderRadius:8,border:"1px solid #FCD34D",background:"#fff",fontSize:14,fontFamily:"inherit",marginBottom:6,boxSizing:"border-box"}}
        type="number" inputMode="numeric" placeholder="×¡×›×•× ×”×–×™×›×•×™ (â‚ª)" value={amount} onChange={e=>setAmount(e.target.value)}/>
      <input style={{width:"100%",padding:"8px 10px",borderRadius:8,border:"1px solid #FCD34D",background:"#fff",fontSize:13,fontFamily:"inherit",marginBottom:8,boxSizing:"border-box"}}
        placeholder="×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™)" value={note} onChange={e=>setNote(e.target.value)}/>
      <div style={{display:"flex",gap:8}}>
        <button onClick={()=>{if(Number(amount)>0){onAdd(supplierId,supplierName,date,Number(amount),note);setOpen(false);setAmount("");setNote("");}}}
          style={{flex:1,padding:"7px",background:"#F59E0B",border:"none",borderRadius:8,color:"#fff",fontWeight:700,fontSize:13,cursor:"pointer",fontFamily:"inherit"}}>
          âœ“ ×”×•×¡×£
        </button>
        <button onClick={()=>setOpen(false)}
          style={{padding:"7px 14px",background:"none",border:"1px solid #FCD34D",borderRadius:8,color:"#B45309",cursor:"pointer",fontFamily:"inherit",fontSize:13}}>
          ×‘×™×˜×•×œ
        </button>
      </div>
    </div>
  );
}

// â”€â”€â”€ Business Selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BusinessSelector({ businesses, onSelect, onAdd, userName }) {
  return (
    <div style={{minHeight:"100vh",background:"#F1F5F9",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"24px",fontFamily:"'Heebo',sans-serif",direction:"rtl"}}>
      <div style={{background:"#FFFFFF",borderRadius:20,padding:"32px 28px",width:"100%",maxWidth:400,boxShadow:"0 4px 24px #0000001A",border:"1px solid #E5E7EB"}}>
        <div style={{textAlign:"center",marginBottom:28}}>
          <div style={{fontSize:40,marginBottom:8}}>ğŸ¢</div>
          <h2 style={{margin:0,fontSize:20,fontWeight:900,color:"#111827"}}>×‘×—×¨ ××¡×¢×“×”</h2>
          <p style={{margin:"6px 0 0",color:"#9CA3AF",fontSize:13}}>×©×œ×•× {userName}</p>
        </div>
        {businesses.map(biz => (
          <button key={biz.id} onClick={() => onSelect(biz.id)}
            style={{width:"100%",padding:"18px 20px",background:"#F8FAFC",border:"1px solid #E5E7EB",borderRadius:14,marginBottom:10,cursor:"pointer",fontFamily:"inherit",display:"flex",alignItems:"center",justifyContent:"space-between",transition:"all 0.15s"}}>
            <div style={{textAlign:"right"}}>
              <div style={{fontSize:16,fontWeight:700,color:"#111827"}}>{biz.name}</div>
            </div>
            <span style={{fontSize:20}}>â†</span>
          </button>
        ))}
        <button onClick={onAdd}
          style={{width:"100%",padding:"14px",background:"#EFF6FF",border:"1px solid #BFDBFE",borderRadius:14,color:"#2563EB",fontWeight:700,fontSize:14,cursor:"pointer",fontFamily:"inherit",marginTop:4}}>
          + ×”×•×¡×£ ××¡×¢×“×” ×—×“×©×”
        </button>
      </div>
    </div>
  );
}

// â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PilotDashboard() {
  const [entries, setEntries] = useState([]);
  const [screen, setScreen] = useState("dashboard");
  const [form, setForm] = useState({...EMPTY_ENTRY});
  const [editingId, setEditingId] = useState(null);
  const [fixedList, setFixedList] = useState(FIXED_EXPENSES_DEFAULT);
  const [lastYear, setLastYear] = useState(LAST_YEAR_2025);
  const [saved, setSaved] = useState(false);
  const [loaded, setLoaded] = useState(false);
  const [fcTab, setFcTab] = useState("summary");
  const [weather, setWeather] = useState(null); // {temp, rain, wind, desc, icon, alert}
  const [weatherErr, setWeatherErr] = useState(false);
  const [orefAlert, setOrefAlert] = useState(null); // null | {cities:[], category:str, time:str}
  const [orefHistory, setOrefHistory] = useState([]); // [{date, count}] for today
  const [expandedSup, setExpandedSup] = useState(null);
  const [supMonth, setSupMonth] = useState(`${YEAR}-${MONTH_STR}`);
  // â”€â”€ ×”×¨×©××•×ª: null = ×‘×¢×œ×™×, { name, role:"manager", permissions:[] } = ××—××© ××—×•×‘×¨
  const [currentUser, setCurrentUser] = useState(null);
  const [masterTasks, setMasterTasks] = useState([]);
  const [loggedInUser, setLoggedInUser] = useState(null);
  const [appUsers, setAppUsers]     = useState([]);
  const [setupDone, setSetupDone] = useState(false);
  const [showSetup, setShowSetup] = useState(false);
  const [businesses, setBusinesses] = useState([]);
  const [currentBizId, setCurrentBizId_] = useState(null);
  const setCurrentBizId = id => {
    setCurrentBizId_(id);
    if (id && window.setTenantId) window.setTenantId(id);
  };
  const [showBizSelect, setShowBizSelect] = useState(false);
  const [entryStep, setEntryStep] = useState('idle'); // 'idle' | 'revenue' | 'suppliers'
  const [pendingCredits, setPendingCredits] = useState([]); // [{id,supplierId,supplierName,date,amount,note}]
  const [businessConfig, setBusinessConfig] = useState({
    businessName: "",
    rentPct: 0, royaltyPct: 0, hasRoyalty: false,
    targets: { salesGrowthPct:5, foodCostPct:33, laborCostPct:27 }
  });
  const [suppliers, setSuppliers] = useState([]);

  const sg = async (key, shared=false) => { try { return await window.storage.get(key, shared); } catch(_){ return null; } };

  // useEffect 1: global data (users, businesses)
  useEffect(()=>{
    const init = async () => {
      const rau = await sg("app-users", true);
      if(rau) {
        const users = JSON.parse(rau.value);
        setAppUsers(users);
        try {
          const saved = localStorage.getItem("marjin-session");
          if(saved) {
            const s = JSON.parse(saved);
            const valid = users.find(u => u.id===s.id && u.password===s.password);
            if(valid) setLoggedInUser(valid);
          }
        } catch(_){}
      }
      const rb = await sg("app-businesses", true);
      if(rb) {
        const bizList = JSON.parse(rb.value);
        setBusinesses(bizList);
        if(bizList.length === 1) setCurrentBizId(bizList[0].id);
      }
      setLoaded(true);
    };
    if(window._firebaseReady) { init(); }
    else { window.addEventListener("firebase-ready", init, {once:true}); }
  },[]);

  // useEffect 2: business-specific data â€” live listeners
  useEffect(()=>{
    if(!currentBizId) return;
    const unsubs = [];
    const sub = (key, setter, shared=false) => {
      if(!window.storage.subscribe) return;
      unsubs.push(window.storage.subscribe(key, r => {
        try { setter(JSON.parse(r.value)); } catch(_){}
      }, shared));
    };
    // Initial load â€” only for data without live listeners
    (async()=>{
      const rly = await sg(`biz:${currentBizId}:lastyear`);
      if(rly) setLastYear(JSON.parse(rly.value));
      setSetupDone(true);
    })();
    // Live listeners â€” fire immediately with current value AND on every change
    sub(`biz:${currentBizId}:entries`, (val) => {
      // Only update if we received a non-empty array, or entries is currently empty
      if(Array.isArray(val) && (val.length > 0 || true)) setEntries(val);
    });
    sub(`biz:${currentBizId}:fixed`,     setFixedList);
    sub(`biz:${currentBizId}:suppliers`, setSuppliers);
    sub(`biz:${currentBizId}:config`,    setBusinessConfig);
    sub(`biz:${currentBizId}:credits`,   setPendingCredits);
    sub("app-users", u => { setAppUsers(u); }, true);

    // Fetch weather â€” Open-Meteo, no API key needed
    const lat = businessConfig?.lat || 32.4342;
    const lon = businessConfig?.lon || 34.9194;
    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation,windspeed_10m,weathercode&timezone=Asia/Jerusalem`)
      .then(r=>r.json())
      .then(d=>{
        const c = d.current;
        const wc = c.weathercode;
        const isRain = wc>=51 && wc<=99;
        const isHeat = c.temperature_2m >= 35;
        const isCold = c.temperature_2m <= 10;
        const icons = {clear:"â˜€ï¸",cloud:"â›…",rain:"ğŸŒ§ï¸",thunder:"â›ˆï¸",snow:"â„ï¸",fog:"ğŸŒ«ï¸"};
        const icon = wc<=1?"â˜€ï¸":wc<=3?"â›…":wc<=49?"ğŸŒ«ï¸":wc<=69?"ğŸŒ§ï¸":wc<=79?"â„ï¸":wc<=99?"â›ˆï¸":"â˜€ï¸";
        const desc = isRain?"×’×©×":isHeat?"×—×•× ×§×™×¦×•× ×™":isCold?"×§×•×¨":wc<=1?"×‘×”×™×¨":wc<=3?"××¢×•× ×Ÿ ×—×œ×§×™×ª":"××¢×•× ×Ÿ";
        const alert = isRain||isHeat||isCold;
        setWeather({temp:Math.round(c.temperature_2m), rain:c.precipitation, wind:Math.round(c.windspeed_10m), desc, icon, alert, isRain, isHeat, isCold});
      })
      .catch(()=>setWeatherErr(true));

    // â”€â”€â”€ Pikud Ha-Oref â€” current alerts â”€â”€â”€
    const HADERA_AREAS = ["×—×“×¨×”","×§×¨×™×ª ×™×","×§×¨×™×ª ×‘×™××œ×™×§","×‘× ×™××™× ×”","×–×›×¨×•×Ÿ ×™×¢×§×‘","×¢××™×§×","×¢×™×Ÿ ×¢×™×¨×•×Ÿ","×§×¦×™×¨"];
    const fetchOref = () => {
      fetch("/api/oref")
      .then(r=>r.text())
      .then(txt=>{
        if(!txt || txt.trim()==="") { setOrefAlert(null); return; }
        const d = JSON.parse(txt);
        const cities = d.data||[];
        const inArea = cities.some(c=>HADERA_AREAS.some(a=>c.includes(a)));
        if(inArea || cities.length>0) {
          setOrefAlert({cities, category:d.cat||"1", time:new Date().toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})});
        } else {
          setOrefAlert(null);
        }
      })
      .catch(()=>{}); // silent â€” CORS may block
    };
    fetchOref();
    const orefInterval = setInterval(fetchOref, 30000); // poll every 30s

    return () => { unsubs.forEach(u => typeof u==="function" && u()); clearInterval(orefInterval); };
  },[currentBizId]);

  const persist = async (e, f) => {
    if(!currentBizId) throw new Error("no bizId");
    await window.storage.set(`biz:${currentBizId}:entries`, JSON.stringify(e), true);
    if(f) await window.storage.set(`biz:${currentBizId}:fixed`, JSON.stringify(f), true);
  };
  const saveLastYear = async (ly) => {
    setLastYear(ly);
    if(!currentBizId) return;
    try { await window.storage.set(`biz:${currentBizId}:lastyear`, JSON.stringify(ly), true); } catch(_){}
  };
  const saveBusinessConfig = async (cfg) => {
    setBusinessConfig(cfg);
    if(!currentBizId) return;
    try { await window.storage.set(`biz:${currentBizId}:config`, JSON.stringify(cfg), true); } catch(_){}
  };
  const saveSuppliers = async (sups) => {
    setSuppliers(sups);
    if(!currentBizId) return;
    try { await window.storage.set(`biz:${currentBizId}:suppliers`, JSON.stringify(sups), true); } catch(_){}
  };
  const completeSetup = async (cfg, sups, fixed, firstOwner) => {
    const bizId = currentBizId || `biz_${Date.now()}`;
    // Set tenantId FIRST â€” all storage calls depend on it
    if (window.setTenantId) window.setTenantId(bizId);
    // Register business in list
    const bizName = cfg.businessName || "××¡×¢×“×” ×—×“×©×”";
    const updatedBizList = [...businesses.filter(b=>b.id!==bizId), {id:bizId, name:bizName}];
    setBusinesses(updatedBizList);
    try { await window.storage.set("app-businesses", JSON.stringify(updatedBizList), true); } catch(_){}
    // Save biz-specific data
    try { await window.storage.set(`biz:${bizId}:config`, JSON.stringify(cfg), true); } catch(_){}
    setBusinessConfig(cfg);
    try { await window.storage.set(`biz:${bizId}:suppliers`, JSON.stringify(sups), true); } catch(_){}
    setSuppliers(sups);
    if(fixed) { setFixedList(fixed); try { await window.storage.set(`biz:${bizId}:fixed`, JSON.stringify(fixed), true); } catch(_){} }
    if(firstOwner) {
      try {
        // Create Firebase Auth account for owner
        const firebaseUid = await window.firebaseCreateUser(firstOwner.email, firstOwner.password);
        // Write username lookup table
        await window._rtdbSet(
          `tenants/${bizId}/lookup/${firstOwner.username.toLowerCase()}`,
          { email: firstOwner.email, firebaseUid }
        );
        // Sign in as owner right away
        await window.firebaseSignIn(firstOwner.email, firstOwner.password);
        const ownerRecord = {id:Date.now(), name:firstOwner.name, username:firstOwner.username,
          email:firstOwner.email, role:"super_owner", firebaseUid};
        const users = [ownerRecord];
        setAppUsers(users);
        try { await window.storage.set("app-users", JSON.stringify(users), true); } catch(_){}
        setLoggedInUser(ownerRecord);
      } catch(e) {
        console.error("[completeSetup] owner auth creation failed:", e.message);
        // Fallback: store user without Firebase Auth
        const ownerRecord = {id:Date.now(), name:firstOwner.name, username:firstOwner.username,
          email:firstOwner.email||"", role:"super_owner"};
        const users = [ownerRecord];
        setAppUsers(users);
        try { await window.storage.set("app-users", JSON.stringify(users), true); } catch(_){}
        setLoggedInUser(ownerRecord);
      }
    }
    if(!currentBizId) setCurrentBizId(bizId);
    setSetupDone(true);
    setShowSetup(false);
    setShowBizSelect(false);
  };
  const saveAppUsers = async (users) => {
    setAppUsers(users);
    try { await window.storage.set("app-users", JSON.stringify(users), true); } catch(_){}
  };


  const saveMasterTasks = async (t) => {
    setMasterTasks(t);
    if(!currentBizId) return;
    try { await window.storage.set(`biz:${currentBizId}:tasks`, JSON.stringify(t), true); } catch(_){}
  };

  const setSupPay = (sid, val) => setForm(f=>({...f, supplier_payments:{...f.supplier_payments,[sid]:val}}));

  const saveRevenueStep = () => {
    // Save with current supplier data (empty if new entry)
    let updated = editingId!==null
      ? entries.map((e,i)=>i===editingId?{...form}:e)
      : [...entries,{...form}];
    updated.sort((a,b)=>a.date.localeCompare(b.date));
    setEntries(updated); persist(updated,null);
    if(editingId!==null) {
      // editing: go straight to done
      setForm({...EMPTY_ENTRY}); setEditingId(null); setSaved(true);
      setTimeout(()=>{setSaved(false); setEntryStep('idle'); setScreen("dashboard");},1000);
    } else {
      setEntryStep('suppliers');
    }
  };

  const saveEntry = async (skipSuppliers=false) => {
    const globalEmps = (businessConfig.employees||[]).filter(e=>Number(e.monthlySalary)>0);
    const globalDaily = globalEmps.reduce((a,e)=>a+Math.round(Number(e.monthlySalary)/DAYS_IN_MONTH),0);
    const formFinal = {...form, payroll: globalDaily + (Number(form.payroll)||0)};
    const netForm = formFinal.includeVat ? {
      ...formFinal,
      sales:        Math.round((Number(formFinal.sales)||0)        / VAT_RATE),
      deliveries:   Math.round((Number(formFinal.deliveries)||0)   / VAT_RATE),
      other_income: Math.round((Number(formFinal.other_income)||0) / VAT_RATE),
      includeVat: false,
    } : formFinal;
    let updated = editingId!==null
      ? entries.map((e,i)=>i===editingId?{...netForm}:e)
      : [...entries,{...netForm}];
    updated.sort((a,b)=>a.date.localeCompare(b.date));
    setEntries(updated);
    try {
      await persist(updated, null);
    } catch(err) {
      alert("×©×’×™××” ×‘×©××™×¨×” â€” ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×•× ×¡×” ×©×•×‘");
      return;
    }
    setForm({...EMPTY_ENTRY}); setEditingId(null); setSaved(true);
    setTimeout(()=>{setSaved(false); setEntryStep('idle'); setScreen("dashboard");},1000);
  };

  const deleteEntry = i => { const u=entries.filter((_,idx)=>idx!==i); setEntries(u); persist(u,null); };

  const metrics = calcMetrics(entries, fixedList, {...businessConfig, suppliers});
  const chart = buildChart(entries);
  const todayEntry = entries.find(e=>e.date===TODAY_STR);

  // Calculate missing supplier data per supplier this month
  const supplierMissingDays = {};
  if(suppliers.length > 0) {
    for(let d=1; d<DAY_OF_MONTH; d++){
      const ds=`${YEAR}-${MONTH_STR}-${String(d).padStart(2,"0")}`;
      const dow=getDateDOW(ds);
      if(dow===6) continue;
      const entry=entries.find(e=>e.date===ds);
      const expected=suppliersOnDay(dow, suppliers);
      expected.forEach(sup=>{
        if(!entry || entry.supplier_payments?.[sup.id] === undefined) {
          supplierMissingDays[sup.id] = (supplierMissingDays[sup.id]||0) + 1;
        }
      });
    }
  }
  const monthLabel = TODAY.toLocaleDateString("he-IL",{month:"long",year:"numeric"});

  // Supplier alerts
  const supplierAlerts = [];
  for(let d=1; d<=DAY_OF_MONTH; d++){
    const ds=`${YEAR}-${MONTH_STR}-${String(d).padStart(2,"0")}`;
    const entry=entries.find(e=>e.date===ds);
    const dow=getDateDOW(ds);
    if(dow===6) continue; // ×©×‘×ª â€” ×œ× ×¢×•×‘×“×™×
    suppliersOnDay(dow, suppliers).forEach(sup=>{
      const paid=Number(entry?.supplier_payments?.[sup.id]||0);
      if(!paid) supplierAlerts.push({date:ds,day:d,dow,supplier:sup});
    });
  }
  const todayExpected = suppliersOnDay(TODAY_DOW, suppliers);
  const todayMissing = todayExpected.filter(s=>!Number(todayEntry?.supplier_payments?.[s.id]||0));

  if(!loaded) return <div style={{minHeight:"100vh",background:"#F1F5F9",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:12}}><div style={{fontSize:40}}>ğŸ“Š</div><div style={{fontSize:15,color:"#6B7280",fontWeight:600}}>××ª×—×‘×¨ ×œ××¢×¨×›×ª...</div></div>;

  // First time ever â€” no businesses, no users â†’ setup
  if(loaded && businesses.length === 0 && appUsers.length === 0) {
    return (
      <SetupWizard
        initial={businessConfig} initialSuppliers={[]} initialFixed={FIXED_EXPENSES_DEFAULT}
        onComplete={(cfg, sups, fixed, firstOwner) => { completeSetup(cfg, sups, fixed, firstOwner); }}
        onCancel={null} isFirstSetup={true}
      />
    );
  }

  // Login screen
  if(loaded && !loggedInUser) {
    return (
      <LoginScreen
        tenantId={currentBizId || businesses[0]?.id}
        onLogin={async (user)=>{
          setLoggedInUser(user);
          try { const sp = isHashed(user.password)?user.password:await hashPassword(user.password); localStorage.setItem("marjin-session", JSON.stringify({id:user.id, password:sp})); } catch(_){}
          if(businesses.length === 1) setCurrentBizId(businesses[0].id);
          if(user.role==="staff") setScreen("shifts");
        }}
      />
    );
  }

  // Business selector â€” multiple businesses
  if(loaded && loggedInUser && (!currentBizId || showBizSelect) && businesses.length > 1) {
    return (
      <BusinessSelector
        businesses={businesses}
        userName={loggedInUser.name}
        onSelect={(id) => { setCurrentBizId(id); setShowBizSelect(false); }}
        onAdd={() => { setCurrentBizId(null); setShowSetup(true); setShowBizSelect(false); }}
      />
    );
  }

  // Setup for this business
  if(loaded && loggedInUser && currentBizId && (!setupDone || showSetup)) return (
    <SetupWizard
      initial={businessConfig}
      initialSuppliers={suppliers}
      initialFixed={fixedList}
      onComplete={(cfg, sups, fixed, firstOwner) => { completeSetup(cfg, sups, fixed, firstOwner); }}
      onCancel={setupDone ? ()=>setShowSetup(false) : null}
      isFirstSetup={false}
    />
  );

  // Add new business (no currentBizId but user is logged in)
  // Add new business â€” show setup whenever showSetup=true and logged in
  if(loaded && loggedInUser && showSetup) return (
    <SetupWizard
      initial={{businessName:"",rentPct:0,royaltyPct:0,hasRoyalty:false,targets:{salesGrowthPct:5,foodCostPct:33,laborCostPct:27}}}
      initialSuppliers={[]} initialFixed={FIXED_EXPENSES_DEFAULT}
      onComplete={(cfg, sups, fixed) => { completeSetup(cfg, sups, fixed, null); }}
      onCancel={() => { setShowSetup(false); setShowBizSelect(true); }}
      isFirstSetup={false}
    />
  );

  // ×× ××—××© ××—×•×‘×¨ ×•× ××¦× ×‘××¡×š ×©××™×Ÿ ×œ×• ×’×™×©×” â€” ×”×¤× ×” ×œ××©××¨×•×ª
  if(currentUser && screen !== "shifts" && !(currentUser.permissions||[]).includes(screen)) {
    // use effect-like redirect without hooks violation: just render shifts
    return (
      <div dir="rtl" style={S.root}>
        <div style={S.amb1}/><div style={S.amb2}/>
        <header style={S.header}>
          <div>
            <div style={S.badge}>×¢×¡×§ ××³ Â· ×¤×™×™×œ×•×˜</div>
            <h1 style={S.title}>×œ×•×— ×‘×§×¨×” ×™×•××™</h1>
          </div>
          <div style={{fontSize:12,color:"#6B7280",background:"#40404022",padding:"5px 12px",borderRadius:8,border:"1px solid #40404044"}}>
            âš¡ {currentUser.name}
          </div>
        </header>
        <nav style={S.nav}>
          <button style={{...S.navBtn,...S.navShift}} onClick={()=>setScreen("shifts")}>âš¡ ××©××¨×•×ª</button>
          {(currentUser.permissions||[]).map(s=>{
            const lbl={"dashboard":"ğŸ“Š ×¡×§×™×¨×”","forecast":"ğŸ”® ×ª×—×–×™×ª","foodcost":"ğŸ¥— ×¤×•×“ ×§×•×¡×˜","history":"ğŸ“‹ ×”×™×¡×˜×•×¨×™×”","fixed":"ğŸ”’ ×§×‘×•×¢×•×ª"}[s];
            return lbl ? <button key={s} style={{...S.navBtn,...(screen===s?S.navActive:{})}} onClick={()=>setScreen(s)}>{lbl}</button> : null;
          })}
        </nav>
        <ShiftManagerEmbed currentUser={currentUser} setCurrentUser={setCurrentUser} onNavigate={s=>setScreen(s)} appUsers={appUsers} saveAppUsers={saveAppUsers} bizId={currentBizId||""}/>
      </div>
    );
  }

  return (
    <div dir="rtl" style={S.root}>
      <div style={S.amb1}/><div style={S.amb2}/>

      {/* Header */}
      <header style={S.header}>
        <div>
          <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
            <div style={S.badge}>ğŸ“Š {businessConfig.businessName||"×¢×¡×§ ××³"}</div>
            {businesses.length > 1 && <button onClick={()=>setShowBizSelect(true)} style={{fontSize:11,padding:"3px 10px",background:"#F1F5F9",border:"1px solid #D1D5DB",borderRadius:20,cursor:"pointer",fontFamily:"inherit",color:"#6B7280",fontWeight:600}}>×”×—×œ×£ â‡„</button>}
          </div>
          <h1 style={S.title}>×œ×•×— ×‘×§×¨×” ×™×•××™</h1>
          <p style={S.sub}>{monthLabel} Â· {DOW_NAMES[TODAY_DOW]} {DAY_OF_MONTH}/{DAYS_IN_MONTH}</p>
        </div>
        <div style={{display:"flex",flexDirection:"column",gap:6,alignItems:"flex-end"}}>
          {!currentUser && (<>
            <button style={{...S.addBtn,background:"transparent",border:"1px solid #D1D5DB",color:"#6B7280",padding:"9px 14px",fontSize:18}} onClick={()=>setShowSetup(true)} title="×”×’×“×¨×•×ª">âš™ï¸</button>
            <button style={S.addBtn} onClick={()=>{setForm({...EMPTY_ENTRY,date:YESTERDAY_STR,security_event:false});setEditingId(null);setEntryStep('revenue');setScreen("entry");}}>
              <span style={{fontSize:18}}>+</span> ×”×–× ×ª ×™×•×
            </button>
          </>)}
          {currentUser && (
            <div style={{fontSize:13,color:"#6B7280",background:"#F1F5F9",padding:"8px 14px",borderRadius:12,border:"1px solid #E5E7EB",fontWeight:700}}>
              âš¡ {currentUser.name}
            </div>
          )}
          {loggedInUser && !currentUser && (
            <div style={{display:"flex",alignItems:"center",gap:8,marginTop:4}}>
              <div style={{textAlign:"left"}}>
                <div style={{fontSize:12,color:"#111827",fontWeight:700}}>{loggedInUser.name}</div>
                <div style={{fontSize:10,color:"#9CA3AF"}}>{ROLES[loggedInUser.role]?.label||loggedInUser.role}</div>
              </div>
              <button style={{padding:"7px 12px",background:"#FEF2F2",border:"1px solid #FECACA",borderRadius:8,color:"#EF4444",cursor:"pointer",fontFamily:"inherit",fontSize:12,fontWeight:700}}
                onClick={()=>{
                  setLoggedInUser(null);
                  try{localStorage.removeItem("marjin-session");}catch(_){}
                }}>×™×¦×™××”</button>
            </div>
          )}
        </div>
      </header>

      {/* Nav â€” ×©×•×¨×” ×¨××©×•× ×”: 4 ×˜××‘×™× ×¨××©×™×™× | ×©×•×¨×” ×©× ×™×”: ×”×™×¡×˜×•×¨×™×”, ×§×‘×•×¢×•×ª, ××©×™××•×ª */}
      {/* staff ×¨×•××” ×¨×§ ××©××¨×•×ª */}
      {loggedInUser?.role==="staff" && screen!=="shifts" && (() => { setTimeout(()=>setScreen("shifts"),0); return null; })()}
      <nav style={{borderBottom:"1px solid #E5E7EB",position:"relative",zIndex:1}}>
        {/* ×©×•×¨×” 1 */}
        <div style={{display:"flex",padding:"14px 20px 0",gap:2}}>
          <button style={{...S.navBtn,flex:1,textAlign:"center",...(screen==="shifts"?S.navShift:{})}} onClick={()=>setScreen("shifts")}>âš¡ ××©××¨×•×ª</button>
          {[["dashboard","ğŸ“Š ×¡×§×™×¨×”"],["forecast","ğŸ”® ×ª×—×–×™×ª"],["foodcost","ğŸ¥— ×¤×•×“ ×§×•×¡×˜"]].map(([s,l])=>{
            if(loggedInUser?.role==="staff") return null;
            const allowed = !currentUser || (currentUser.permissions||[]).includes(s);
            if(!allowed) return null;
            return <button key={s} style={{...S.navBtn,flex:1,textAlign:"center",...(screen===s?S.navActive:{})}} onClick={()=>setScreen(s)}>{l}</button>;
          })}
        </div>
        {/* ×©×•×¨×” 2 â€” ×”×™×¡×˜×•×¨×™×”, ×§×‘×•×¢×•×ª, ××©×™××•×ª */}
        {(!currentUser && loggedInUser?.role!=="staff") && (
          <div style={{display:"flex",padding:"0 20px",gap:2,borderTop:"1px solid #E5E7EB"}}>
            {[["history","ğŸ“‹ ×”×™×¡×˜×•×¨×™×”"],["fixed","ğŸ”’ ×§×‘×•×¢×•×ª"],["users","ğŸ‘¥ ××©×ª××©×™×"]].map(([s,l])=>(
              <button key={s} style={{...S.navBtn,flex:1,textAlign:"center",fontSize:12,...(screen===s?S.navActive:{})}} onClick={()=>setScreen(s)}>{l}</button>
            ))}
            {(loggedInUser?.role==="super_owner"||loggedInUser?.role==="owner") && (
              <button style={{...S.navBtn,flex:1,textAlign:"center",fontSize:12,...(screen==="tasks"?S.navTasks:{})}} onClick={()=>setScreen("tasks")}>âœ… ××©×™××•×ª</button>
            )}
          </div>
        )}
      </nav>

      {/* â•â•â• DASHBOARD â•â•â• */}
      {screen==="dashboard" && (
        <div style={S.content}>
          <div style={{...S.banner,...(todayEntry?S.bannerOk:S.bannerWarn)}}>
            {todayEntry ? `âœ… ×”×•×–×Ÿ â€” ×”×›× ×¡×•×ª ${fmt((Number(todayEntry.sales)||0)+(Number(todayEntry.deliveries)||0))}` : `â° ×˜×¨× ×”×•×–× ×• × ×ª×•× ×™ ×”×™×•× (${DOW_NAMES[TODAY_DOW]})`}
          </div>
          {todayMissing.length>0 && (
            <div style={S.alertBox}>
              <div style={S.alertTitle}>âš ï¸ ×¡×¤×§×™× ×¦×¤×•×™×™× ×”×™×•× ×©×œ× ×”×•×–× ×•</div>
              <div style={{display:"flex",flexWrap:"wrap",gap:6,marginTop:8}}>
                {todayMissing.map(s=><span key={s.id} style={S.atag}>{s.name}</span>)}
              </div>
            </div>
          )}

          {/* KPIs */}
          {(()=>{
            const tSales  = Math.round((lastYear[MONTH]?.sales||650000)*(1+(cfgTarget(businessConfig,"salesGrowthPct",TARGETS.salesGrowthPct)/100)));
            const tFood   = cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct);
            const tLabor  = cfgTarget(businessConfig,"laborCostPct",TARGETS.laborCostPct);
            const tFixed  = metrics.TOTAL_FIXED;
            // ×¨×•×•×— × ×§×™ ×—×–×•×™ = ×”×›× ×¡×•×ª - ×¤×•×“ - ×œ×™×™×‘×•×¨ - ×¨×©×ª - ×§×‘×•×¢×•×ª
            const fSalesFull = metrics.totalSales + (DAY_OF_MONTH>0 ? (metrics.totalSales/DAY_OF_MONTH)*(DAYS_IN_MONTH-DAY_OF_MONTH) : 0);
            const estProfit  = fSalesFull * (1 - tFood/100 - tLabor/100 - ((businessConfig.rentPct||0)+(businessConfig.hasRoyalty?businessConfig.royaltyPct||0:0))/100) - tFixed;
            const salesPct   = tSales>0 ? Math.round((metrics.totalSales/tSales)*100) : 0;
            const laborPct   = metrics.totalSales>0 ? (metrics.totalPayroll/metrics.totalSales)*100 : 0;
            return (<>
              {/* Target progress bar */}
              <div style={{...S.card,marginBottom:14,borderTop:"2px solid #22C55E"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                  <span style={{fontSize:12,fontWeight:700,color:"#3D5068",textTransform:"uppercase",letterSpacing:1}}>ğŸ¯ ×™×¢×“ {MONTH_NAMES[MONTH]}</span>
                  <span style={{fontSize:16,color:salesPct>=100?"#22C55E":salesPct>=70?"#F59E0B":"#EF4444",fontWeight:900}}>{salesPct}%</span>
                </div>
                <div style={{height:10,background:"#F8FAFC",borderRadius:6,overflow:"hidden",marginBottom:8}}>
                  <div style={{height:"100%",width:`${Math.min(salesPct,100)}%`,
                    background:salesPct>=100?"linear-gradient(90deg,#22C55E,#22C55E)":salesPct>=70?"linear-gradient(90deg,#D97706,#F59E0B)":"linear-gradient(90deg,#EF4444,#EF4444)",
                    borderRadius:6,transition:"width 0.7s cubic-bezier(0.4,0,0.2,1)"}}/>
                </div>
                <div style={{display:"flex",justifyContent:"space-between",fontSize:13}}>
                  <span style={{color:"#6B7280",fontWeight:500}}>×›×™×•×: <b style={{color:"#111827",fontWeight:700}}>{fmt(metrics.totalSales)}</b></span>
                  <span style={{color:"#3D5068",fontWeight:500}}>×™×¢×“: <b style={{color:"#6B7280",fontWeight:700}}>{fmt(tSales)}</b></span>
                </div>
              </div>

              {/* KPI grid */}
              <div style={S.kpiGrid}>
                <KPI icon="ğŸ’µ" label="×”×›× ×¡×•×ª ××•×œ ×™×¢×“"
                  value={fmt(metrics.totalSales)}
                  color={salesPct>=100?"#22C55E":salesPct>=70?"#F59E0B":"#EF4444"}
                  sub={`×™×¢×“ ${fmt(tSales)} Â· ${salesPct}%`}/>
                <KPI icon="ğŸ“Š" label="LC ×™×ª×¨×ª ×§×•×¤×”"
                  value={fmt(metrics.lc)}
                  color={metrics.lc>=0?"#22C55E":"#EF4444"}/>
                <KPI icon="ğŸ¥—" label="×¤×•×“ ×§×•×¡×˜"
                  value={fmtPct(metrics.foodCostPct)}
                  color={fcColor(metrics.foodCostPct,tFood)}
                  sub={`×™×¢×“ ${tFood}%`}/>
                <KPI icon="ğŸ‘·" label="×œ×™×™×‘×•×¨ ×§×•×¡×˜"
                  value={fmtPct(laborPct)}
                  color={fcColor(laborPct,tLabor)}
                  sub={`×™×¢×“ ${tLabor}% Â· ${fmt(metrics.totalPayroll)}`}/>
                <KPI icon="ğŸ¦" label="×¢×œ×•×ª ××™××•×Ÿ"
                  value={fmt(metrics.totalFinancing)}
                  color="#F59E0B"
                  sub="60% Ã— 22% ××”×›× ×¡×•×ª"/>
                <KPI icon="ğŸ”®" label="×ª×—×–×™×ª ×¡×•×£ ×—×•×“×©"
                  value={fmt(metrics.forecast)}
                  color="#A3A3A3"
                  sub={`${DAYS_IN_MONTH-DAY_OF_MONTH} ×™××™× × ×•×ª×¨×•`}/>
                <KPI icon="ğŸ’°" label="×¨×•×•×— × ×§×™ ×—×–×•×™"
                  value={fmt(Math.round(estProfit))}
                  color={estProfit>0?"#22C55E":"#EF4444"}
                  sub={`${fSalesFull>0?fmtPct((estProfit/fSalesFull)*100):"â€”"} ××”××—×–×•×¨`}/>
              </div>
            </>);
          })()}

          {/* â”€â”€â”€ Pikud Ha-Oref Alert Banner â”€â”€â”€ */}
          {orefAlert && (
            <div style={{background:"#DC2626",borderRadius:14,padding:"14px 16px",marginBottom:12,animation:"pulse 1s infinite",display:"flex",alignItems:"center",gap:12}}>
              <span style={{fontSize:28,flexShrink:0}}>ğŸš¨</span>
              <div style={{flex:1}}>
                <div style={{fontWeight:900,color:"#fff",fontSize:15,marginBottom:2}}>××–×¢×§×” ×¤×¢×™×œ×” â€” ×¤×™×§×•×“ ×”×¢×•×¨×£</div>
                <div style={{fontSize:12,color:"#FCA5A5"}}>{orefAlert.cities.slice(0,5).join(" Â· ")}{orefAlert.cities.length>5?` +${orefAlert.cities.length-5} × ×•×¡×¤×•×ª`:""}</div>
                <div style={{fontSize:11,color:"#FCA5A5",marginTop:2}}>{orefAlert.time}</div>
              </div>
            </div>
          )}

          {/* â”€â”€â”€ Weather Card â”€â”€â”€ */}
          {weather && (
            <div style={{background:weather.alert?"#FEF2F2":"#F0F9FF",border:`1px solid ${weather.alert?"#FECACA":"#BAE6FD"}`,borderRadius:14,padding:"12px 16px",marginBottom:12,display:"flex",alignItems:"center",gap:12}}>
              <span style={{fontSize:28}}>{weather.icon}</span>
              <div style={{flex:1}}>
                <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
                  <span style={{fontWeight:800,fontSize:16,color:weather.isHeat?"#DC2626":weather.isRain?"#2563EB":"#111827"}}>{weather.temp}Â°C</span>
                  <span style={{fontSize:13,color:weather.alert?"#DC2626":"#374151",fontWeight:weather.alert?700:400}}>{weather.desc}</span>
                  {weather.rain>0&&<span style={{fontSize:12,color:"#2563EB"}}>ğŸŒ§ {weather.rain}×"×</span>}
                  <span style={{fontSize:12,color:"#9CA3AF"}}>ğŸ’¨ {weather.wind} ×§×"×©</span>
                </div>
                {weather.alert&&<div style={{fontSize:12,color:"#DC2626",fontWeight:700,marginTop:3}}>âš ï¸ {weather.isRain?"×’×©× â€” ×¦×¤×™ ×œ×™×¨×™×“×” ×‘×¤×“×™×•×Ÿ":weather.isHeat?"×—×•× ×§×™×¦×•× ×™ â€” ×”×©×¤×¢×” ×¢×œ ×ª× ×•×¢×ª ×œ×§×•×—×•×ª":"×§×•×¨ ×§×™×¦×•× ×™"}</div>}
              </div>
              <div style={{fontSize:10,color:"#9CA3AF",flexShrink:0}}>Open-Meteo</div>
            </div>
          )}
          {weatherErr && <div style={{background:"#F8FAFC",border:"1px solid #E5E7EB",borderRadius:10,padding:"8px 14px",fontSize:12,color:"#9CA3AF",marginBottom:12}}>âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××–×’ ××•×•×™×¨</div>}

          {chart.length>0 && <>
            <div style={S.card}>
              <h3 style={S.ct}>×™×ª×¨×” ××¦×˜×‘×¨×ª</h3>
              <ResponsiveContainer width="100%" height={160}>
                <AreaChart data={chart}>
                  <defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#22C55E" stopOpacity={0.2}/>
                    <stop offset="95%" stopColor="#22C55E" stopOpacity={0}/>
                  </linearGradient></defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="#2A2A2A"/>
                  <XAxis dataKey="day" stroke="#404040" tick={{fill:"#737373",fontSize:11}}/>
                  <YAxis stroke="#404040" tick={{fill:"#737373",fontSize:11}} tickFormatter={v=>`â‚ª${(v/1000).toFixed(0)}k`}/>
                  <Tooltip contentStyle={TT} formatter={v=>[fmt(v),""]}/>
                  <Area type="monotone" dataKey="×™×ª×¨×”" stroke="#22C55E" fill="url(#g)" strokeWidth={2} dot={false}/>
                </AreaChart>
              </ResponsiveContainer>
            </div>
            <div style={S.card}>
              <h3 style={S.ct}>×”×›× ×¡×•×ª vs ×”×•×¦××•×ª</h3>
              <ResponsiveContainer width="100%" height={140}>
                <BarChart data={chart}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#2A2A2A"/>
                  <XAxis dataKey="day" stroke="#404040" tick={{fill:"#737373",fontSize:11}}/>
                  <YAxis stroke="#404040" tick={{fill:"#737373",fontSize:11}} tickFormatter={v=>`â‚ª${(v/1000).toFixed(0)}k`}/>
                  <Tooltip contentStyle={TT} formatter={v=>[fmt(v),""]}/>
                  <Bar dataKey="×”×›× ×¡×•×ª" fill="#22C55E" radius={[3,3,0,0]}/>
                  <Bar dataKey="×”×•×¦××•×ª" fill="#EF4444" radius={[3,3,0,0]}/>
                </BarChart>
              </ResponsiveContainer>
            </div>
          </>}

          <div style={S.card}>
            <h3 style={S.ct}>×¤×™×¨×•×˜ ×”×•×¦××•×ª</h3>
            <ExpRow label="×¨×›×© ×¡×¤×§×™×" value={metrics.totalFood} total={metrics.totalExpenses} color="#A3A3A3"/>
            <ExpRow label="×©×›×¨" value={metrics.totalPayroll} total={metrics.totalExpenses} color="#A3A3A3"/>
            {businessConfig.hasRoyalty && <ExpRow label={`×ª××œ×•×’×™× ${businessConfig.royaltyPct}%`} value={Math.round(metrics.totalSales*(businessConfig.royaltyPct||0)/100)} total={metrics.totalExpenses} color="#A3A3A3"/>}
            {businessConfig.rentPct>0 && <ExpRow label={`×©×›×´×“ ${businessConfig.rentPct}%`} value={Math.round(metrics.totalSales*(businessConfig.rentPct||0)/100)} total={metrics.totalExpenses} color="#22C55E"/>}
              {businessConfig.rentType==="fixed" && businessConfig.rentFixed>0 && <ExpRow label={`×©×›×´×“ ×§×‘×•×¢`} value={businessConfig.rentFixed} total={metrics.totalExpenses} color="#22C55E"/>}
            <ExpRow label="×”×•×¦××•×ª ×§×‘×•×¢×•×ª" value={metrics.fixedSoFar} total={metrics.totalExpenses} color="#737373"/>
            <ExpRow label="×©×•× ×•×ª" value={metrics.totalOtherExpense} total={metrics.totalExpenses} color="#737373"/>
          </div>
        </div>
      )}

      {/* â•â•â• FOOD COST â•â•â• */}
      {screen==="foodcost" && (
        <div style={S.content}>
          <div style={{display:"flex",gap:6,marginBottom:14}}>
            {[["summary","ğŸ“Š ×¡×™×›×•×"],["by_supplier","âœï¸ ×”×–× ×ª ×¡×¤×§×™×"],["alerts","ğŸ”” ×”×ª×¨××•×ª"]].map(([t,l])=>(
              <button key={t} style={{...S.subBtn,...(fcTab===t?S.subBtnActive:{}),position:"relative"}} onClick={()=>setFcTab(t)}>
                {l}
                {t==="alerts"&&supplierAlerts.length>0&&<span style={S.badge2}>{supplierAlerts.length}</span>}
              </button>
            ))}
          </div>

          {fcTab==="summary" && <>
            <div style={S.kpiGrid}>
              <KPI icon="ğŸ¥—" label="×¤×•×“ ×§×•×¡×˜" value={fmtPct(metrics.foodCostPct)} color={fcColor(metrics.foodCostPct,cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct))} sub={`×™×¢×“ ${cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct)}%`}/>
              <KPI icon="ğŸ›’" label="×¡×”×´×› ×¨×›×©" value={fmt(metrics.totalFood)} color="#A3A3A3"/>
            </div>
            <div style={S.card}>
              <div style={{display:"flex",justifyContent:"space-between",marginBottom:10}}>
                <h3 style={{...S.ct,margin:0}}>××“ ×¤×•×“ ×§×•×¡×˜</h3>
                <span style={{color:fcColor(metrics.foodCostPct,cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct)),fontWeight:800,fontSize:24}}>{fmtPct(metrics.foodCostPct)}</span>
              </div>
              <div style={S.gaugeTrack}>
                <div style={{...S.gaugeFill,width:`${Math.min(metrics.foodCostPct*2,100)}%`,background:fcColor(metrics.foodCostPct,cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct))}}/>
                <div style={{...S.gaugeMarker,left:`${cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct)*2}%`}}/>
              </div>
              <div style={{display:"flex",justifyContent:"space-between",marginTop:5}}>
                <span style={{color:"#9CA3AF",fontSize:11}}>0%</span>
                <span style={{color:"#6B7280",fontSize:11}}>×™×¢×“ {cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct)}% â–²</span>
                <span style={{color:"#9CA3AF",fontSize:11}}>50%+</span>
              </div>
              <p style={{margin:"8px 0 0",fontSize:13,color:fcColor(metrics.foodCostPct,cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct))}}>
                {metrics.foodCostPct===0?"××™×Ÿ × ×ª×•× ×™ ×¨×›×© ×¢×“×™×™×Ÿ":metrics.foodCostPct>cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct)+3?`âš ï¸ ×—×¨×™×’×” ×©×œ ${(metrics.foodCostPct-cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct)).toFixed(1)}%`:metrics.foodCostPct>cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct)?`âš¡ ×¡×˜×™×™×” ×§×œ×”`:  `âœ… ${(cfgTarget(businessConfig,"foodCostPct",TARGETS.foodCostPct)-metrics.foodCostPct).toFixed(1)}% ××ª×—×ª ×œ×™×¢×“`}
              </p>
            </div>
          </>}

          {fcTab==="by_supplier" && (()=>{
            if(suppliers.length===0) return <div style={S.empty}><p style={{color:"#9CA3AF"}}>××™×Ÿ ×¡×¤×§×™× ××•×’×“×¨×™×</p></div>;
            const [smY, smM] = supMonth.split("-").map(Number);
            const smDays = new Date(smY, smM, 0).getDate();
            const smLabel = new Date(smY, smM-1, 1).toLocaleDateString("he-IL",{month:"long",year:"numeric"});
            const prevMonth = () => { const d=new Date(smY,smM-2,1); setSupMonth(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`); setExpandedSup(null); };
            const nextMonth = () => { const d=new Date(smY,smM,1); setSupMonth(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`); setExpandedSup(null); };
            const canNext = smY < YEAR || (smY===YEAR && smM <= MONTH);
            const getSupPay = (supId, date) => {
              const e = entries.find(x=>x.date===date);
              return e?.supplier_payments?.[supId] || "";
            };
            const setSupPayDate = async (supId, date, val) => {
              const existing = entries.find(e=>e.date===date);
              if(existing) {
                const updated = {...existing, supplier_payments:{...(existing.supplier_payments||{}),[supId]:val}};
                const newEntries = entries.map(e=>e.date===date?updated:e);
                setEntries(newEntries);
                await persist(newEntries, fixedList);
              } else {
                const newEntry = {...EMPTY_ENTRY, date, supplier_payments:{[supId]:val}};
                const newEntries = [...entries, newEntry];
                setEntries(newEntries);
                await persist(newEntries, fixedList);
              }
            };
            const monthTotal = suppliers.reduce((total,sup)=>total+Array.from({length:smDays},(_,i)=>{
              const d=String(i+1).padStart(2,"0");
              return Number(getSupPay(sup.id,`${smY}-${String(smM).padStart(2,"0")}-${d}`))||0;
            }).reduce((a,b)=>a+b,0),0);
            return (
              <div>
                <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:14,background:"#FFFFFF",borderRadius:12,padding:"10px 16px",border:"1px solid #E5E7EB"}}>
                  <button onClick={prevMonth} style={{background:"none",border:"none",fontSize:22,cursor:"pointer",color:"#6B7280",padding:"0 8px",lineHeight:1}}>â€¹</button>
                  <span style={{fontWeight:700,color:"#111827",fontSize:15}}>{smLabel}</span>
                  <button onClick={nextMonth} disabled={!canNext} style={{background:"none",border:"none",fontSize:22,cursor:"pointer",color:canNext?"#6B7280":"#D1D5DB",padding:"0 8px",lineHeight:1}}>â€º</button>
                </div>
                {suppliers.map(sup => {
                  const isOpen = expandedSup === sup.id;
                  const supMonthTotal = Array.from({length:smDays},(_,i)=>{
                    const d=String(i+1).padStart(2,"0");
                    return Number(getSupPay(sup.id,`${smY}-${String(smM).padStart(2,"0")}-${d}`))||0;
                  }).reduce((a,b)=>a+b,0);
                  const delivDays = Array.from({length:smDays},(_,i)=>{
                    const day=i+1;
                    const date=`${smY}-${String(smM).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
                    const dow=new Date(smY,smM-1,day).getDay();
                    if(dow===6) return null;
                    if(sup.days.length>0 && !sup.days.includes(dow)) return null;
                    return {day,date,dow};
                  }).filter(Boolean);
                  return (
                    <div key={sup.id} style={{marginBottom:8,background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:14,overflow:"hidden"}}>
                      <div onClick={()=>setExpandedSup(isOpen?null:sup.id)}
                        style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"14px 16px",cursor:"pointer",userSelect:"none"}}>
                        <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
                          <span style={{fontSize:14,fontWeight:700,color:"#111827"}}>{sup.name}</span>
                          <span style={S.catTag}>{sup.category}</span>
                          <span style={{fontSize:11,color:"#9CA3AF"}}>{sup.days.map(d=>DOW_NAMES[d]).join(" ")}</span>
                        </div>
                        <div style={{display:"flex",alignItems:"center",gap:10}}>
                          {supMonthTotal>0 && <span style={{fontWeight:700,color:"#111827",fontSize:14}}>{fmt(supMonthTotal)}</span>}
                          <span style={{fontSize:16,color:"#9CA3AF",display:"inline-block",transition:"transform 0.2s",transform:isOpen?"rotate(180deg)":"none"}}>â–¾</span>
                        </div>
                      </div>
                      {isOpen && (
                        <div style={{borderTop:"1px solid #F1F5F9",padding:"14px 16px"}}>
                          {delivDays.length===0 && <p style={{color:"#9CA3AF",fontSize:13,margin:0}}>××™×Ÿ ×™××™ ××¡×¤×§×” ×‘×—×•×“×© ×–×”</p>}
                          {delivDays.map(({day,date,dow})=>{
                            const val=getSupPay(sup.id,date);
                            const paid=Number(val)>0;
                            return (
                              <div key={date} style={{display:"flex",alignItems:"center",gap:10,marginBottom:10}}>
                                <div style={{minWidth:88}}>
                                  <div style={{fontSize:13,fontWeight:600,color:"#111827"}}>{DOW_NAMES[dow]} {day}/{smM}</div>
                                </div>
                                <input type="number" inputMode="numeric" placeholder="â‚ª"
                                  value={paid?val:""}
                                  onChange={e=>setSupPayDate(sup.id,date,e.target.value)}
                                  style={{flex:1,border:`1px solid ${paid?"#22C55E":"#D1D5DB"}`,borderRadius:10,padding:"9px 12px",fontSize:14,fontFamily:"inherit",color:"#111827",background:paid?"#F0FDF4":"#FFFFFF",outline:"none"}}/>
                                {paid && <span style={{color:"#22C55E",fontSize:16}}>âœ“</span>}
                              </div>
                            );
                          })}
                          <details style={{marginTop:8}}>
                            <summary style={{fontSize:12,color:"#9CA3AF",cursor:"pointer",listStyle:"none",padding:"4px 0"}}>â• ×™×•× ××¡×¤×§×” ×œ× ××ª×•×›× ×Ÿ</summary>
                            <div style={{marginTop:8,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"}}>
                              <input type="date" id={`xd-${sup.id}`} style={{flex:"1 1 120px",border:"1px solid #D1D5DB",borderRadius:10,padding:"9px 12px",fontSize:13,fontFamily:"inherit",color:"#111827"}}/>
                              <input type="number" inputMode="numeric" placeholder="â‚ª" id={`xa-${sup.id}`} style={{flex:"1 1 80px",border:"1px solid #D1D5DB",borderRadius:10,padding:"9px 12px",fontSize:14,fontFamily:"inherit",color:"#111827"}}/>
                              <button onClick={()=>{const d=document.getElementById(`xd-${sup.id}`).value;const a=document.getElementById(`xa-${sup.id}`).value;if(d&&a)setSupPayDate(sup.id,d,a);}}
                                style={{background:"#2563EB",border:"none",borderRadius:10,color:"#fff",padding:"9px 16px",fontWeight:700,cursor:"pointer",fontFamily:"inherit",fontSize:13}}>×”×•×¡×£</button>
                            </div>
                          </details>
                        </div>
                      )}
                    </div>
                  );
                })}
                <div style={{background:"#F8FAFC",borderRadius:12,padding:"12px 16px",display:"flex",justifyContent:"space-between",marginTop:4,border:"1px solid #E5E7EB"}}>
                  <span style={{fontWeight:700,color:"#6B7280"}}>×¡×”×´×› ×¨×›×© {smLabel}</span>
                  <span style={{fontWeight:800,color:"#111827",fontSize:16}}>{fmt(monthTotal)}</span>
                </div>
              </div>
            );
          })()}

          {/* â”€â”€â”€ Weather Impact Analysis â”€â”€â”€ */}
          {fcTab==="summary" && (()=>{
            const impactDays = entries.filter(e=>e.weather_impact||e.security_event);
            if(impactDays.length===0) return null;
            const calcInc = e => (Number(e.sales)||0)+(Number(e.deliveries)||0)+(Number(e.other_income)||0);
            const impactAvg = Math.round(impactDays.reduce((a,e)=>a+calcInc(e),0)/impactDays.length);
            const normalDays = entries.filter(e=>!e.weather_impact&&!e.security_event);
            const normalAvg = normalDays.length>0?Math.round(normalDays.reduce((a,e)=>a+calcInc(e),0)/normalDays.length):0;
            const diff = normalAvg>0?Math.round(((impactAvg-normalAvg)/normalAvg)*100):0;
            return (
              <div style={{...S.card,borderColor:"#FECACA",background:"#FFF8F8"}}>
                <h3 style={{...S.ct,color:"#DC2626"}}>ğŸ”´ ×”×©×¤×¢×ª ×’×•×¨××™× ×—×™×¦×•× ×™×™×</h3>
                <div style={{display:"flex",gap:10,marginBottom:12}}>
                  <div style={{flex:1,background:"#FEF2F2",borderRadius:10,padding:"10px 12px",textAlign:"center"}}>
                    <div style={{fontSize:11,color:"#9CA3AF",marginBottom:4}}>×××•×¦×¢ ×™×•× ×’×©×•×/×‘×™×˜×—×•×Ÿ</div>
                    <div style={{fontWeight:800,fontSize:16,color:"#DC2626"}}>{fmt(impactAvg)}</div>
                    <div style={{fontSize:11,color:"#9CA3AF"}}>{impactDays.length} ×™××™×</div>
                  </div>
                  <div style={{flex:1,background:"#F0FDF4",borderRadius:10,padding:"10px 12px",textAlign:"center"}}>
                    <div style={{fontSize:11,color:"#9CA3AF",marginBottom:4}}>×××•×¦×¢ ×™×•× ×¨×’×™×œ</div>
                    <div style={{fontWeight:800,fontSize:16,color:"#16A34A"}}>{fmt(normalAvg)}</div>
                    <div style={{fontSize:11,color:"#9CA3AF"}}>{normalDays.length} ×™××™×</div>
                  </div>
                </div>
                {normalAvg>0&&<div style={{textAlign:"center",fontSize:13,fontWeight:700,color:diff<0?"#DC2626":"#16A34A"}}>
                  {diff<0?`×™×¨×™×“×” ×©×œ ${Math.abs(diff)}% ×‘×™××™ ×”×©×¤×¢×”`:`×¢×œ×™×™×” ×©×œ ${diff}% ×‘×™××™ ×”×©×¤×¢×”`}
                </div>}
              </div>
            );
          })()}

          {fcTab==="alerts" && (
            supplierAlerts.length===0
              ? <div style={S.empty}><div style={{fontSize:36,marginBottom:8}}>âœ…</div><p style={{color:"#9CA3AF"}}>×”×›×œ ××•×–×Ÿ â€” ××™×Ÿ ×¡×¤×§×™× ×—×¡×¨×™×!</p></div>
              : <div style={S.card}>
                  <h3 style={S.ct}>×¡×¤×§×™× ×—×¡×¨×™× â€” {supplierAlerts.length} ×”×ª×¨××•×ª</h3>
                  <p style={{color:"#9CA3AF",fontSize:13,margin:"0 0 14px"}}>×œ×—×¥ ×¢×œ ×¡×¤×§ ×›×“×™ ×œ×¢×‘×•×¨ ×œ×”×–× ×”</p>
                  {(()=>{
                    const grp={};
                    supplierAlerts.forEach(a=>{
                      if(!grp[a.date]) grp[a.date]={day:a.day,dow:a.dow,sups:[]};
                      grp[a.date].sups.push(a.supplier);
                    });
                    return Object.entries(grp).sort(([a],[b])=>b.localeCompare(a)).map(([date,{day,dow,sups}])=>(
                      <div key={date} style={{marginBottom:10,padding:"10px 12px",background:"#F8FAFC",borderRadius:10,border:"1px solid #D1D5DB"}}>
                        <div style={{fontSize:12,color:"#9CA3AF",marginBottom:7}}>{date} Â· {DOW_NAMES[dow]}</div>
                        <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                          {sups.map(s=>(
                            <span key={s.id} style={{...S.atag,cursor:"pointer"}}
                              onClick={()=>{
                                const existing=entries.find(e=>e.date===date);
                                setEntryStep(existing?'revenue':'revenue');
                                setForm(existing?{...existing}:{...EMPTY_ENTRY,date});
                                setEditingId(existing?entries.indexOf(existing):null);
                                setScreen("entry");
                              }}>
                              {s.name} â†
                            </span>
                          ))}
                        </div>
                      </div>
                    ));
                  })()}
                </div>
          )}
        </div>
      )}

      {/* â•â•â• CREDIT ALERTS â•â•â• */}
      {screen==="dashboard" && pendingCredits.length>0 && (
        <div style={{padding:"0 20px 0"}}>
          {pendingCredits.map(cr=>(
            <div key={cr.id} style={{background:"#FFFBEB",border:"1px solid #FCD34D",borderRadius:12,padding:"12px 16px",marginBottom:8,display:"flex",alignItems:"flex-start",gap:12}}>
              <div style={{fontSize:22,flexShrink:0}}>ğŸ“„</div>
              <div style={{flex:1}}>
                <div style={{fontWeight:700,color:"#92400E",fontSize:14,marginBottom:2}}>
                  ×–×™×›×•×™ ×××ª×™×Ÿ â€” {cr.supplierName}
                </div>
                <div style={{fontSize:12,color:"#B45309",marginBottom:4}}>
                  {fmt(cr.amount)} Â· ××ª××¨×™×š {new Date(cr.date+"T12:00").toLocaleDateString("he-IL")}
                  {cr.note&&` Â· ${cr.note}`}
                </div>
                <div style={{fontSize:11,color:"#9CA3AF"}}>
                  ×××ª×™×Ÿ ×œ×—×©×‘×•× ×™×ª ×–×™×›×•×™ â€” ×œ×—×¥ ×œ×¡×™×•× ×œ××—×¨ ×§×‘×œ×ª ×”××¡××š
                </div>
              </div>
              <button onClick={()=>resolveCredit(cr.id)}
                style={{background:"#22C55E",border:"none",borderRadius:8,color:"#fff",fontFamily:"inherit",fontWeight:700,fontSize:12,padding:"6px 12px",cursor:"pointer",flexShrink:0}}>
                âœ“ ×¡×’×•×¨
              </button>
            </div>
          ))}
        </div>
      )}

      {/* â•â•â• ENTRY â€” STEP 1: REVENUE â•â•â• */}
      {screen==="entry" && entryStep==="revenue" && (
        <div style={S.content}>
          <div style={S.formCard}>
            <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:18}}>
              <div style={{flex:1}}>
                <div style={{fontSize:11,fontWeight:700,color:"#9CA3AF",textTransform:"uppercase",letterSpacing:1.5}}>{editingId!==null?"×¢×¨×™×›×ª ×™×•×":"×”×–× ×ª ×™×•× ×—×“×©"}</div>
                <h2 style={{...S.formTitle,margin:0}}>ğŸ’µ ×”×–× ×ª ×™×•×</h2>
              </div>
              
            </div>

            <label style={S.lbl}>×ª××¨×™×š</label>
            <input style={S.inp} type="date" value={form.date} onChange={e=>setForm(f=>({...f,date:e.target.value}))}/>

            <div style={S.sec}>××›×™×¨×•×ª</div>

            {/* VAT Toggle */}
            <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:14,padding:"10px 14px",background:form.includeVat?"#FFF7ED":"#F0FDF4",border:`1px solid ${form.includeVat?"#FED7AA":"#BBF7D0"}`,borderRadius:12}}>
              <div style={{flex:1}}>
                <div style={{fontSize:13,fontWeight:700,color:"#111827"}}>×¡×›×•××™× {form.includeVat?"×›×•×œ×œ×™×":"××™× × ×›×•×œ×œ×™×"} ××¢×</div>
                <div style={{fontSize:11,color:"#9CA3AF",marginTop:2}}>{form.includeVat?"×”××¢×¨×›×ª ×ª×—×©×‘ × ×˜×• ××•×˜×•××˜×™×ª (Ã·1.18)":"×”×›× ×¡ ×¡×›×•××™× × ×˜×• ×œ×œ× ××¢×´×"}</div>
              </div>
              <button onClick={()=>setForm(f=>({...f,includeVat:!f.includeVat}))}
                style={{padding:"7px 16px",borderRadius:20,border:"none",cursor:"pointer",fontFamily:"inherit",fontWeight:700,fontSize:13,
                  background:form.includeVat?"#F97316":"#22C55E",color:"#fff",minWidth:70}}>
                {form.includeVat?"×¢× ××¢×":"×œ×œ× ××¢×"}
              </button>
            </div>

            <label style={S.lbl}>×§×•×¤×” (â‚ª){form.includeVat?" â€” ×‘×¨×•×˜×• ×¢× ××¢×´×":""}</label>
            <input style={{...S.inp,fontSize:20,fontWeight:700}} type="number" inputMode="numeric" placeholder="0" value={form.sales} onChange={e=>setForm(f=>({...f,sales:e.target.value}))} autoFocus/>
            <label style={S.lbl}>××©×œ×•×—×™× / Wolt / Ten Bis (â‚ª)</label>
            <input style={S.inp} type="number" inputMode="numeric" placeholder="0" value={form.deliveries} onChange={e=>setForm(f=>({...f,deliveries:e.target.value}))}/>
            <label style={S.lbl}>×”×›× ×¡×” ××—×¨×ª (â‚ª)</label>
            <input style={S.inp} type="number" inputMode="numeric" placeholder="0" value={form.other_income} onChange={e=>setForm(f=>({...f,other_income:e.target.value}))}/>

            <div style={S.sec}>×”×•×¦××•×ª ×›×´×</div>
            {(()=>{
              const globalEmps = (businessConfig.employees||[]).filter(e=>Number(e.monthlySalary)>0);
              const globalDaily = globalEmps.reduce((a,e)=>a+Math.round(Number(e.monthlySalary)/DAYS_IN_MONTH),0);
              return (<>
                {globalEmps.length>0 && (
                  <div style={{background:"#F0FDF4",border:"1px solid #BBF7D0",borderRadius:12,padding:"12px 14px",marginBottom:10}}>
                    <div style={{fontSize:11,color:"#16A34A",fontWeight:700,marginBottom:6,textTransform:"uppercase",letterSpacing:1}}>×¢×•×‘×“×™× ×’×œ×•×‘×œ×™ â€” ××•×˜×•××˜×™</div>
                    {globalEmps.map(emp=>(
                      <div key={emp.id} style={{display:"flex",justifyContent:"space-between",fontSize:13,marginBottom:3}}>
                        <span style={{color:"#374151"}}>{emp.name} <span style={{color:"#9CA3AF"}}>{emp.role}</span></span>
                        <span style={{fontWeight:700,color:"#15803D"}}>{Math.round(Number(emp.monthlySalary)/DAYS_IN_MONTH).toLocaleString()} â‚ª</span>
                      </div>
                    ))}
                    <div style={{borderTop:"1px solid #BBF7D0",marginTop:6,paddingTop:6,display:"flex",justifyContent:"space-between",fontSize:13,fontWeight:800,color:"#15803D"}}>
                      <span>×¡×”×´×› ×’×œ×•×‘×œ×™</span><span>{globalDaily.toLocaleString()} â‚ª</span>
                    </div>
                  </div>
                )}
                <label style={S.lbl}>×¢×œ×•×ª ×©×¢×ª×™×™× / × ×•×›×—×•×ª ×™×•××™×ª (â‚ª)</label>
                <input style={S.inp} type="number" inputMode="numeric" placeholder="0" value={form.payroll} onChange={e=>setForm(f=>({...f,payroll:e.target.value}))}/>
                {(globalDaily+(Number(form.payroll)||0))>0 && (
                  <div style={{background:"#F8FAFC",border:"1px solid #E5E7EB",borderRadius:10,padding:"10px 14px",display:"flex",justifyContent:"space-between",fontSize:14,fontWeight:800,marginBottom:8}}>
                    <span style={{color:"#374151"}}>×¡×”×´×› ×©×›×¨ ×”×™×•×</span>
                    <span style={{color:"#111827"}}>{(globalDaily+(Number(form.payroll)||0)).toLocaleString()} â‚ª</span>
                  </div>
                )}
              </>);
            })()}
            <label style={S.lbl}>×”×•×¦××” ××—×¨×ª (â‚ª)</label>
            <input style={S.inp} type="number" inputMode="numeric" placeholder="0" value={form.other_expense} onChange={e=>setForm(f=>({...f,other_expense:e.target.value}))}/>
            {/* Weather impact + security */}
            {(weather?.alert||form.weather_impact||form.security_event) && (
              <div style={{background:"#FEF2F2",border:"1px solid #FECACA",borderRadius:12,padding:"12px 14px",marginBottom:10}}>
                <div style={{fontSize:12,fontWeight:700,color:"#DC2626",marginBottom:8}}>
                  ğŸ”´ ×’×•×¨××™ ×”×©×¤×¢×” ×—×™×¦×•× ×™×™×
                  {orefAlert&&<span style={{marginRight:8,fontSize:11,background:"#DC2626",color:"#fff",borderRadius:6,padding:"1px 8px"}}>××–×¢×§×” ×¤×¢×™×œ×” ×¢×›×©×™×•</span>}
                </div>
                <div style={{display:"flex",gap:8,flexWrap:"wrap",marginBottom:8}}>
                  {[["×’×©×","ğŸŒ§ï¸"],["×—×•× ×§×™×¦×•× ×™","ğŸŒ¡ï¸"],["××–×¢×§×•×ª","ğŸš¨"],["××‘×¦×¢ ×¦×‘××™","âš”ï¸"],["×¤×™×’×•×¢","âš ï¸"],["××—×¨","ğŸ“Œ"]].map(([tag,ic])=>(
                    <button key={tag} onClick={()=>setForm(f=>({...f,weather_impact:f.weather_impact===tag?"":tag}))}
                      style={{padding:"5px 10px",borderRadius:8,border:`1px solid ${form.weather_impact===tag?"#DC2626":"#FECACA"}`,background:form.weather_impact===tag?"#DC2626":"#FEF2F2",color:form.weather_impact===tag?"#fff":"#DC2626",fontSize:12,fontWeight:600,cursor:"pointer",fontFamily:"inherit"}}>
                      {ic} {tag}
                    </button>
                  ))}
                </div>
                <label style={{display:"flex",alignItems:"center",gap:8,fontSize:13,color:"#374151",cursor:"pointer"}}>
                  <input type="checkbox" checked={!!form.security_event} onChange={e=>setForm(f=>({...f,security_event:e.target.checked}))} style={{width:16,height:16}}/>
                  <span>×™×•× ×©×›×œ×œ ××™×¨×•×¢ ×‘×™×˜×—×•× ×™ / ××œ×—××”</span>
                </label>
              </div>
            )}
            {!(weather?.alert||form.weather_impact||form.security_event) && (
              <button onClick={()=>setForm(f=>({...f,weather_impact:"××—×¨"}))}
                style={{width:"100%",background:"none",border:"1px dashed #D1D5DB",borderRadius:10,color:"#9CA3AF",padding:"8px",fontSize:12,cursor:"pointer",fontFamily:"inherit",marginBottom:8}}>
                + ×¡××Ÿ ×”×©×¤×¢×ª ××–×’ ××•×•×™×¨ / ×‘×™×˜×—×•×Ÿ
              </button>
            )}
            <label style={S.lbl}>×”×¢×¨×•×ª</label>
            <textarea style={{...S.inp,minHeight:52,resize:"vertical"}} placeholder="×—×¨×™×’×•×ª, ××™×¨×•×¢×™×..." value={form.notes} onChange={e=>setForm(f=>({...f,notes:e.target.value}))}/>

            {(()=>{
              const rawInc=(Number(form.sales)||0)+(Number(form.deliveries)||0)+(Number(form.other_income)||0);
              const netInc = form.includeVat ? Math.round(rawInc/VAT_RATE) : rawInc;
              if(!rawInc) return null;
              return (
                <div style={{...S.preview,background:"#F0FDF4",border:"1px solid #BBF7D0",marginBottom:4}}>
                  <div style={S.pr}><span style={{fontWeight:600}}>×¡×”×´×› ×”×›× ×¡×•×ª{form.includeVat?" (× ×˜×•)":""}</span><span style={{color:"#22C55E",fontWeight:800,fontSize:16}}>{fmt(netInc)}</span></div>
                </div>
              );
            })()}

            <div style={{display:"flex",gap:10,marginTop:12}}>
              <button style={S.saveBtn} onClick={()=>saveEntry()}>âœ… ×©××•×¨</button>
              <button style={S.cancelBtn} onClick={()=>{setForm({...EMPTY_ENTRY});setEditingId(null);setEntryStep('idle');setScreen("dashboard");}}>×‘×™×˜×•×œ</button>
            </div>
          </div>
        </div>
      )}

      {/* â•â•â• HISTORY â•â•â• */}
      {screen==="history" && (
        <div style={S.content}>
          {entries.length>0 && (
            <div style={{textAlign:"center",marginBottom:10}}>
              <button onClick={()=>{if(window.confirm("×œ××—×•×§ ××ª ×›×œ ×”×¨×©×•××•×ª? ×¤×¢×•×œ×” ×‘×œ×ª×™ ×”×¤×™×›×”")){const u=[];setEntries(u);persist(u,null);}}}
                style={{background:"none",border:"1px solid #FECACA",borderRadius:8,color:"#EF4444",padding:"6px 14px",fontSize:12,cursor:"pointer",fontFamily:"inherit"}}>
                ğŸ—‘ ××—×§ ××ª ×›×œ ×”×¨×©×•××•×ª
              </button>
            </div>
          )}
          {entries.length===0
            ? <div style={S.empty}><div style={{fontSize:44,marginBottom:10}}>ğŸ“‹</div><p style={{color:"#9CA3AF"}}>××™×Ÿ ×¨×©×•××•×ª ×¢×“×™×™×Ÿ</p><button style={S.saveBtn} onClick={()=>{setForm({...EMPTY_ENTRY,date:YESTERDAY_STR,security_event:false});setEditingId(null);setEntryStep('revenue');setScreen("entry");}}>×”×–×Ÿ ×™×•× ×¨××©×•×Ÿ</button></div>
            : [...entries].reverse().map((e,ri)=>{
                const i=entries.length-1-ri;
                const inc=(Number(e.sales)||0)+(Number(e.deliveries)||0)+(Number(e.other_income)||0);
                const supp=e.supplier_payments?Object.values(e.supplier_payments).reduce((a,b)=>a+(Number(b)||0),0):0;
                const hourlyPay=e.hourly_payroll?Object.values(e.hourly_payroll).reduce((a,b)=>a+(Number(b)||0),0):0;
                const exp=supp+(Number(e.payroll)||0)+hourlyPay+(Number(e.other_expense)||0);
                return (
                  <div key={i} style={S.histRow}>
                    <div style={{flex:1}}>
                      <div style={{fontSize:13,color:"#6B7280",marginBottom:5}}>{e.date} Â· {DOW_NAMES[getDateDOW(e.date)]}
                          {e.weather_impact&&<span style={{marginRight:6,fontSize:11,background:"#FEF2F2",border:"1px solid #FECACA",borderRadius:6,padding:"1px 6px",color:"#DC2626",fontWeight:600}}>ğŸ”´ {e.weather_impact}</span>}
                          {e.security_event&&<span style={{marginRight:6,fontSize:11,background:"#FEF2F2",border:"1px solid #FECACA",borderRadius:6,padding:"1px 6px",color:"#7C3AED",fontWeight:600}}>âš”ï¸ ×‘×™×˜×—×•×Ÿ</span>}
                        </div>
                      <div style={{display:"flex",gap:14,fontSize:13,flexWrap:"wrap"}}>
                        <span style={{color:"#22C55E"}}>â¬† {fmt(inc)}</span>
                        <span style={{color:"#EF4444"}}>â¬‡ {fmt(exp)}</span>
                        <span style={{color:inc-exp>=0?"#22C55E":"#EF4444",fontWeight:700}}>{fmt(inc-exp)}</span>
                      </div>
                      {supp>0&&<div style={{fontSize:12,color:"#9CA3AF",marginTop:3}}>ğŸ­ ×¡×¤×§×™×: {fmt(supp)}</div>}
                      {e.notes&&<p style={{margin:"4px 0 0",color:"#9CA3AF",fontSize:12,fontStyle:"italic"}}>{e.notes}</p>}
                    </div>
                    <div style={{display:"flex",flexDirection:"column",gap:5}}>
                      <button style={S.iconBtn} onClick={()=>{setForm({...e});setEditingId(i);setEntryStep('revenue');setScreen("entry");}}>âœï¸</button>
                      <button style={S.iconBtn} onClick={()=>deleteEntry(i)}>ğŸ—‘</button>
                    </div>
                  </div>
                );
              })
          }
        </div>
      )}

      {/* â•â•â• FORECAST â•â•â• */}
      {screen==="forecast" && (
        <div style={S.content}>
          <ForecastScreen entries={entries} businessConfig={businessConfig} metrics={metrics} lastYear={lastYear} saveLastYear={saveLastYear} currentMonth={MONTH} />
        </div>
      )}

      {/* â•â•â• SHIFTS â•â•â• */}
      {screen==="shifts" && (
        <ShiftManagerEmbed
          currentUser={currentUser}
          setCurrentUser={setCurrentUser}
          onNavigate={s=>setScreen(s)}
          appUsers={appUsers}
          saveAppUsers={saveAppUsers}
          bizId={currentBizId||""}
        />
      )}

      {/* â•â•â• TASKS (×‘×¢×œ×™× ×‘×œ×‘×“) â•â•â• */}
      {screen==="tasks" && !currentUser && (
        <div style={S.content}>
          <MasterTasksScreen
            tasks={masterTasks}
            saveTasks={saveMasterTasks}
          />
        </div>
      )}

      {/* â•â•â• USERS â•â•â• */}
      {screen==="users" && !currentUser && (
        <div style={S.content}>
          <div style={S.card}>
            <h2 style={{...S.ct,fontSize:15,color:"#111827",marginBottom:16}}>ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™×</h2>
            <UserManagement users={appUsers} saveUsers={saveAppUsers}/>
          </div>
        </div>
      )}

      {/* â•â•â• FIXED â•â•â• */}
      {screen==="fixed" && (
        <div style={S.content}>
          <div style={S.card}>
            <h2 style={{...S.ct,fontSize:15,color:"#111827",marginBottom:8}}>×”×•×¦××•×ª ×§×‘×•×¢×•×ª ×—×•×“×©×™×•×ª</h2>
            <p style={{color:"#9CA3AF",fontSize:13,margin:"0 0 14px"}}>×©×›×´×“ ××—×•×©×‘ ××•×˜×•××˜×™×ª ×œ×¤×™ {businessConfig.rentType==="fixed" ? `${(businessConfig.rentFixed||0).toLocaleString()} â‚ª ×§×‘×•×¢` : `${businessConfig.rentPct||0}% ×××—×–×•×¨`}.</p>
            {fixedList.map((f,i)=>(
              <div key={f.id} style={{marginBottom:8,padding:"10px 12px",background:"#F8FAFC",borderRadius:10,border:"1px solid #0A0A0A"}}>
                <div style={{display:"flex",gap:8,alignItems:"center",marginBottom:6}}>
                  {f.rentPct&&<span style={{fontSize:10,color:"#22C55E",background:"#16653444",padding:"1px 7px",borderRadius:8,flexShrink:0}}>ğŸ”— {businessConfig.rentType==="fixed"?`${(businessConfig.rentFixed||0).toLocaleString()}â‚ª`:`${businessConfig.rentPct||0}%`}</span>}
                  {f.royaltyPct&&businessConfig.hasRoyalty&&<span style={{fontSize:10,color:"#6B7280",background:"#40404044",padding:"1px 7px",borderRadius:8,flexShrink:0}}>ğŸ”— {businessConfig.royaltyPct||0}%</span>}
                  <input style={{...S.inp,marginBottom:0,flex:1,padding:"6px 10px",fontSize:13}} value={f.name}
                    onChange={e=>{const u=fixedList.map((x,j)=>j===i?{...x,name:e.target.value}:x);setFixedList(u);persist(entries,u);}}/>
                </div>
                <div style={{display:"flex",gap:8,alignItems:"center"}}>
                  {f.rentPct
                    ? <div style={{...S.inp,padding:"6px 10px",flex:1,marginBottom:0,color:"#22C55E",fontSize:13}}>â‰ˆ {businessConfig.rentType==="fixed"?fmt(businessConfig.rentFixed||0):fmt(Math.round(metrics.totalSales*(businessConfig.rentPct||0)/100))}</div>
                    : f.royaltyPct
                    ? <div style={{...S.inp,padding:"6px 10px",flex:1,marginBottom:0,color:"#6B7280",fontSize:13}}>â‰ˆ {fmt(Math.round(metrics.totalSales*(businessConfig.royaltyPct||0)/100))}</div>
                    : <input style={{...S.inp,padding:"6px 10px",flex:1,marginBottom:0}} type="number" placeholder="â‚ª" value={f.amount||""}
                        onChange={e=>{const u=fixedList.map((x,j)=>j===i?{...x,amount:Number(e.target.value)}:x);setFixedList(u);persist(entries,u);}}/>
                  }
                  <div style={{display:"flex",alignItems:"center",gap:4,flexShrink:0}}>
                    <span style={{color:"#9CA3AF",fontSize:12}}>×™×•×</span>
                    <input style={{...S.inp,padding:"6px 8px",width:50,marginBottom:0,textAlign:"center"}} type="number" min={1} max={31} value={f.dueDay}
                      onChange={e=>{const u=fixedList.map((x,j)=>j===i?{...x,dueDay:Number(e.target.value)}:x);setFixedList(u);persist(entries,u);}}/>
                  </div>
                </div>
              </div>
            ))}
            <button style={{...S.saveBtn,marginTop:6}} onClick={()=>{const u=[...fixedList,{id:Date.now(),name:"×”×•×¦××” ×—×“×©×”",amount:0,dueDay:1,rentPct:false}];setFixedList(u);persist(entries,u);}}>+ ×”×•×¡×£</button>
            <div style={{borderTop:"1px solid #0A0A0A",marginTop:14,paddingTop:12,display:"flex",justifyContent:"space-between"}}>
              <span style={{color:"#6B7280"}}>×¡×”×´×› ×—×•×“×©×™ (××©×•×¢×¨)</span>
              <span style={{color:"#111827",fontWeight:700,fontSize:18}}>{fmt(metrics.TOTAL_FIXED)}</span>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}


// â”€â”€â”€ Employees Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function EmployeesScreen({ businessConfig, saveBusinessConfig }) {
  const employees = businessConfig.employees || [];
  const ROLES_EMP = ["×× ×”×œ ××©××¨×ª","×˜×‘×—","×¢×•×–×¨ ×˜×‘×—","××œ×¦×¨","×‘×¨××Ÿ","×§×•×¤××™","×›×œ×™×","× ×™×§×™×•×Ÿ","××—×¨"];
  const EMP_TYPES = [{v:"global",l:"ğŸ”’ ×’×œ×•×‘×œ×™ (×—×•×“×©×™ ×§×‘×•×¢)"},{v:"hourly",l:"â± ×©×¢×ª×™ (×”×–× ×” ×™×•××™×ª)"}];
  const [adding, setAdding] = useState(false);
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState({name:"",role:"××œ×¦×¨",type:"global",monthlySalary:"",hourlyRate:"",hoursPerMonth:""});

  const totalMonthly = employees.reduce((a,e)=>{
    if(e.monthlySalary) return a + (Number(e.monthlySalary)||0);
    if(e.hourlyRate && e.hoursPerMonth) return a + Math.round((Number(e.hourlyRate)||0)*(Number(e.hoursPerMonth)||0));
    return a;
  },0);

  const saveEmp = () => {
    if(!form.name.trim()) return;
    let updated;
    if(editId !== null) {
      updated = employees.map(e=>e.id===editId?{...e,...form}:e);
    } else {
      updated = [...employees, {...form, id:Date.now()}];
    }
    saveBusinessConfig({...businessConfig, employees:updated});
    setAdding(false); setEditId(null); setForm({name:"",role:"××œ×¦×¨",type:"global",monthlySalary:"",hourlyRate:"",hoursPerMonth:""});
  };

  const removeEmp = id => saveBusinessConfig({...businessConfig, employees:employees.filter(e=>e.id!==id)});

  const startEdit = emp => {
    setForm({name:emp.name,role:emp.role,type:emp.type||"global",monthlySalary:emp.monthlySalary||"",hourlyRate:emp.hourlyRate||"",hoursPerMonth:emp.hoursPerMonth||""});
    setEditId(emp.id); setAdding(true);
  };

  const fmtEmpSalary = emp => {
    if(emp.type==="hourly") return "â± ×”×–× ×” ×™×•××™×ª";
    if(emp.monthlySalary) return `${Number(emp.monthlySalary).toLocaleString()} â‚ª/×—×•×“×©`;
    return "â€”";
  };

  const inp = {width:"100%",border:"1px solid #D1D5DB",borderRadius:10,padding:"10px 12px",fontSize:14,fontFamily:"inherit",color:"#111827",background:"#FFFFFF",marginBottom:10,boxSizing:"border-box"};
  const sel = {...inp};

  return (
    <div style={{maxWidth:500,margin:"0 auto"}}>
      <div style={{background:"#FFFFFF",borderRadius:16,border:"1px solid #E5E7EB",padding:"18px 16px",marginBottom:12}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <div>
            <h2 style={{margin:0,fontSize:16,fontWeight:800,color:"#111827"}}>ğŸ‘¤ ×¢×•×‘×“×™×</h2>
            <div style={{fontSize:12,color:"#9CA3AF",marginTop:2}}>{employees.length} ×¢×•×‘×“×™× Â· ×¡×”×´×›: {totalMonthly.toLocaleString()} â‚ª/×—×•×“×©</div>
          </div>
          <button onClick={()=>{setAdding(true);setEditId(null);setForm({name:"",role:"××œ×¦×¨",type:"global",monthlySalary:"",hourlyRate:"",hoursPerMonth:""}); }}
            style={{background:"#2563EB",border:"none",borderRadius:10,color:"#fff",padding:"8px 16px",fontWeight:700,cursor:"pointer",fontFamily:"inherit",fontSize:13}}>+ ×”×•×¡×£</button>
        </div>

        {employees.length===0 && !adding && (
          <div style={{textAlign:"center",padding:"24px 0",color:"#9CA3AF",fontSize:14}}>××™×Ÿ ×¢×•×‘×“×™× ××•×’×“×¨×™× ×¢×“×™×™×Ÿ</div>
        )}

        {employees.map(emp=>(
          <div key={emp.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 14px",background:"#F8FAFC",borderRadius:12,marginBottom:8,border:"1px solid #E5E7EB"}}>
            <div>
              <div style={{fontWeight:700,color:"#111827",fontSize:14}}>{emp.name}</div>
              <div style={{fontSize:12,color:"#6B7280",marginTop:2}}>{emp.role} Â· {fmtEmpSalary(emp)}</div>
            </div>
            <div style={{display:"flex",gap:6}}>
              <button onClick={()=>startEdit(emp)} style={{background:"#F1F5F9",border:"1px solid #E5E7EB",borderRadius:8,padding:"5px 10px",cursor:"pointer",fontFamily:"inherit",fontSize:12,color:"#374151"}}>âœï¸</button>
              <button onClick={()=>removeEmp(emp.id)} style={{background:"#FEF2F2",border:"1px solid #FECACA",borderRadius:8,padding:"5px 10px",cursor:"pointer",fontFamily:"inherit",fontSize:12,color:"#EF4444"}}>âœ•</button>
            </div>
          </div>
        ))}

        {adding && (
          <div style={{background:"#EFF6FF",borderRadius:14,padding:"16px",border:"1px solid #BFDBFE",marginTop:8}}>
            <div style={{fontWeight:700,color:"#1D4ED8",fontSize:14,marginBottom:12}}>{editId!==null?"×¢×¨×™×›×ª ×¢×•×‘×“":"×¢×•×‘×“ ×—×“×©"}</div>
            <input style={inp} placeholder="×©× ×¢×•×‘×“" value={form.name} onChange={e=>setForm(f=>({...f,name:e.target.value}))} autoFocus/>
            <select style={sel} value={form.role} onChange={e=>setForm(f=>({...f,role:e.target.value}))}>
              {ROLES_EMP.map(r=><option key={r} value={r}>{r}</option>)}
            </select>
            <div style={{display:"flex",gap:6,marginBottom:12}}>
              {EMP_TYPES.map(t=>(
                <button key={t.v} onClick={()=>setForm(f=>({...f,type:t.v}))}
                  style={{flex:1,padding:"9px 8px",borderRadius:10,border:`2px solid ${form.type===t.v?"#2563EB":"#E5E7EB"}`,background:form.type===t.v?"#EFF6FF":"#FFFFFF",color:form.type===t.v?"#1D4ED8":"#6B7280",fontWeight:700,cursor:"pointer",fontFamily:"inherit",fontSize:12}}>
                  {t.l}
                </button>
              ))}
            </div>
            {form.type==="global" && (
              <>
                <div style={{fontSize:11,color:"#9CA3AF",marginBottom:4}}>××©×›×•×¨×ª ×—×•×“×©×™×ª ×‘×¨×•×˜×• (â‚ª)</div>
                <input style={{...inp}} type="number" inputMode="numeric" placeholder="0"
                  value={form.monthlySalary} onChange={e=>setForm(f=>({...f,monthlySalary:e.target.value}))}/>
                {form.monthlySalary && (
                  <div style={{background:"#DBEAFE",borderRadius:8,padding:"8px 12px",fontSize:13,color:"#1D4ED8",fontWeight:600,marginBottom:10}}>
                    ×¢×œ×•×ª ×™×•××™×ª: â‰ˆ {Math.round(Number(form.monthlySalary)/DAYS_IN_MONTH).toLocaleString()} â‚ª/×™×•× (Ã·{DAYS_IN_MONTH})
                  </div>
                )}
              </>
            )}
            {form.type==="hourly" && (
              <div style={{background:"#F0FDF4",borderRadius:10,padding:"10px 12px",fontSize:13,color:"#16A34A",marginBottom:10}}>
                ×¢×œ×•×ª ×™×•××™×ª ×ª×•×–×Ÿ ×™×“× ×™×ª ×‘×›×œ ×™×•× ×‘×˜×•×¤×¡ ×”×”×–× ×”
              </div>
            )}
            <div style={{display:"flex",gap:8}}>
              <button onClick={saveEmp} style={{flex:1,background:"#2563EB",border:"none",borderRadius:10,color:"#fff",padding:"11px",fontWeight:700,cursor:"pointer",fontFamily:"inherit",fontSize:14}}>×©××•×¨</button>
              <button onClick={()=>{setAdding(false);setEditId(null);}} style={{flex:1,background:"#F1F5F9",border:"1px solid #E5E7EB",borderRadius:10,color:"#6B7280",padding:"11px",fontWeight:600,cursor:"pointer",fontFamily:"inherit",fontSize:14}}>×‘×™×˜×•×œ</button>
            </div>
          </div>
        )}

        {totalMonthly > 0 && (
          <div style={{borderTop:"1px solid #E5E7EB",marginTop:14,paddingTop:12,display:"flex",justifyContent:"space-between"}}>
            <span style={{color:"#6B7280",fontWeight:600}}>×¡×”×´×› ×¢×œ×•×ª ×©×›×¨ ×—×•×“×©×™×ª</span>
            <span style={{color:"#111827",fontWeight:800,fontSize:16}}>{totalMonthly.toLocaleString()} â‚ª</span>
          </div>
        )}
      </div>
      {/* â•â•â• EMPLOYEES â•â•â• */}
      {screen==="employees" && (
        <div style={S.content}>
          <EmployeesScreen businessConfig={businessConfig} saveBusinessConfig={saveBusinessConfig}/>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ Master Tasks Screen (×‘×¢×œ×™× ×™×©×™×¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function MasterTasksScreen({ tasks, saveTasks }) {
  const [adding, setAdding]   = useState(false);
  const [editing, setEditing] = useState(null); // task id being edited
  const [form, setForm]       = useState({ title:"", category:"×¤×ª×™×—×”", shift:"×›×œ ×”××©××¨×•×ª", note:"" });
  const [filterShift, setFilterShift] = useState("×”×›×œ");
  const [filterCat,   setFilterCat]   = useState("×”×›×œ");

  const openAdd = () => { setForm({ title:"", category:"×¤×ª×™×—×”", shift:"×›×œ ×”××©××¨×•×ª", note:"", proof:"check" }); setEditing(null); setAdding(true); };
  const openEdit = (t) => { setForm({ title:t.title, category:t.category, shift:t.shift, note:t.note||"", proof:t.proof||"check" }); setEditing(t.id); setAdding(true); };
  const cancel = () => { setAdding(false); setEditing(null); };

  const save = () => {
    if (!form.title.trim()) return;
    if (editing !== null) {
      saveTasks(tasks.map(t => t.id===editing ? {...t,...form} : t));
    } else {
      saveTasks([...tasks, {...form, id:Date.now()}]);
    }
    setAdding(false); setEditing(null);
  };

  const remove = (id) => saveTasks(tasks.filter(t => t.id !== id));

  const moveUp   = (i, arr) => { if(i===0) return arr; const a=[...arr]; [a[i-1],a[i]]=[a[i],a[i-1]]; return a; };
  const moveDown = (i, arr) => { if(i===arr.length-1) return arr; const a=[...arr]; [a[i],a[i+1]]=[a[i+1],a[i]]; return a; };

  const filtered = tasks.filter(t =>
    (filterShift==="×”×›×œ" || t.shift===filterShift) &&
    (filterCat==="×”×›×œ"   || t.category===filterCat)
  );

  const CAT_COLOR = {"×¤×ª×™×—×”":"#22C55E","×©×•×˜×£":"#F59E0B","×¡×’×™×¨×”":"#EF4444"};
  const CAT_BG    = {"×¤×ª×™×—×”":"#16653433","×©×•×˜×£":"#78350F33","×¡×’×™×¨×”":"#7F1D1D33"};

  return (
    <div>
      {/* Summary bar */}
      <div style={{display:"flex",gap:8,marginBottom:14,flexWrap:"wrap",alignItems:"center"}}>
        <div style={{flex:1}}>
          <h2 style={{margin:0,fontSize:17,fontWeight:800,color:"#111827"}}>âœ… × ×™×”×•×œ ××©×™××•×ª</h2>
          <p style={{margin:"2px 0 0",fontSize:12,color:"#9CA3AF"}}>
            {tasks.length} ××©×™××•×ª Â· ×‘×•×§×¨: {tasks.filter(t=>t.shift==="×‘×•×§×¨"||t.shift==="×›×œ ×”××©××¨×•×ª").length} Â· ×¢×¨×‘: {tasks.filter(t=>t.shift==="×¢×¨×‘"||t.shift==="×›×œ ×”××©××¨×•×ª").length}
          </p>
        </div>
        <button style={{...S.addBtn, fontSize:13, padding:"8px 14px"}} onClick={openAdd}>+ ×”×•×¡×£ ××©×™××”</button>
      </div>

      {/* Filters */}
      <div style={{display:"flex",gap:6,marginBottom:12,flexWrap:"wrap"}}>
        {["×”×›×œ","×›×œ ×”××©××¨×•×ª","×‘×•×§×¨","×¢×¨×‘"].map(s=>(
          <button key={s} style={{...S.subBtn,...(filterShift===s?S.subBtnActive:{})}} onClick={()=>setFilterShift(s)}>{s}</button>
        ))}
        <div style={{width:1,background:"#2A2A2A",margin:"0 2px"}}/>
        {["×”×›×œ","×¤×ª×™×—×”","×©×•×˜×£","×¡×’×™×¨×”"].map(c=>(
          <button key={c} style={{...S.subBtn,...(filterCat===c?{...S.subBtnActive,color:c==="×”×›×œ"?"#F5F5F5":CAT_COLOR[c]}:{})}} onClick={()=>setFilterCat(c)}>{c}</button>
        ))}
      </div>

      {/* Add / Edit form */}
      {adding && (
        <div style={{...S.card, border:"1px solid #15803D44", marginBottom:14}}>
          <h3 style={{margin:"0 0 12px", fontSize:14, fontWeight:700, color:"#111827"}}>
            {editing ? "âœï¸ ×¢×¨×™×›×ª ××©×™××”" : "â• ××©×™××” ×—×“×©×”"}
          </h3>
          <label style={S.lbl}>×©× ×”××©×™××”</label>
          <input style={S.inp} autoFocus placeholder="×œ××©×œ: × ×™×§×•×™ ××›×•× ×ª ×§×¤×”" value={form.title}
            onChange={e=>setForm(f=>({...f,title:e.target.value}))}
            onKeyDown={e=>e.key==="Enter"&&save()}/>
          <div style={{display:"flex",gap:8,marginBottom:8}}>
            <div style={{flex:1}}>
              <label style={S.lbl}>×§×˜×’×•×¨×™×”</label>
              <select style={{...S.inp,marginBottom:0}} value={form.category} onChange={e=>setForm(f=>({...f,category:e.target.value}))}>
                {["×¤×ª×™×—×”","×©×•×˜×£","×¡×’×™×¨×”"].map(c=><option key={c}>{c}</option>)}
              </select>
            </div>
            <div style={{flex:1}}>
              <label style={S.lbl}>××©××¨×ª</label>
              <select style={{...S.inp,marginBottom:0}} value={form.shift} onChange={e=>setForm(f=>({...f,shift:e.target.value}))}>
                {["×›×œ ×”××©××¨×•×ª","×‘×•×§×¨","×¢×¨×‘"].map(s=><option key={s}>{s}</option>)}
              </select>
            </div>
          </div>
          <label style={S.lbl}>×”×¢×¨×” / ×”×•×¨××•×ª</label>
          <input style={S.inp} placeholder="×¤×¨×˜×™× × ×•×¡×¤×™× ×œ××—××©..." value={form.note}
            onChange={e=>setForm(f=>({...f,note:e.target.value}))}/>

          <label style={{...S.lbl, marginBottom:6}}>××™×©×•×¨ ×‘×™×¦×•×¢</label>
          <div style={{display:"flex",gap:8,marginBottom:12}}>
            {[
              {val:"check", icon:"âœ…", label:"×¡×™××•×Ÿ ×‘×œ×‘×“"},
              {val:"photo", icon:"ğŸ“¸", label:"×—×•×‘×” ×œ×¦×œ×"},
            ].map(opt=>(
              <button key={opt.val} onClick={()=>setForm(f=>({...f,proof:opt.val}))}
                style={{flex:1,padding:"10px 8px",borderRadius:10,border:"none",cursor:"pointer",fontFamily:"inherit",
                  background:form.proof===opt.val?"#15803D":"#0A0A0A",
                  border:form.proof===opt.val?"2px solid #22C55E":"2px solid #D1D5DB",
                  color:form.proof===opt.val?"#fff":"#525252",fontWeight:700,fontSize:13,transition:"all 0.15s"}}>
                <div style={{fontSize:20,marginBottom:3}}>{opt.icon}</div>
                {opt.label}
              </button>
            ))}
          </div>
          <div style={{display:"flex",gap:8,marginTop:4}}>
            <button style={S.saveBtn} onClick={save}>{editing?"×¢×“×›×Ÿ":"×”×•×¡×£"}</button>
            <button style={S.cancelBtn} onClick={cancel}>×‘×™×˜×•×œ</button>
          </div>
        </div>
      )}

      {/* Tasks list grouped by category */}
      {filtered.length === 0 && !adding && (
        <div style={S.empty}>
          <div style={{fontSize:40,marginBottom:10}}>âœ…</div>
          <p style={{color:"#9CA3AF"}}>××™×Ÿ ××©×™××•×ª â€” ×œ×—×¥ + ×”×•×¡×£ ××©×™××”</p>
        </div>
      )}

      {["×¤×ª×™×—×”","×©×•×˜×£","×¡×’×™×¨×”"].map(cat => {
        const catTasks = filtered.filter(t => t.category===cat);
        if (!catTasks.length) return null;
        return (
          <div key={cat} style={{marginBottom:16}}>
            {/* Category header */}
            <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:8}}>
              <span style={{fontSize:12,fontWeight:700,padding:"3px 12px",borderRadius:20,color:CAT_COLOR[cat],background:CAT_BG[cat]}}>
                {cat}
              </span>
              <span style={{fontSize:11,color:"#9CA3AF"}}>{catTasks.length} ××©×™××•×ª</span>
            </div>
            {/* Task rows */}
            {catTasks.map((t, ci) => {
              const globalIdx = tasks.indexOf(t);
              return (
                <div key={t.id} style={{
                  display:"flex", alignItems:"flex-start", gap:10,
                  padding:"11px 13px", marginBottom:7,
                  background:"#FFFFFF", border:"1px solid #0A0A0A", borderRadius:11,
                  borderRight:`3px solid ${CAT_COLOR[cat]}44`
                }}>
                  {/* Drag order */}
                  <div style={{display:"flex",flexDirection:"column",gap:2,paddingTop:2}}>
                    <button style={{...S.iconBtn,padding:"2px 6px",fontSize:10,color:"#9CA3AF"}}
                      onClick={()=>saveTasks(moveUp(globalIdx,tasks))}>â–²</button>
                    <button style={{...S.iconBtn,padding:"2px 6px",fontSize:10,color:"#9CA3AF"}}
                      onClick={()=>saveTasks(moveDown(globalIdx,tasks))}>â–¼</button>
                  </div>
                  {/* Content */}
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontSize:14,color:"#111827",fontWeight:600,marginBottom:3}}>{t.title}</div>
                    <div style={{display:"flex",gap:6,flexWrap:"wrap",alignItems:"center"}}>
                      <span style={{fontSize:11,color:"#9CA3AF",background:"#F8FAFC",padding:"1px 7px",borderRadius:8}}>{t.shift}</span>
                      {t.proof==="photo" && <span style={{fontSize:11,color:"#6B7280",background:"#1C1C1C44",padding:"1px 7px",borderRadius:8}}>ğŸ“¸ ×—×•×‘×” ×œ×¦×œ×</span>}
                      {t.note && <span style={{fontSize:11,color:"#9CA3AF",fontStyle:"italic"}}>{t.note}</span>}
                    </div>
                  </div>
                  {/* Actions */}
                  <div style={{display:"flex",gap:5,flexShrink:0}}>
                    <button style={{...S.iconBtn,fontSize:12}} onClick={()=>openEdit(t)}>âœï¸</button>
                    <button style={{...S.iconBtn,fontSize:12}} onClick={()=>remove(t.id)}>ğŸ—‘</button>
                  </div>
                </div>
              );
            })}
          </div>
        );
      })}

      {/* Shift preview */}
      {tasks.length > 0 && (
        <div style={{...S.card, marginTop:8, borderTop:"1px solid #D1D5DB"}}>
          <div style={{fontSize:11,fontWeight:700,color:"#9CA3AF",textTransform:"uppercase",letterSpacing:1,marginBottom:10}}>
            ğŸ‘ ×›×š ×™×¨××” ×”××—××©
          </div>
          <div style={{display:"flex",gap:8}}>
            {["×‘×•×§×¨","×¢×¨×‘"].map(shift=>(
              <div key={shift} style={{flex:1,background:"#F8FAFC",borderRadius:10,padding:"10px 12px"}}>
                <div style={{fontSize:12,fontWeight:700,color:"#6B7280",marginBottom:8}}>{shift}</div>
                {tasks.filter(t=>t.shift===shift||t.shift==="×›×œ ×”××©××¨×•×ª").length === 0
                  ? <div style={{fontSize:11,color:"#1C1C1C"}}>××™×Ÿ ××©×™××•×ª</div>
                  : tasks.filter(t=>t.shift===shift||t.shift==="×›×œ ×”××©××¨×•×ª").map(t=>(
                    <div key={t.id} style={{display:"flex",alignItems:"center",gap:7,marginBottom:5}}>
                      <div style={{width:14,height:14,borderRadius:4,border:`2px solid ${CAT_COLOR[t.category]}55`,flexShrink:0}}/>
                      <span style={{fontSize:12,color:"#6B7280"}}>{t.title}</span>
                    </div>
                  ))
                }
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ Shift Manager (Inline Tab) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SM_SHIFTS    = ["×‘×•×§×¨","×¢×¨×‘"];
const SM_CATS      = ["×¤×ª×™×—×”","×©×•×˜×£","×¡×’×™×¨×”"];
const SM_CAT_COLOR = {"×¤×ª×™×—×”":"#22C55E","×©×•×˜×£":"#6B7280","×¡×’×™×¨×”":"#EF4444"};
const SM_CAT_BG    = {"×¤×ª×™×—×”":"#22C55E12","×©×•×˜×£":"#F5F5F508","×¡×’×™×¨×”":"#EF444412"};

// PERMISSIONS â€” ××” ×›×œ ×ª×¤×§×™×“ ×™×›×•×œ ×œ×’×©×ª
// ×‘×¢×ª×™×“: ×œ×”×•×¡×™×£ { id, name, permissions:["dashboard","forecast",...] } ×œ×›×œ ×× ×”×œ
// ×›×¨×’×¢: ×× ×”×œ×™× ×¨×•××™× ×¨×§ âš¡ ××©××¨×•×ª. ×‘×¢×œ×™× ×¨×•××” ×”×›×œ.

function ShiftManagerEmbed({ currentUser, setCurrentUser, onNavigate, appUsers=[], saveAppUsers, bizId="" }) {
  const [subScreen,  setSubScreen]  = useState("home");
  const [tasks,      setTasks]      = useState([]);
  const [logs,       setLogs]       = useState([]);
  const [activeLog,  setActiveLog]  = useState(null);
  const [ownerPin,   setOwnerPin]   = useState("0000");
  const [ownerTab,   setOwnerTab]   = useState("tasks");
  const [ownerPinIn, setOwnerPinIn] = useState("");
  const [ownerErr,   setOwnerErr]   = useState(false);
  const [incText,    setIncText]    = useState("");
  const [smLoaded,   setSmLoaded]   = useState(false);

  const appUsersRef = appUsers;
  const saveAppUsersRef = saveAppUsers || (()=>{});

  useEffect(()=>{
    const initSM = async () => {
      try {
        const sg2 = async k => { try{return await window.storage.get(k);}catch(_){return null;} };
        const r1=await sg2(`biz:${bizId}:tasks`);      if(r1) setTasks(JSON.parse(r1.value));
        const r2=await sg2(`biz:${bizId}:logs`);       if(r2) setLogs(JSON.parse(r2.value));
        const r4=await sg2(`biz:${bizId}:pin`);        if(r4) setOwnerPin(r4.value);
        const r5=await sg2(`biz:${bizId}:active-log`); if(r5) setActiveLog(JSON.parse(r5.value));
      } catch(_){}
      setSmLoaded(true);
    };
    if(window._firebaseReady) { initSM(); }
    else { window.addEventListener("firebase-ready", initSM, {once:true}); }
  },[]);

  const saveTasks  = async t => { setTasks(t);    try{await window.storage.set(`biz:${bizId}:tasks`,JSON.stringify(t), true);}catch(_){} };
  const saveLogs   = async l => { setLogs(l);     try{await window.storage.set(`biz:${bizId}:logs`,JSON.stringify(l), true);}catch(_){} };
  const saveActive = async l => { setActiveLog(l);try{await window.storage.set(`biz:${bizId}:active-log`,JSON.stringify(l), true);}catch(_){} };

  const openShift = async (shiftType) => {
    const log = { id:Date.now(), date:TODAY_STR, shiftType, managerName:"", completedTasks:[], incidents:[], proofs:{},
      openedAt:new Date().toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"}), closedAt:null };
    await saveActive(log);
    setSubScreen("shift");
  };

  const closeShift = async () => {
    if(!activeLog) return;
    const closed = {...activeLog, closedAt:new Date().toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})};
    await saveLogs([closed,...logs]);
    await saveActive(null);
    setSubScreen("home");
  };

  const tryOwnerLogin = () => {
    if(ownerPinIn===ownerPin){ setOwnerErr(false); setOwnerPinIn(""); setSubScreen("owner"); }
    else { setOwnerErr(true); setOwnerPinIn(""); }
  };

  const toggleTask = async (task) => {
    if(!activeLog) return;
    if(task.proof==="photo" && !activeLog.completedTasks.includes(task.id)) return;
    const proofs = {...(activeLog.proofs||{})};
    const done = activeLog.completedTasks.includes(task.id)
      ? (delete proofs[task.id], activeLog.completedTasks.filter(x=>x!==task.id))
      : [...activeLog.completedTasks, task.id];
    await saveActive({...activeLog, completedTasks:done, proofs});
  };

  const completeWithPhoto = async (taskId, base64) => {
    if(!activeLog) return;
    const done = activeLog.completedTasks.includes(taskId) ? activeLog.completedTasks : [...activeLog.completedTasks, taskId];
    const proofs = {...(activeLog.proofs||{}), [taskId]: base64};
    await saveActive({...activeLog, completedTasks:done, proofs});
  };

  const addInc = async () => {
    if(!incText.trim()||!activeLog) return;
    const inc = {text:incText.trim(), time:new Date().toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})};
    await saveActive({...activeLog, incidents:[...(activeLog.incidents||[]),inc]});
    setIncText("");
  };

  const shiftTasks = (log) => tasks.filter(t => t.shift==="×›×œ ×”××©××¨×•×ª" || t.shift===(log?.shiftType||""));

  const SS = {
    wrap:{padding:"18px 20px 100px"},
    bigBtn:{width:"100%",padding:"20px",background:"#2563EB",border:"none",borderRadius:16,color:"#0A0A0A",fontWeight:800,fontSize:18,cursor:"pointer",fontFamily:"inherit",display:"flex",alignItems:"center",justifyContent:"center",gap:10,marginBottom:12,letterSpacing:0.2},
    ghostBtn:{width:"100%",padding:"15px",background:"transparent",border:"1px solid #D1D5DB",borderRadius:16,color:"#6B7280",cursor:"pointer",fontFamily:"inherit",fontSize:15,fontWeight:600,marginBottom:10},
    center:{maxWidth:380,margin:"0 auto"},
    lbl:{fontSize:14,color:"#6B7280",marginBottom:6,display:"block",fontWeight:500},
    inp:{width:"100%",background:"#F8FAFC",border:"1px solid #D1D5DB",borderRadius:12,padding:"13px 14px",color:"#111827",fontSize:16,fontFamily:"inherit",outline:"none",boxSizing:"border-box",marginBottom:10},
    pinInp:{width:"100%",background:"#FFFFFF",border:"2px solid #D1D5DB",borderRadius:14,padding:"16px",color:"#111827",fontSize:28,fontFamily:"inherit",outline:"none",textAlign:"center",letterSpacing:14,boxSizing:"border-box",marginBottom:10},
    card:{background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:16,padding:"16px",marginBottom:12},
    taskRow:{display:"flex",alignItems:"flex-start",gap:13,padding:"14px",background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:14,marginBottom:8},
    taskDone:{background:"#F0FDF4",borderColor:"#BBF7D0"},
    cb:{width:26,height:26,borderRadius:8,border:"2px solid #D1D5DB",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:1,fontSize:14},
    cbDone:{background:"#22C55E",border:"2px solid #22C55E",color:"#0A0A0A"},
    saveBtn2:{width:"100%",padding:"16px",background:"#2563EB",border:"none",borderRadius:14,color:"#0A0A0A",fontWeight:800,fontSize:16,cursor:"pointer",fontFamily:"inherit",letterSpacing:0.2},
    oNavBtn:{padding:"9px 13px",background:"transparent",border:"none",color:"#9CA3AF",cursor:"pointer",fontSize:13,fontWeight:600,borderRadius:"10px 10px 0 0",fontFamily:"inherit",borderBottom:"2px solid transparent",whiteSpace:"nowrap"},
    oNavA:{color:"#111827",background:"#FFFFFF",borderBottom:"2px solid #F59E0B"},
    iconBtn2:{background:"#F8FAFC",border:"1px solid #D1D5DB",borderRadius:10,padding:"8px 11px",cursor:"pointer",fontSize:14},
    logoutBtn:{padding:"9px 16px",background:"#F8FAFC",border:"1px solid #D1D5DB",borderRadius:10,color:"#6B7280",cursor:"pointer",fontFamily:"inherit",fontSize:13,fontWeight:600},
  };

  if(!smLoaded) return <div style={{...SS.wrap,textAlign:"center",color:"#9CA3AF",paddingTop:40}}>×˜×•×¢×Ÿ...</div>;

  // â”€â”€ HOME â€” ×¢×•×‘×¨ ×™×©×™×¨×•×ª ×œ×¦'×§×œ×™×¡×˜ â”€â”€
  if(subScreen==="home") {
    if(!activeLog) { openShift("×™×•×"); return null; }
    setTimeout(()=>setSubScreen("shift"),0);
    return null;
  }

  // â”€â”€ OWNER LOGIN â”€â”€
  if(subScreen==="ownerLogin") return (
    <div style={SS.wrap}>
      <div style={SS.center}>
        <button style={{...SS.logoutBtn,marginBottom:20}} onClick={()=>setSubScreen("home")}>â† ×—×–×¨×”</button>
        <h3 style={{margin:"0 0 20px",color:"#111827",fontWeight:800,fontSize:18}}>×›× ×™×¡×ª ×‘×¢×œ×™×</h3>
        <label style={SS.lbl}>×§×•×“ ×’×™×©×”</label>
        <input style={SS.pinInp} type="password" inputMode="numeric" maxLength={6} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"
          value={ownerPinIn} onChange={e=>setOwnerPinIn(e.target.value)}
          onKeyDown={e=>e.key==="Enter"&&tryOwnerLogin()}/>
        {ownerErr && <p style={{color:"#EF4444",fontSize:13,margin:"0 0 10px",textAlign:"center"}}>×§×•×“ ×©×’×•×™</p>}
        <button style={SS.saveBtn2} onClick={tryOwnerLogin}>×›× ×™×¡×”</button>
        <p style={{color:"#2A2A2A",fontSize:11,textAlign:"center",marginTop:10}}>×‘×¨×™×¨×ª ××—×“×œ: 0000</p>
      </div>
    </div>
  );

  // â”€â”€ ACTIVE SHIFT â”€â”€
  if(subScreen==="shift") {
    const log = activeLog;
    if(!log) { setSubScreen("home"); return null; }
    const myTasks = shiftTasks(log);
    const done    = myTasks.filter(t=>log.completedTasks.includes(t.id)).length;
    const pct     = myTasks.length>0 ? Math.round((done/myTasks.length)*100) : 0;
    return (
      <div style={SS.wrap}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
          <div>
            <div style={{fontSize:13,color:"#22C55E",fontWeight:700,marginBottom:2}}>{log.shiftType} Â· × ×¤×ª×—×” {log.openedAt}</div>
            <div style={{fontSize:11,color:"#9CA3AF"}}>{done}/{myTasks.length} ××©×™××•×ª</div>
          </div>
          <div style={{fontSize:32,fontWeight:900,color:pct===100?"#22C55E":"#374151",lineHeight:1}}>{pct}%</div>
        </div>
        <div style={{height:6,background:"#F1F5F9",borderRadius:4,marginBottom:18,overflow:"hidden"}}>
          <div style={{height:"100%",width:`${pct}%`,background:pct===100?"#22C55E":pct>60?"#F59E0B":"#EF4444",borderRadius:4,transition:"width 0.5s"}}/>
        </div>
        {SM_CATS.map(cat=>{
          const ct = myTasks.filter(t=>t.category===cat);
          if(!ct.length) return null;
          const catDone = ct.filter(t=>log.completedTasks.includes(t.id)).length;
          return (
            <div key={cat} style={{marginBottom:18}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                <span style={{fontSize:12,fontWeight:700,padding:"4px 12px",borderRadius:20,color:SM_CAT_COLOR[cat],background:SM_CAT_BG[cat]}}>{cat}</span>
                <span style={{color:"#9CA3AF",fontSize:12}}>{catDone}/{ct.length}</span>
              </div>
              {ct.map(task=>{
                const isDone     = log.completedTasks.includes(task.id);
                const isPhoto    = task.proof==="photo";
                const photoProof = (log.proofs||{})[task.id];
                return (
                  <div key={task.id} style={{...SS.taskRow,...(isDone?SS.taskDone:{}),flexDirection:"column",cursor:"default"}}>
                    <div style={{display:"flex",alignItems:"flex-start",gap:11,width:"100%"}}>
                      <div style={{...SS.cb,...(isDone?SS.cbDone:{})}}
                        onClick={()=>{ if(isDone) toggleTask(task); else if(!isPhoto) toggleTask(task); }}>
                        {isDone?"âœ“":isPhoto?"ğŸ“¸":""}
                      </div>
                      <div style={{flex:1}}>
                        <div style={{fontSize:15,color:isDone?"#9CA3AF":"#111827",textDecoration:isDone?"none":"none",fontWeight:600}}>{task.title}</div>
                        {task.note&&<div style={{fontSize:12,color:"#9CA3AF",marginTop:3}}>{task.note}</div>}
                      </div>
                      {isPhoto&&!isDone&&(
                        <label style={{flexShrink:0,padding:"8px 14px",background:"#F1F5F9",border:"1px solid #D1D5DB",borderRadius:10,color:"#6B7280",fontSize:13,cursor:"pointer",fontFamily:"inherit",fontWeight:600}}>
                          ğŸ“¸ ×¦×œ×
                          <input type="file" accept="image/*" capture="camera" style={{display:"none"}}
                            onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>completeWithPhoto(task.id,ev.target.result);r.readAsDataURL(f);e.target.value="";}}/>
                        </label>
                      )}
                      {isPhoto&&isDone&&(
                        <button style={{flexShrink:0,padding:"4px 8px",background:"transparent",border:"none",color:"#9CA3AF",fontSize:12,cursor:"pointer"}}
                          onClick={()=>toggleTask(task)}>âœ•</button>
                      )}
                    </div>
                    {photoProof&&(
                      <div style={{marginTop:8,width:"100%"}}>
                        <img src={photoProof} alt="×”×•×›×—×”" style={{width:"100%",maxHeight:180,objectFit:"cover",borderRadius:10,border:"1px solid #D1D5DB"}} onClick={()=>window.open(photoProof,"_blank")}/>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          );
        })}
        {myTasks.length===0&&<div style={{textAlign:"center",padding:"32px 0",color:"#9CA3AF",fontSize:14}}>××™×Ÿ ××©×™××•×ª ××•×’×“×¨×•×ª ×¢×“×™×™×Ÿ</div>}
        <div style={SS.card}>
          <div style={{fontSize:11,fontWeight:700,color:"#9CA3AF",marginBottom:10,textTransform:"uppercase",letterSpacing:1}}>ğŸ“‹ ××™×¨×•×¢×™×</div>
          {(log.incidents||[]).map((inc,i)=>(
            <div key={i} style={{padding:"8px 10px",background:"#F8FAFC",borderRadius:10,marginBottom:6}}>
              <div style={{fontSize:13,color:"#374151"}}>{inc.text}</div>
              <div style={{fontSize:11,color:"#9CA3AF",marginTop:2}}>{inc.time}</div>
            </div>
          ))}
          <div style={{display:"flex",gap:8,marginTop:8}}>
            <input style={{...SS.inp,flex:1,marginBottom:0}} placeholder="×ª××¨ ××™×¨×•×¢..." value={incText} onChange={e=>setIncText(e.target.value)} onKeyDown={e=>e.key==="Enter"&&addInc()}/>
            <button style={{...SS.iconBtn2,padding:"10px 14px"}} onClick={addInc}>×”×•×¡×£</button>
          </div>
        </div>
        {pct===100
          ? <button style={SS.saveBtn2} onClick={closeShift}>âœ… ×¡×’×•×¨ ××©××¨×ª</button>
          : <button style={{...SS.saveBtn2,background:"#F1F5F9",color:"#6B7280"}} onClick={closeShift}>×¡×’×•×¨ ××©××¨×ª ({myTasks.length-done} ×¤×ª×•×—×•×ª)</button>
        }
      </div>
    );
  }
  // â”€â”€ OWNER PANEL â”€â”€
  if(subScreen==="owner") return (
    <div style={SS.wrap}>
      <nav style={{display:"flex",gap:2,borderBottom:"1px solid #E5E7EB",marginBottom:12}}>
        {[["tasks","âœ… ××©×™××•×ª"],["logs","ğŸ“‹ ×™×•××Ÿ"],["users","ğŸ‘¥ ××©×ª××©×™×"]].map(([t,l])=>(
          <button key={t} style={{...SS.oNavBtn,...(ownerTab===t?SS.oNavA:{})}} onClick={()=>setOwnerTab(t)}>{l}</button>
        ))}
        <div style={{flex:1}}/>
        <button style={{...SS.logoutBtn,margin:"2px 0"}} onClick={()=>setSubScreen("home")}>â† ×™×¦×™××”</button>
      </nav>

      {ownerTab==="tasks"    && <SMTasksPanel tasks={tasks} saveTasks={saveTasks} SS={SS}/>}
      {ownerTab==="users"    && <div style={{padding:"0 4px"}}><UserManagement users={appUsersRef} saveUsers={saveAppUsersRef}/></div>}
      {ownerTab==="logs" && (
        <div>
          <div style={{fontSize:11,fontWeight:700,color:"#6B7280",textTransform:"uppercase",letterSpacing:1,marginBottom:12}}>×™×•××Ÿ ××©××¨×•×ª</div>
          {logs.length===0 && <p style={{color:"#9CA3AF",textAlign:"center",paddingTop:24}}>××™×Ÿ ××©××¨×•×ª ×¢×“×™×™×Ÿ</p>}
          {logs.map((log,i)=>{
            const lt=tasks.filter(t=>t.shift==="×›×œ ×”××©××¨×•×ª"||t.shift===log.shiftType);
            const dp=lt.length>0?Math.round(((log.completedTasks?.length||0)/lt.length)*100):0;
            return (
              <div key={i} style={SS.card}>
                <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}>
                  <div><div style={{fontWeight:700,color:"#111827"}}>{log.managerName}</div><div style={{fontSize:11,color:"#9CA3AF"}}>{log.date} Â· {log.shiftType}</div></div>
                  <div style={{textAlign:"left"}}><div style={{fontWeight:800,color:dp===100?"#22C55E":"#F59E0B",fontSize:18}}>{dp}%</div><div style={{fontSize:10,color:"#9CA3AF"}}>{log.completedTasks?.length||0}/{lt.length}</div></div>
                </div>
                <div style={{fontSize:11,color:"#9CA3AF"}}>{log.openedAt} {log.closedAt?`â€” ${log.closedAt}`:"(×¤×ª×•×—)"}</div>
                {log.incidents?.length>0&&<div style={{marginTop:8,padding:"7px 10px",background:"#F8FAFC",borderRadius:8}}>
                  {log.incidents.map((inc,j)=><div key={j} style={{fontSize:11,color:"#374151"}}>{inc.time} â€” {inc.text}</div>)}
                </div>}
                {/* Photo proofs */}
                {log.proofs && Object.keys(log.proofs).length>0 && (
                  <div style={{marginTop:8}}>
                    <div style={{fontSize:10,color:"#9CA3AF",marginBottom:5}}>ğŸ“¸ ×ª××•× ×•×ª ×”×•×›×—×” ({Object.keys(log.proofs).length})</div>
                    <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                      {Object.entries(log.proofs).map(([tid, src])=>{
                        const t = tasks.find(x=>String(x.id)===String(tid));
                        return (
                          <div key={tid} style={{position:"relative"}}>
                            <img src={src} alt={t?.title||""}
                              style={{width:70,height:70,objectFit:"cover",borderRadius:8,border:"1px solid #15803D44",cursor:"pointer"}}
                              onClick={()=>window.open(src,"_blank")}/>
                            <div style={{fontSize:9,color:"#9CA3AF",textAlign:"center",marginTop:2,maxWidth:70,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{t?.title||tid}</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );

  return null;
}

function SMTasksPanel({tasks,saveTasks,SS}) {
  const [form,setForm]=useState({title:"",category:"×¤×ª×™×—×”",shift:"×›×œ ×”××©××¨×•×ª",note:""});
  const [adding,setAdding]=useState(false);
  const add=()=>{ if(!form.title.trim()) return; saveTasks([...tasks,{...form,id:Date.now()}]); setForm({title:"",category:"×¤×ª×™×—×”",shift:"×›×œ ×”××©××¨×•×ª",note:""}); setAdding(false); };
  return (
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
        <div style={{fontSize:11,fontWeight:700,color:"#6B7280",textTransform:"uppercase",letterSpacing:1}}>××©×™××•×ª ({tasks.length})</div>
        <button style={{...SS.iconBtn2,padding:"5px 12px",fontSize:12}} onClick={()=>setAdding(a=>!a)}>{adding?"×‘×™×˜×•×œ":"+ ×—×“×©×”"}</button>
      </div>
      {adding&&(
        <div style={SS.card}>
          <label style={SS.lbl}>×©× ××©×™××”</label>
          <input style={SS.inp} placeholder="×œ××©×œ: × ×™×§×•×™ ××“×—×¡×™×" value={form.title} onChange={e=>setForm(f=>({...f,title:e.target.value}))} autoFocus/>
          <div style={{display:"flex",gap:8,marginBottom:8}}>
            <div style={{flex:1}}><label style={SS.lbl}>×§×˜×’×•×¨×™×”</label><select style={{...SS.inp,marginBottom:0}} value={form.category} onChange={e=>setForm(f=>({...f,category:e.target.value}))}>{SM_CATS.map(c=><option key={c}>{c}</option>)}</select></div>
            <div style={{flex:1}}><label style={SS.lbl}>××©××¨×ª</label><select style={{...SS.inp,marginBottom:0}} value={form.shift} onChange={e=>setForm(f=>({...f,shift:e.target.value}))}>{["×›×œ ×”××©××¨×•×ª","×‘×•×§×¨","×¢×¨×‘"].map(s=><option key={s}>{s}</option>)}</select></div>
          </div>
          <label style={SS.lbl}>×”×¢×¨×”</label>
          <input style={SS.inp} placeholder="×”×•×¨××•×ª × ×•×¡×¤×•×ª..." value={form.note} onChange={e=>setForm(f=>({...f,note:e.target.value}))}/>
          <button style={SS.saveBtn2} onClick={add}>×”×•×¡×£</button>
        </div>
      )}
      {SM_CATS.map(cat=>{
        const ct=tasks.filter(t=>t.category===cat);
        if(!ct.length) return null;
        return (
          <div key={cat} style={{marginBottom:12}}>
            <span style={{fontSize:11,fontWeight:700,padding:"2px 10px",borderRadius:16,color:SM_CAT_COLOR[cat],background:SM_CAT_BG[cat],display:"inline-block",marginBottom:7}}>{cat}</span>
            {ct.map(t=>(
              <div key={t.id} style={{display:"flex",alignItems:"center",gap:10,padding:"9px 12px",background:"#FFFFFF",border:"1px solid #0A0A0A",borderRadius:9,marginBottom:6}}>
                <div style={{flex:1}}>
                  <div style={{fontSize:13,color:"#111827"}}>{t.title}</div>
                  <div style={{fontSize:11,color:"#9CA3AF"}}>{t.shift}{t.note&&` Â· ${t.note}`}</div>
                </div>
                <button style={SS.iconBtn2} onClick={()=>saveTasks(tasks.filter(x=>x.id!==t.id))}>ğŸ—‘</button>
              </div>
            ))}
          </div>
        );
      })}
      {tasks.length===0&&<p style={{color:"#9CA3AF",textAlign:"center",paddingTop:24,fontSize:13}}>××™×Ÿ ××©×™××•×ª â€” ×”×•×¡×£ ××ª ×”×¨××©×•× ×”</p>}
    </div>
  );
}

// â”€â”€â”€ Forecast Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ Month name â†’ index map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MONTH_IDX = {
  "×™× ×•××¨":0,"×¤×‘×¨×•××¨":1,"××¨×¥":2,"××¤×¨×™×œ":3,"×××™":4,"×™×•× ×™":5,
  "×™×•×œ×™":6,"××•×’×•×¡×˜":7,"×¡×¤×˜××‘×¨":8,"××•×§×˜×•×‘×¨":9,"× ×•×‘××‘×¨":10,"×“×¦××‘×¨":11,
  "jan":0,"feb":1,"mar":2,"apr":3,"may":4,"jun":5,
  "jul":6,"aug":7,"sep":8,"oct":9,"nov":10,"dec":11,
  "1":0,"2":1,"3":2,"4":3,"5":4,"6":5,"7":6,"8":7,"9":8,"10":9,"11":10,"12":11,
};

function ForecastScreen({ metrics, lastYear, saveLastYear, currentMonth, entries=[], businessConfig={}, TARGETS_DEFAULT={salesGrowthPct:5,foodCostPct:33,laborCostPct:27} }) {
  const fileRef = useRef();
  const [mode, setMode] = useState("view"); // view | manual | mapCols
  const [lyDraft, setLyDraft] = useState(() => lastYear.map(m=>({...m})));
  const [headers, setHeaders] = useState([]);
  const [rawRows, setRawRows] = useState([]);
  const [colMap, setColMap] = useState({ month:"", sales:"", food:"", labor:"", gross:"", fixed:"" });
  const [uploadError, setUploadError] = useState("");

  const ly = lastYear[currentMonth];

  // â”€â”€ Forecast math â€” ×××•×¦×¢ 6 ××•×¤×¢×™× ××—×¨×•× ×™× ×œ×›×œ ×™×•× ×©×‘×•×¢ â”€â”€
  const rem  = DAYS_IN_MONTH - DAY_OF_MONTH;

  // For each remaining day of month, find last 6 entries with same DOW
  const getDowAvg = (entries, targetDow, field) => {
    const matches = [...entries]
      .filter(e => getDateDOW(e.date) === targetDow)
      .sort((a,b) => b.date.localeCompare(a.date))
      .slice(0, 6);
    if (!matches.length) return null;
    const sum = matches.reduce((a,e) => {
      if (field === 'sales')  return a + (Number(e.sales)||0)+(Number(e.deliveries)||0)+(Number(e.other_income)||0);
      if (field === 'food')   return a + (e.supplier_payments?Object.values(e.supplier_payments).filter(v=>v!=='skip').reduce((x,y)=>x+(Number(y)||0),0):0);
      if (field === 'labor')  return a + (Number(e.payroll)||0) + (e.hourly_payroll?Object.values(e.hourly_payroll).reduce((s,v)=>s+(Number(v)||0),0):0);
      return 0;
    }, 0);
    return sum / matches.length;
  };

  // Sum forecasted remaining days
  const { fSalesExtra, fFoodExtra, fLaborExtra, dowDetails } = (() => {
    let fSalesExtra = 0, fFoodExtra = 0, fLaborExtra = 0;
    const dowDetails = {}; // dow â†’ { avg, count, days }
    const fallbackDailySales  = metrics.totalSales   / Math.max(DAY_OF_MONTH,1);
    const fallbackDailyFood   = metrics.totalFood    / Math.max(DAY_OF_MONTH,1);
    const fallbackDailyLabor  = metrics.totalPayroll / Math.max(DAY_OF_MONTH,1);
    for(let d = DAY_OF_MONTH+1; d <= DAYS_IN_MONTH; d++) {
      const ds = `${YEAR}-${MONTH_STR}-${String(d).padStart(2,"0")}`;
      const dow = getDateDOW(ds);
      if(dow === 6) continue; // ×©×‘×ª
      const avgS = getDowAvg(entries, dow, 'sales')  ?? fallbackDailySales;
      const avgF = getDowAvg(entries, dow, 'food')   ?? fallbackDailyFood;
      const avgL = getDowAvg(entries, dow, 'labor')  ?? fallbackDailyLabor;
      fSalesExtra += avgS;
      fFoodExtra  += avgF;
      fLaborExtra += avgL;
      if(!dowDetails[dow]) {
        const cnt = [...entries].filter(e=>getDateDOW(e.date)===dow).length;
        dowDetails[dow] = { avg: Math.round(avgS), count: Math.min(cnt,6), days: [] };
      }
      dowDetails[dow].days.push(d);
    }
    return { fSalesExtra, fFoodExtra, fLaborExtra, dowDetails };
  })();

  const fSales = metrics.totalSales   + fSalesExtra;
  const fFood  = metrics.totalFood    + fFoodExtra;
  const fLabor = metrics.totalPayroll + fLaborExtra;

  const fFoodPct  = fSales > 0 ? (fFood  / fSales) * 100 : 0;
  const fLaborPct = fSales > 0 ? (fLabor / fSales) * 100 : 0;
  const fGross    = 100 - fFoodPct - fLaborPct - (businessConfig.rentPct||0) - (businessConfig.hasRoyalty?(businessConfig.royaltyPct||0):0);

  const fcColor = (v,t) => v > t+3 ? "#EF4444" : v > t ? "#F59E0B" : "#22C55E";
  const dlt  = (cur,prv,inv) => { const d=cur-prv; const good=inv?d<0:d>0; return { str:`${d>=0?"+":""}${d.toFixed(1)}%`, good }; };
  const dltA = (cur,prv,inv) => { const d=cur-prv; const good=inv?d<0:d>0; return { str:`${d>=0?"+":""}${fmt(Math.round(d))}`, good }; };

  // â”€â”€ Excel parse â”€â”€
  const handleFile = (file) => {
    setUploadError("");
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const wb   = XLSX.read(new Uint8Array(ev.target.result), { type:"array" });
        const ws   = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:"" });
        if (rows.length < 2) { setUploadError("×”×§×•×‘×¥ ×¨×™×§"); return; }
        const hdrs = rows[0].map(h => String(h).trim());
        setHeaders(hdrs);
        setRawRows(rows.slice(1).filter(r => r.some(c => c !== "")));
        // auto-detect columns
        const cm = { month:"", sales:"", food:"", labor:"", gross:"", fixed:"" };
        hdrs.forEach(h => {
          const l = h.toLowerCase();
          if (!cm.month  && (l.includes("×—×•×“")  || l.includes("month")))            cm.month  = h;
          if (!cm.sales  && (l.includes("××›×™×¨") || l.includes("×”×›× ×¡×•×ª") || l.includes("sales"))) cm.sales = h;
          if (!cm.food   && (l.includes("×¤×•×“")  || l.includes("food")   || l.includes("×¡×—×•×¨×”"))) cm.food  = h;
          if (!cm.labor  && (l.includes("×©×›×¨")  || l.includes("labor")  || l.includes("×¢×•×‘×“")))  cm.labor = h;
          if (!cm.gross  && (l.includes("×¨×•×•×—") || l.includes("gross")))             cm.gross  = h;
          if (!cm.fixed  && (l.includes("×§×‘×•×¢") || l.includes("fixed")))             cm.fixed  = h;
        });
        setColMap(cm);
        setMode("mapCols");
      } catch(e) { setUploadError("×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥"); }
    };
    reader.readAsArrayBuffer(file);
  };

  const confirmImport = () => {
    const hIdx = h => headers.indexOf(h);
    const num  = (row, col) => col ? Number(String(row[hIdx(col)]||"0").replace(/[%,â‚ª\s]/g,"")) || 0 : 0;
    const updated = lastYear.map(m=>({...m}));
    rawRows.forEach(row => {
      if (!colMap.month) return;
      const raw = String(row[hIdx(colMap.month)]||"").trim().toLowerCase().replace(/['\s]/g,"");
      const mi  = MONTH_IDX[raw] ?? MONTH_IDX[raw.slice(0,3)];
      if (mi === undefined) return;
      updated[mi] = { month:mi, sales:num(row,colMap.sales), foodCostPct:num(row,colMap.food), laborCostPct:num(row,colMap.labor), grossProfitPct:num(row,colMap.gross), fixedExpenses:num(row,colMap.fixed) };
    });
    saveLastYear(updated);
    setLyDraft(updated);
    setMode("view");
  };

  return (
    <div>

      {/* â”€â”€ Forecast card â”€â”€ */}
      {(()=>{
        const tSales  = Math.round((lastYear[currentMonth]?.sales||650000)*(1+(cfgTarget(businessConfig,"salesGrowthPct",TARGETS_DEFAULT.salesGrowthPct)/100)));
        const tNet    = fSales > 0 ? (fSales*(1-cfgTarget(businessConfig,"foodCostPct",TARGETS_DEFAULT.foodCostPct)/100-cfgTarget(businessConfig,"laborCostPct",TARGETS_DEFAULT.laborCostPct)/100-((businessConfig.rentPct||0)+(businessConfig.hasRoyalty?businessConfig.royaltyPct||0:0))/100)-metrics.TOTAL_FIXED) : 0;
        const tNetPct = fSales > 0 ? (tNet/fSales)*100 : 0;
        return (
          <div style={{...S.card, borderTop:"2px solid #A3A3A3", marginBottom:10}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:10}}>
              <div style={{fontSize:11,fontWeight:700,color:"#6B7280",textTransform:"uppercase",letterSpacing:1}}>
                ğŸ”® ×ª×—×–×™×ª ×¡×•×£ ×—×•×“×© â€” ×××•×¦×¢ 6 ×™××™× ×œ×¤×™ ×™×•× ×©×‘×•×¢
              </div>
              <div style={{fontSize:11,color:"#9CA3AF"}}>×™×•× {DAY_OF_MONTH}/{DAYS_IN_MONTH}</div>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:6}}>
              <MetricBox label="×”×›× ×¡×•×ª ×—×–×•×™×•×ª"
                value={fmt(Math.round(fSales))}
                color={fSales>=tSales?"#22C55E":"#F59E0B"}
                sub={`×™×¢×“: ${fmt(tSales)}`} />
              <MetricBox label="×¤×•×“ ×§×•×¡×˜"
                value={fmtPct(fFoodPct)}
                color={fcColor(fFoodPct, cfgTarget(businessConfig,"foodCostPct",TARGETS_DEFAULT.foodCostPct))}
                sub={`×™×¢×“ ${cfgTarget(businessConfig,"foodCostPct",TARGETS_DEFAULT.foodCostPct)}%`} />
              <MetricBox label="×œ×™×™×‘×•×¨ ×§×•×¡×˜"
                value={fmtPct(fLaborPct)}
                color={fcColor(fLaborPct, cfgTarget(businessConfig,"laborCostPct",TARGETS_DEFAULT.laborCostPct))}
                sub={`×™×¢×“ ${cfgTarget(businessConfig,"laborCostPct",TARGETS_DEFAULT.laborCostPct)}%`} />
              <MetricBox label="×¨×•×•×— × ×§×™ ×—×–×•×™"
                value={fmt(Math.round(tNet))}
                color={tNet>0?"#22C55E":"#EF4444"}
                sub={`${fmtPct(tNetPct)} ××”××—×–×•×¨`} />
            </div>
            {Object.keys(dowDetails).length > 0 && (
              <div style={{marginTop:14,borderTop:"1px solid #E5E7EB",paddingTop:12}}>
                <div style={{fontSize:11,fontWeight:700,color:"#9CA3AF",textTransform:"uppercase",letterSpacing:1.2,marginBottom:10}}>
                  ×××•×¦×¢ ×œ×¤×™ ×™×•× ×©×‘×•×¢ ({rem} ×™××™× × ×•×ª×¨×•)
                </div>
                <div style={{display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:6}}>
                  {Object.entries(dowDetails).sort((a,b)=>a[0]-b[0]).map(([dow,info])=>(
                    <div key={dow} style={{background:"#F8FAFC",borderRadius:10,padding:"8px 12px"}}>
                      <div style={{fontSize:11,color:"#6B7280",fontWeight:600,marginBottom:3}}>
                        {["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™"][dow]} ({info.count} × ×ª×•× ×™×)
                      </div>
                      <div style={{fontWeight:800,color:"#111827",fontSize:14}}>{fmt(info.avg)}</div>
                      <div style={{fontSize:10,color:"#9CA3AF",marginTop:2}}>×™××™×: {info.days.join(", ")}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      })()}

      {/* â”€â”€ Progress bars â”€â”€ */}
      <div style={S.card}>
        <div style={{fontSize:11,fontWeight:700,color:"#6B7280",textTransform:"uppercase",letterSpacing:1,marginBottom:12}}>
          â± ×”×ª×§×“××•×ª ××•×œ ×ª×—×–×™×ª
        </div>
        <ProgressBar label="×”×›× ×¡×•×ª"   current={metrics.totalSales}   target={fSales} color="#22C55E" />
        <ProgressBar label="×¤×•×“ ×§×•×¡×˜" current={metrics.totalFood}    target={fFood}  color="#A3A3A3" />
        <ProgressBar label="×©×›×¨"      current={metrics.totalPayroll} target={fLabor} color="#A3A3A3" />
      </div>

      {/* â”€â”€ Last year comparison â”€â”€ */}
      <div style={S.card}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
          <div style={{fontSize:11,fontWeight:700,color:"#6B7280",textTransform:"uppercase",letterSpacing:1}}>
            ğŸ“… {MONTH_NAMES[currentMonth]} {YEAR-1} â€” ×”×©×•×•××”
          </div>
          <div style={{display:"flex",gap:6}}>
            <button style={{...S.iconBtn,color:"#6B7280",borderColor:"#40404033",padding:"4px 10px",fontSize:12}}
              onClick={()=>setMode(m=>m==="manual"?"view":"manual")}>âœï¸ ×™×“× ×™</button>
            <button style={{...S.iconBtn,color:"#22C55E",borderColor:"#15803D33",padding:"4px 10px",fontSize:12}}
              onClick={()=>fileRef.current?.click()}>
              â¬† Excel
            </button>
            <input ref={fileRef} type="file" accept=".xlsx,.xls,.csv" style={{display:"none"}}
              onChange={e=>{ if(e.target.files[0]){ handleFile(e.target.files[0]); e.target.value=""; }}}/>
          </div>
        </div>

        {/* Manual input */}
        {mode==="manual" && (
          <div>
            <p style={{color:"#9CA3AF",fontSize:12,margin:"0 0 10px"}}>×”×–×Ÿ × ×ª×•× ×™ {MONTH_NAMES[currentMonth]} {YEAR-1}:</p>
            {[["sales","×”×›× ×¡×•×ª (â‚ª)"],["foodCostPct","×¤×•×“ ×§×•×¡×˜ (%)"],["laborCostPct","×œ×™×™×‘×•×¨ ×§×•×¡×˜ (%)"],["grossProfitPct","×¨×•×•×— ×’×•×œ××™ (%)"],["fixedExpenses","×”×•×¦×³ ×§×‘×•×¢×•×ª (â‚ª)"]].map(([f,lbl])=>(
              <div key={f} style={{marginBottom:7}}>
                <label style={{...S.lbl,fontSize:12}}>{lbl}</label>
                <input style={{...S.inp,marginBottom:0}} type="number" inputMode="decimal" placeholder="0"
                  value={lyDraft[currentMonth][f]||""}
                  onChange={e=>setLyDraft(d=>d.map((m,i)=>i===currentMonth?{...m,[f]:Number(e.target.value)}:m))}/>
              </div>
            ))}
            <div style={{display:"flex",gap:8,marginTop:8}}>
              <button style={S.saveBtn} onClick={()=>{saveLastYear(lyDraft);setMode("view");}}>×©××•×¨</button>
              <button style={{...S.iconBtn,padding:"10px 16px"}} onClick={()=>setMode("view")}>×‘×™×˜×•×œ</button>
            </div>
          </div>
        )}

        {/* Column mapping */}
        {mode==="mapCols" && (
          <div>
            <p style={{color:"#6B7280",fontSize:13,margin:"0 0 10px"}}>× ××¦××• {rawRows.length} ×©×•×¨×•×ª â€” ×”×ª×× ×¢××•×“×•×ª:</p>
            {uploadError && <p style={{color:"#EF4444",fontSize:12}}>{uploadError}</p>}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:12}}>
              {[["month","×—×•×“×©"],["sales","×”×›× ×¡×•×ª (â‚ª)"],["food","×¤×•×“ ×§×•×¡×˜ (%)"],["labor","×œ×™×™×‘×•×¨ (%)"],["gross","×¨×•×•×— ×’×•×œ××™ (%)"],["fixed","×”×•×¦×³ ×§×‘×•×¢×•×ª (â‚ª)"]].map(([k,l])=>(
                <div key={k}>
                  <label style={{...S.lbl,fontSize:11}}>{l}</label>
                  <select style={{...S.inp,padding:"6px 8px",fontSize:12,marginBottom:0}}
                    value={colMap[k]} onChange={e=>setColMap(c=>({...c,[k]:e.target.value}))}>
                    <option value="">â€” ×œ× ×¨×œ×•×•× ×˜×™ â€”</option>
                    {headers.map(h=><option key={h} value={h}>{h}</option>)}
                  </select>
                </div>
              ))}
            </div>
            {/* Preview */}
            <div style={{overflowX:"auto",marginBottom:10,borderRadius:8,border:"1px solid #0A0A0A"}}>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:11}}>
                <thead>
                  <tr>{[colMap.month,colMap.sales,colMap.food,colMap.labor].filter(Boolean).map(h=>(
                    <th key={h} style={{padding:"6px 8px",color:"#6B7280",textAlign:"right",background:"#F8FAFC",borderBottom:"1px solid #E5E7EB"}}>{h}</th>
                  ))}</tr>
                </thead>
                <tbody>
                  {rawRows.slice(0,5).map((row,i)=>(
                    <tr key={i}>{[colMap.month,colMap.sales,colMap.food,colMap.labor].filter(Boolean).map(h=>(
                      <td key={h} style={{padding:"5px 8px",color:"#374151",borderBottom:"1px solid #E5E7EB"}}>{row[headers.indexOf(h)]}</td>
                    ))}</tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div style={{display:"flex",gap:8}}>
              <button style={S.saveBtn} onClick={confirmImport}>âœ… ×™×™×‘× × ×ª×•× ×™×</button>
              <button style={{...S.iconBtn,padding:"10px 16px"}} onClick={()=>setMode("view")}>×‘×™×˜×•×œ</button>
            </div>
          </div>
        )}

        {/* Comparison table */}
        {(mode==="view") && (
          ly.sales===0
            ? <div style={{textAlign:"center",padding:"16px 0",color:"#9CA3AF",fontSize:13}}>
                ×”×¢×œ×” ×§×•×‘×¥ Excel â¬† ××• ×”×–×Ÿ ×™×“× ×™×ª âœï¸ × ×ª×•× ×™ {MONTH_NAMES[currentMonth]} {YEAR-1}
              </div>
            : <>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:2,padding:"5px 0",borderBottom:"1px solid #D1D5DB",marginBottom:4}}>
                  <span style={{fontSize:10,color:"#9CA3AF"}}>××“×“</span>
                  <span style={{fontSize:10,color:"#9CA3AF",textAlign:"center"}}>{YEAR-1}</span>
                  <span style={{fontSize:10,color:"#9CA3AF",textAlign:"center"}}>×ª×—×–×™×ª {YEAR}</span>
                </div>
                <CompRow label="×”×›× ×¡×•×ª"        lyVal={fmt(ly.sales)}              fVal={fmt(Math.round(fSales))}   d={dltA(fSales,ly.sales,false)} />
                <CompRow label="×¤×•×“ ×§×•×¡×˜ %"    lyVal={`${ly.foodCostPct}%`}       fVal={fmtPct(fFoodPct)}          d={dlt(fFoodPct,ly.foodCostPct,true)} />
                <CompRow label="×œ×™×™×‘×•×¨ %"      lyVal={`${ly.laborCostPct}%`}      fVal={fmtPct(fLaborPct)}         d={dlt(fLaborPct,ly.laborCostPct,true)} />
                {ly.networkPct && (() => {
                  const netPct = (businessConfig.rentPct||0)+(businessConfig.hasRoyalty?(businessConfig.royaltyPct||0):0);
                  return <CompRow label="×¨×©×ª %"  lyVal={`${ly.networkPct}%`}  fVal={fmtPct(netPct)} d={dlt(netPct,ly.networkPct,true)} />;
                })()}
                <CompRow label="×”×•×¦×³ ×§×‘×•×¢×•×ª"  lyVal={fmt(ly.fixedExpenses)}       fVal={fmt(metrics.TOTAL_FIXED)}  d={dltA(metrics.TOTAL_FIXED,ly.fixedExpenses,true)} />
                <CompRow label="×¨×•×•×— × ×§×™ %"   lyVal={`${ly.grossProfitPct}%`}    fVal={fmtPct(fGross)}            d={dlt(fGross,ly.grossProfitPct,false)} />
              </>
        )}
      </div>

      {/* 12-month bar chart */}
      <div style={S.card}>
        <div style={{fontSize:11,fontWeight:700,color:"#6B7280",textTransform:"uppercase",letterSpacing:1,marginBottom:10}}>
          ğŸ“† ×”×›× ×¡×•×ª {YEAR-1} â€” ×›×œ ×”×—×•×“×©×™×
        </div>
        {lastYear.some(m=>m.sales>0) ? (
          <ResponsiveContainer width="100%" height={130}>
            <BarChart data={lastYear.map((m,i)=>({ n:MONTH_NAMES[i].slice(0,3), v:m.sales, cur:i===currentMonth }))}>
              <CartesianGrid strokeDasharray="3 3" stroke="#2A2A2A"/>
              <XAxis dataKey="n" stroke="#404040" tick={{fill:"#525252",fontSize:10}}/>
              <YAxis stroke="#404040" tick={{fill:"#525252",fontSize:10}} tickFormatter={v=>`${(v/1000).toFixed(0)}k`}/>
              <Tooltip contentStyle={TT} formatter={v=>[fmt(v),""]}/>
              <Bar dataKey="v" radius={[3,3,0,0]}
                fill="#A3A3A3"
                shape={(props)=>{
                  const {x,y,width,height,cur} = props;
                  return <rect x={x} y={y} width={width} height={height} rx={3} fill={props.cur?"#22C55E":"#A3A3A355"}/>;
                }}
              />
            </BarChart>
          </ResponsiveContainer>
        ) : (
          <div style={{textAlign:"center",padding:"16px 0",color:"#1C1C1C",fontSize:13}}>
            × ×ª×•× ×™× ×™×•×¤×™×¢×• ×›××Ÿ ×œ××—×¨ ×™×™×‘×•× ×§×•×‘×¥ ×©× ×” ×©×¢×‘×¨×”
          </div>
        )}
        {/* mini grid */}
        <div style={{display:"flex",gap:3,marginTop:8,flexWrap:"wrap"}}>
          {lastYear.map((m,i)=>{
            const profitColor = m.grossProfitPct > 5 ? "#22C55E" : m.grossProfitPct > 0 ? "#F59E0B" : "#EF4444";
            return (
              <div key={i} style={{flex:"0 0 calc(8.33% - 3px)",textAlign:"center",padding:"5px 2px",background:i===currentMonth?"#1C1C1C44":"#0A0A0A",borderRadius:6,border:i===currentMonth?"1px solid #73737355":"1px solid #0A0A0A"}}>
                <div style={{fontSize:9,color:i===currentMonth?"#D4D4D4":"#404040"}}>{MONTH_NAMES[i].slice(0,3)}</div>
                <div style={{fontSize:10,fontWeight:700,color:m.sales>0?"#F5F5F5":"#2A2A2A",marginTop:2}}>
                  {m.sales>0?`${Math.round(m.sales/1000)}k`:"â€”"}
                </div>
                {m.sales>0 && <div style={{fontSize:9,color:profitColor,marginTop:1}}>{m.grossProfitPct > 0 ? "+" : ""}{m.grossProfitPct}%</div>}
              </div>
            );
          })}
        </div>
      </div>

    </div>
  );
}

function MetricBox({ label, value, color, sub }) {
  return (
    <div style={{background:"#F8FAFC",borderRadius:16,padding:"16px",border:`1px solid ${color}25`,position:"relative",overflow:"hidden"}}>
      <div style={{position:"absolute",top:-10,left:-10,width:60,height:60,borderRadius:"50%",background:color,opacity:0.08,filter:"blur(16px)",pointerEvents:"none"}}/>
      <div style={{fontSize:12,color:"#3D5068",marginBottom:7,fontWeight:700,textTransform:"uppercase",letterSpacing:0.8}}>{label}</div>
      <div style={{fontSize:24,fontWeight:900,color,letterSpacing:-0.8,lineHeight:1}}>{value}</div>
      {sub && <div style={{fontSize:12,color:"#3D5068",marginTop:6,fontWeight:500}}>{sub}</div>}
    </div>
  );
}

function ProgressBar({ label, current, target, color }) {
  const pct    = target > 0 ? Math.min((current/target)*100, 100) : 0;
  const dayPct = Math.round((DAY_OF_MONTH/DAYS_IN_MONTH)*100);
  return (
    <div style={{marginBottom:16}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}>
        <span style={{fontSize:13,color:"#6B7280",fontWeight:600}}>{label}</span>
        <span style={{fontSize:13,color,fontWeight:700}}>{fmt(current)} / {fmt(Math.round(target))}</span>
      </div>
      <div style={{height:8,background:"#F8FAFC",borderRadius:5,position:"relative",overflow:"hidden"}}>
        <div style={{width:`${pct}%`,height:"100%",background:`linear-gradient(90deg,${color}88,${color})`,borderRadius:5,transition:"width 0.6s cubic-bezier(0.4,0,0.2,1)"}}/>
        <div style={{position:"absolute",top:0,bottom:0,left:`${Math.min(dayPct,99)}%`,width:2,background:"#73737340",borderRadius:1}}/>
      </div>
      <div style={{fontSize:11,color:"#3D5068",marginTop:4,fontWeight:500}}>{Math.round(pct)}% ××”×™×¢×“ Â· ×™×•× {DAY_OF_MONTH} = {dayPct}% ××”×—×•×“×©</div>
    </div>
  );
}

function CompRow({ label, lyVal, fVal, d }) {
  return (
    <div style={{display:"flex",alignItems:"center",gap:8,padding:"11px 0",borderBottom:"1px solid #E5E7EB"}}>
      <span style={{width:105,fontSize:13,color:"#6B7280",flexShrink:0,fontWeight:500}}>{label}</span>
      <span style={{flex:1,fontSize:14,color:"#3D5068",textAlign:"center"}}>{lyVal}</span>
      <span style={{fontSize:12,color:"#2A2A2A"}}>â†’</span>
      <span style={{flex:1,fontSize:14,fontWeight:700,color:"#111827",textAlign:"center"}}>{fVal}</span>
      {d && <span style={{fontSize:13,fontWeight:800,color:d.good?"#22C55E":"#EF4444",flexShrink:0,minWidth:58,textAlign:"left"}}>{d.str}</span>}
    </div>
  );
}


function KPI({ icon, label, value, color, sub }) {
  return (
    <div style={{...S.kpiCard, borderRight:`3px solid ${color}`}}>
      <div style={{position:"absolute",top:-10,left:-10,width:60,height:60,borderRadius:"50%",background:color,opacity:0.07,filter:"blur(16px)",pointerEvents:"none"}}/>
      <div style={{fontSize:22,marginBottom:8,lineHeight:1}}>{icon}</div>
      <div style={{fontSize:22,fontWeight:900,color,letterSpacing:-0.8,lineHeight:1,marginBottom:5}}>{value}</div>
      <div style={{color:"#6B7280",fontSize:13,fontWeight:600,marginBottom:sub?2:0}}>{label}</div>
      {sub && <div style={{color:"#3D5068",fontSize:12,fontWeight:500,marginTop:1}}>{sub}</div>}
    </div>
  );
}
function ExpRow({ label, value, total, color }) {
  const pct = total>0 ? Math.min((value/total)*100, 100) : 0;
  return (
    <div style={{marginBottom:12}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:5}}>
        <span style={{fontSize:12,color:"#6B7280",fontWeight:500}}>{label}</span>
        <span style={{fontSize:13,fontWeight:700,color}}>{fmt(value)}</span>
      </div>
      <div style={{height:6,background:"#F8FAFC",borderRadius:4,overflow:"hidden"}}>
        <div style={{width:`${pct}%`,height:"100%",background:`linear-gradient(90deg,${color}99,${color})`,borderRadius:4,transition:"width 0.5s cubic-bezier(0.4,0,0.2,1)"}}/>
      </div>
    </div>
  );
}

const TT={background:"#F1F5F9",border:"1px solid #D1D5DB",borderRadius:10,color:"#374151",fontSize:13,padding:"8px 12px"};
const S={
  // â”€â”€â”€ Layout â”€â”€â”€
  root:{minHeight:"100vh",background:"#F1F5F9",color:"#111827",fontFamily:"'Heebo','Rubik',sans-serif",position:"relative"},
  amb1:{display:"none"},
  amb2:{display:"none"},

  // â”€â”€â”€ Header â”€â”€â”€
  header:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",padding:"20px 20px 0",gap:12,background:"#FFFFFF"},
  badge:{display:"inline-flex",alignItems:"center",gap:5,background:"#EFF6FF",border:"1px solid #BFDBFE",color:"#2563EB",fontSize:11,padding:"4px 11px",borderRadius:20,marginBottom:8,fontWeight:700,letterSpacing:0.3},
  title:{margin:0,fontSize:28,fontWeight:900,letterSpacing:-1.2,color:"#111827",lineHeight:1.1},
  sub:{margin:"6px 0 0",color:"#9CA3AF",fontSize:13,fontWeight:500},
  addBtn:{background:"#2563EB",border:"none",color:"#0A0A0A",padding:"13px 20px",borderRadius:14,cursor:"pointer",fontFamily:"inherit",fontWeight:800,fontSize:15,display:"flex",alignItems:"center",gap:8,flexShrink:0,letterSpacing:0.2},
  shiftBtn:{background:"#FFFFFF",border:"1px solid #D1D5DB",color:"#6B7280",padding:"10px 18px",borderRadius:12,cursor:"pointer",fontFamily:"inherit",fontWeight:700,fontSize:13},

  // â”€â”€â”€ Nav â”€â”€â”€
  nav:{display:"flex",padding:"0 20px",gap:1,borderBottom:"1px solid #E5E7EB",background:"#FFFFFF",overflowX:"auto",overflowY:"hidden",WebkitOverflowScrolling:"touch",scrollbarWidth:"none",msOverflowStyle:"none"},
  navBtn:{padding:"10px 14px",background:"transparent",border:"none",color:"#9CA3AF",cursor:"pointer",fontSize:13,fontWeight:600,borderRadius:"10px 10px 0 0",fontFamily:"inherit",borderBottom:"2px solid transparent",whiteSpace:"nowrap",flexShrink:0},
  navActive:{color:"#2563EB",background:"#FFFFFF",borderBottom:"2px solid #2563EB"},
  navShift: {color:"#111827",background:"#FFFFFF",borderBottom:"2px solid #F5F5F5"},
  navTasks: {color:"#2563EB",background:"#FFFFFF",borderBottom:"2px solid #2563EB"},

  // â”€â”€â”€ Content â”€â”€â”€
  content:{padding:"18px 20px 100px",background:"#F1F5F9",minHeight:"100vh"},

  // â”€â”€â”€ Banners â”€â”€â”€
  banner:{borderRadius:12,padding:"13px 16px",fontSize:14,fontWeight:600,marginBottom:14},
  bannerOk:{background:"#22C55E0F",border:"1px solid #22C55E25",color:"#22C55E"},
  bannerWarn:{background:"#F59E0B0F",border:"1px solid #F59E0B25",color:"#F59E0B"},
  alertBox:{background:"#EF44440A",border:"1px solid #EF444425",borderRadius:12,padding:"14px 16px",marginBottom:14},
  alertTitle:{color:"#EF4444",fontWeight:700,fontSize:14,marginBottom:6},
  atag:{background:"#EF44441A",border:"1px solid #EF444430",color:"#EF4444",padding:"5px 12px",borderRadius:20,fontSize:13,fontWeight:600},

  // â”€â”€â”€ KPI Grid â”€â”€â”€
  kpiGrid:{display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:10,marginBottom:16},
  kpiCard:{background:"#FFFFFF",borderRadius:16,padding:"16px",border:"1px solid #E5E7EB",position:"relative",overflow:"hidden",boxShadow:"0 1px 4px #0000000D"},

  // â”€â”€â”€ Cards â”€â”€â”€
  card:{background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:16,padding:"18px",marginBottom:12,boxShadow:"0 1px 3px #0000000A"},
  ct:{margin:"0 0 14px",fontSize:11,fontWeight:700,color:"#9CA3AF",textTransform:"uppercase",letterSpacing:1.4},
  catTag:{fontSize:11,color:"#9CA3AF",background:"#F8FAFC",padding:"2px 8px",borderRadius:8,fontWeight:600},

  // â”€â”€â”€ Gauge â”€â”€â”€
  gaugeTrack:{height:8,background:"#F1F5F9",borderRadius:5,overflow:"hidden",position:"relative"},
  gaugeFill:{height:"100%",borderRadius:5,transition:"width 0.7s cubic-bezier(0.4,0,0.2,1)"},
  gaugeMarker:{position:"absolute",top:0,bottom:0,width:2,background:"#525252",opacity:0.4},

  // â”€â”€â”€ Sub-tabs â”€â”€â”€
  subBtn:{padding:"8px 16px",background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:22,color:"#9CA3AF",cursor:"pointer",fontSize:13,fontFamily:"inherit",fontWeight:600},
  subBtnActive:{color:"#111827",background:"#F1F5F9",border:"1px solid #D1D5DB"},
  badge2:{position:"absolute",top:-6,left:-6,background:"#EF4444",color:"#fff",fontSize:10,fontWeight:800,borderRadius:"50%",width:18,height:18,display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 0 0 2px #0A0A0A"},

  // â”€â”€â”€ Form â”€â”€â”€
  formCard:{background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:18,padding:"22px",boxShadow:"0 1px 4px #0000000D"},
  formTitle:{margin:"0 0 20px",fontSize:20,fontWeight:800,color:"#111827"},
  sec:{fontSize:11,fontWeight:700,color:"#9CA3AF",textTransform:"uppercase",letterSpacing:1.8,margin:"18px 0 12px",paddingBottom:8,borderBottom:"1px solid #E5E7EB"},
  lbl:{fontSize:14,color:"#6B7280",marginBottom:6,display:"block",fontWeight:500},
  inp:{width:"100%",background:"#F8FAFC",border:"1px solid #D1D5DB",borderRadius:12,padding:"14px",color:"#111827",fontSize:16,fontFamily:"inherit",outline:"none",boxSizing:"border-box",marginBottom:10},
  preview:{background:"#F9FAFB",border:"1px solid #E5E7EB",borderRadius:12,padding:"15px",margin:"4px 0 12px"},
  pr:{display:"flex",justifyContent:"space-between",fontSize:14,marginBottom:6,fontWeight:500},
  saveBtn:{flex:1,padding:"16px",background:"#2563EB",border:"none",borderRadius:12,color:"#0A0A0A",fontWeight:800,fontSize:16,cursor:"pointer",fontFamily:"inherit",letterSpacing:0.3},
  cancelBtn:{padding:"16px 20px",background:"#F8FAFC",border:"1px solid #D1D5DB",borderRadius:12,color:"#6B7280",cursor:"pointer",fontFamily:"inherit",fontSize:15,fontWeight:600},
  uploadZone:{border:"2px dashed #2A2A2A",borderRadius:14,padding:"36px 20px",textAlign:"center",cursor:"pointer",marginBottom:16,background:"#F8FAFC"},

  // â”€â”€â”€ History â”€â”€â”€
  histRow:{background:"#FFFFFF",border:"1px solid #E5E7EB",borderRadius:14,padding:"16px",marginBottom:10,display:"flex",gap:12},
  iconBtn:{background:"#F8FAFC",border:"1px solid #D1D5DB",borderRadius:10,padding:"9px 12px",cursor:"pointer",fontSize:14},

  // â”€â”€â”€ Empty â”€â”€â”€
  empty:{textAlign:"center",padding:"64px 20px",color:"#9CA3AF"},
};


ReactDOM.createRoot(document.getElementById("root")).render(<PilotDashboard />);
  </script>
</body>
</html>